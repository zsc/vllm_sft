<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬ 3 ç« ï¼šSFT è®­ç»ƒç­–ç•¥</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">è§†è§‰è¯­è¨€æ¨¡å‹ï¼ˆVLMï¼‰çš„ç›‘ç£å¾®è°ƒä¸å¼ºåŒ–å­¦ä¹ å®æˆ˜æ•™ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 1 ç« ï¼šVLM æ¶æ„ä¸åŸç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 2 ç« ï¼šæ•°æ®å‡†å¤‡ä¸é¢„å¤„ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 3 ç« ï¼šSFT è®­ç»ƒç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 4 ç« ï¼šåˆ†å¸ƒå¼è®­ç»ƒä¸ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 5 ç« ï¼šRLHF åŸºç¡€ä¸å®ç°</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 6 ç« ï¼šç›´æ¥åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 7 ç« ï¼šè¯„ä¼°ä½“ç³»è®¾è®¡</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 8 ç« ï¼šæ¨¡å‹éƒ¨ç½²ä¸æœåŠ¡åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 9 ç« ï¼šCUDA OOM è°ƒè¯•å®Œå…¨æŒ‡å—</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 10 ç« ï¼šè®­ç»ƒå´©æºƒä¸ NaN é—®é¢˜</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 11 ç« ï¼šè®­ç»ƒé€Ÿåº¦ä¼˜åŒ–å®æˆ˜</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 12 ç« ï¼šå¤šæœºå¤šå¡è°ƒè¯•åœ°ç‹±</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="3-sft">ç¬¬ 3 ç« ï¼šSFT è®­ç»ƒç­–ç•¥</h1>
<p>ç›‘ç£å¾®è°ƒï¼ˆSupervised Fine-Tuning, SFTï¼‰æ˜¯å°†é¢„è®­ç»ƒçš„è§†è§‰è¯­è¨€æ¨¡å‹é€‚é…åˆ°ç‰¹å®šä»»åŠ¡çš„å…³é”®æ­¥éª¤ã€‚ä¸çº¯è¯­è¨€æ¨¡å‹ä¸åŒï¼ŒVLM çš„ SFT éœ€è¦åŒæ—¶è€ƒè™‘è§†è§‰å’Œè¯­è¨€ä¸¤ç§æ¨¡æ€çš„å¯¹é½ï¼Œè¿™å¸¦æ¥äº†ç‹¬ç‰¹çš„æŒ‘æˆ˜ï¼šå¦‚ä½•è®¾è®¡æœ‰æ•ˆçš„æŒ‡ä»¤æ ¼å¼ï¼Ÿå¦‚ä½•å¹³è¡¡ä¸åŒä»»åŠ¡çš„æŸå¤±ï¼Ÿå¦‚ä½•åœ¨æœ‰é™çš„è®¡ç®—èµ„æºä¸‹é«˜æ•ˆå¾®è°ƒï¼Ÿæœ¬ç« å°†ç³»ç»Ÿä»‹ç» VLM SFT çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œä»æŒ‡ä»¤è®¾è®¡åˆ°è®­ç»ƒä¼˜åŒ–ï¼Œå¸®åŠ©æ‚¨æŒæ¡å°†é€šç”¨ VLM è½¬åŒ–ä¸ºä»»åŠ¡ä¸“å®¶çš„å®Œæ•´æµç¨‹ã€‚</p>
<h2 id="31">3.1 æŒ‡ä»¤å¾®è°ƒçš„è®¾è®¡åŸåˆ™</h2>
<p>æŒ‡ä»¤å¾®è°ƒçš„æ ¸å¿ƒåœ¨äºæ•™ä¼šæ¨¡å‹ç†è§£å’Œéµå¾ªäººç±»æŒ‡ä»¤ã€‚å¯¹äº VLMï¼Œè¿™æ„å‘³ç€æ¨¡å‹ä¸ä»…è¦ç†è§£æ–‡æœ¬æŒ‡ä»¤ï¼Œè¿˜è¦å°†å…¶ä¸è§†è§‰è¾“å…¥å…³è”èµ·æ¥ã€‚è®¾è®¡è‰¯å¥½çš„æŒ‡ä»¤æ ¼å¼æ˜¯æˆåŠŸå¾®è°ƒçš„ç¬¬ä¸€æ­¥ã€‚</p>
<h3 id="311">3.1.1 æŒ‡ä»¤æ¨¡æ¿è®¾è®¡</h3>
<p>VLM çš„æŒ‡ä»¤æ¨¡æ¿éœ€è¦æ˜ç¡®æ ‡è¯†å›¾åƒä½ç½®ã€ç”¨æˆ·æŒ‡ä»¤å’Œæ¨¡å‹å“åº”çš„è¾¹ç•Œã€‚å¸¸è§çš„æ¨¡æ¿æ ¼å¼åŒ…æ‹¬ï¼š</p>
<p><strong>åŸºç¡€å•è½®å¯¹è¯æ¨¡æ¿ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>&lt;image&gt;
User: {instruction}
Assistant: {response}
</code></pre></div>

<p><strong>å¸¦ç³»ç»Ÿæç¤ºçš„æ¨¡æ¿ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>System: {system_prompt}
&lt;image&gt;
User: {instruction}
Assistant: {response}
</code></pre></div>

<p><strong>å¤šå›¾åƒäº¤ç»‡æ¨¡æ¿ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">User</span><span class="o">:</span><span class="w"> </span><span class="err">æ¯”è¾ƒè¿™ä¸¤å¼ å›¾ç‰‡</span><span class="w"> </span><span class="o">&lt;</span><span class="n">image1</span><span class="o">&gt;</span><span class="w"> </span><span class="err">å’Œ</span><span class="w"> </span><span class="o">&lt;</span><span class="n">image2</span><span class="o">&gt;</span><span class="err">ï¼Œ</span><span class="o">{</span><span class="n">instruction</span><span class="o">}</span>
<span class="n">Assistant</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="n">response</span><span class="o">}</span>
</code></pre></div>

<p>å…³é”®è®¾è®¡åŸåˆ™ï¼š</p>
<ol>
<li><strong>ä½ç½®æ ‡è®°æ˜ç¡®</strong>ï¼šä½¿ç”¨ç‰¹æ®Š tokenï¼ˆå¦‚ <code>&lt;image&gt;</code>ã€<code>&lt;|im_start|&gt;</code>ï¼‰æ ‡è®°å›¾åƒåµŒå…¥ä½ç½®</li>
<li><strong>è§’è‰²åŒºåˆ†æ¸…æ™°</strong>ï¼šæ˜ç¡®åŒºåˆ† systemã€userã€assistant è§’è‰²</li>
<li><strong>è¾¹ç•Œç¬¦å·ä¸€è‡´</strong>ï¼šä½¿ç”¨ç»Ÿä¸€çš„å¼€å§‹/ç»“æŸæ ‡è®°ï¼ˆå¦‚ <code>&lt;|im_end|&gt;</code>ï¼‰</li>
</ol>
<p><strong>Token åŒ–ç¤ºä¾‹ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>è¾“å…¥æ–‡æœ¬: &quot;&lt;image&gt;\nUser: æè¿°è¿™å¼ å›¾ç‰‡\nAssistant: &quot;
Token IDs: [32000, 13, 2659, 29901, 29871, 31904, 30810, 30775, 30998, 13, 7900, 22137, 29901, 29871]
            â†‘å›¾åƒå ä½  â†‘æ¢è¡Œ  â†‘User:        â†‘æè¿°è¿™å¼ å›¾ç‰‡      â†‘æ¢è¡Œ â†‘Assistant:
</code></pre></div>

<h3 id="312">3.1.2 ç³»ç»Ÿæç¤ºè¯çš„ä½œç”¨</h3>
<p>ç³»ç»Ÿæç¤ºè¯ï¼ˆSystem Promptï¼‰å®šä¹‰æ¨¡å‹çš„è§’è‰²å’Œè¡Œä¸ºå‡†åˆ™ï¼Œå¯¹ VLM çš„è¡¨ç°æœ‰æ˜¾è‘—å½±å“ï¼š</p>
<p><strong>é€šç”¨è§†è§‰åŠ©æ‰‹æç¤ºï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è§†è§‰è¯­è¨€åŠ©æ‰‹ã€‚è¯·å‡†ç¡®æè¿°å›¾åƒå†…å®¹ï¼Œå›ç­”ç”¨æˆ·å…³äºå›¾åƒçš„é—®é¢˜ã€‚
å¦‚æœå›¾åƒä¸­åŒ…å«æ–‡å­—ï¼Œè¯·å‡†ç¡®è¯†åˆ«å¹¶è½¬å½•ã€‚é¿å…çŒœæµ‹æˆ–ç¼–é€ ä¸å­˜åœ¨çš„å†…å®¹ã€‚
</code></pre></div>

<p><strong>ä»»åŠ¡ç‰¹å®šæç¤ºï¼ˆOCRåœºæ™¯ï¼‰ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>ä½ æ˜¯ä¸€ä¸ªOCRä¸“å®¶ã€‚è¯·ï¼š

1. è¯†åˆ«å›¾åƒä¸­çš„æ‰€æœ‰æ–‡å­—
2. ä¿æŒåŸå§‹æ ¼å¼å’Œå¸ƒå±€
3. æ ‡æ³¨ä¸ç¡®å®šçš„å­—ç¬¦ä¸º[?]
4. å¿½ç•¥è£…é¥°æ€§å…ƒç´ ï¼Œä¸“æ³¨æ–‡å­—å†…å®¹
</code></pre></div>

<p>ç³»ç»Ÿæç¤ºçš„ä¼˜åŒ–æŠ€å·§ï¼š</p>
<ul>
<li><strong>é•¿åº¦æ§åˆ¶</strong>ï¼šè¿‡é•¿çš„ç³»ç»Ÿæç¤ºä¼šå ç”¨ä¸Šä¸‹æ–‡çª—å£ï¼Œå»ºè®®æ§åˆ¶åœ¨ 100-200 token</li>
<li><strong>ä»»åŠ¡èšç„¦</strong>ï¼šé’ˆå¯¹ç‰¹å®šä»»åŠ¡å®šåˆ¶æç¤ºï¼Œé¿å…è¿‡äºå®½æ³›</li>
<li><strong>ç¤ºä¾‹å¼•å¯¼</strong>ï¼šåœ¨æç¤ºä¸­åŒ…å«æœŸæœ›è¾“å‡ºæ ¼å¼çš„ç¤ºä¾‹</li>
</ul>
<h3 id="313">3.1.3 å¤šè½®å¯¹è¯çš„å¤„ç†</h3>
<p>VLM çš„å¤šè½®å¯¹è¯éœ€è¦å¤„ç†å†å²ä¸Šä¸‹æ–‡å’Œæ–°å›¾åƒè¾“å…¥çš„å…³ç³»ï¼š</p>
<p><strong>ç­–ç•¥1ï¼šå›¾åƒæŒä¹…åŒ–</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ç¬¬ä¸€è½®</span>
<span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;image&gt; è¿™æ˜¯ä»€ä¹ˆåŠ¨ç‰©ï¼Ÿ&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;è¿™æ˜¯ä¸€åªæ©™è‰²çš„çŒ«ã€‚&quot;</span><span class="p">}</span>
<span class="p">]</span>
<span class="c1"># ç¬¬äºŒè½®ï¼ˆå¼•ç”¨åŒä¸€å›¾åƒï¼‰</span>
<span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;å®ƒåœ¨åšä»€ä¹ˆï¼Ÿ&quot;</span><span class="p">})</span>
<span class="c1"># æ¨¡å‹éœ€è¦è®°ä½ä¹‹å‰çš„å›¾åƒä¸Šä¸‹æ–‡</span>
</code></pre></div>

<p><strong>ç­–ç•¥2ï¼šæ˜¾å¼å›¾åƒå¼•ç”¨</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä½¿ç”¨å›¾åƒIDç³»ç»Ÿ</span>
<span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;image id=&#39;img1&#39;&gt; æè¿°ç¬¬ä¸€å¼ å›¾&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;ç¬¬ä¸€å¼ å›¾æ˜¾ç¤º...&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;image id=&#39;img2&#39;&gt; æ¯”è¾ƒimg1å’Œimg2çš„å·®å¼‚&quot;</span><span class="p">},</span>
<span class="p">]</span>
</code></pre></div>

<p><strong>ä¸Šä¸‹æ–‡çª—å£ç®¡ç†ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>æœ€å¤§ä¸Šä¸‹æ–‡ = 4096 tokens
â”œâ”€â”€ ç³»ç»Ÿæç¤º: ~100 tokens
â”œâ”€â”€ å›¾åƒåµŒå…¥: 576 tokens Ã— Nå¼ å›¾
â”œâ”€â”€ å†å²å¯¹è¯: å¯å˜é•¿åº¦
â””â”€â”€ å½“å‰å›å¤: é¢„ç•™ 500-1000 tokens
</code></pre></div>

<h3 id="314-">3.1.4 è§†è§‰-è¯­è¨€æŒ‡ä»¤çš„å¯¹é½</h3>
<p>ç¡®ä¿è§†è§‰ç†è§£ä¸è¯­è¨€ç”Ÿæˆçš„ä¸€è‡´æ€§æ˜¯ VLM SFT çš„æ ¸å¿ƒæŒ‘æˆ˜ï¼š</p>
<p><strong>å¯¹é½å±‚æ¬¡ï¼š</strong></p>
<ol>
<li><strong>å¯¹è±¡çº§å¯¹é½</strong>ï¼šç‰©ä½“è¯†åˆ«ä¸å‘½åä¸€è‡´</li>
<li><strong>å±æ€§çº§å¯¹é½</strong>ï¼šé¢œè‰²ã€å¤§å°ã€çº¹ç†æè¿°å‡†ç¡®</li>
<li><strong>å…³ç³»çº§å¯¹é½</strong>ï¼šç©ºé—´å…³ç³»ã€åŠ¨ä½œå…³ç³»æ­£ç¡®</li>
<li><strong>åœºæ™¯çº§å¯¹é½</strong>ï¼šæ•´ä½“ç†è§£ä¸æè¿°è¿è´¯</li>
</ol>
<p><strong>å¯¹é½æŠ€æœ¯ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="err">è§†è§‰ç‰¹å¾å¯¹é½çŸ©é˜µ</span><span class="o">:</span>
<span class="w">       </span><span class="err">ç‰©ä½“</span><span class="w">  </span><span class="err">å±æ€§</span><span class="w">  </span><span class="err">å…³ç³»</span><span class="w">  </span><span class="err">åœºæ™¯</span>
<span class="w">       </span><span class="n">________________</span>
<span class="err">è§†è§‰</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mf">1.0</span><span class="w">  </span><span class="mf">0.8</span><span class="w">  </span><span class="mf">0.6</span><span class="w">  </span><span class="mf">0.7</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="err">è§†è§‰ç¼–ç å™¨è¾“å‡º</span>
<span class="err">è¯­è¨€</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mf">0.9</span><span class="w">  </span><span class="mf">0.9</span><span class="w">  </span><span class="mf">0.7</span><span class="w">  </span><span class="mf">0.8</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="err">è¯­è¨€æ¨¡å‹ç†è§£</span>
<span class="w">       </span><span class="err">â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾</span>
<span class="err">å¯¹è§’çº¿å€¼è¶Šæ¥è¿‘</span><span class="mf">1.0</span><span class="err">ï¼Œå¯¹é½è¶Šå¥½</span>
</code></pre></div>

<p><strong>ç»†ç²’åº¦å¯¹é½ç¤ºä¾‹ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Grounding æ ‡æ³¨æ ¼å¼</span>
<span class="n">instruction</span> <span class="o">=</span> <span class="s2">&quot;æ‰¾å‡º&lt;click&gt;çº¢è‰²çš„çƒ&lt;/click&gt;åœ¨å“ªé‡Œ&quot;</span>
<span class="n">response</span> <span class="o">=</span> <span class="s2">&quot;çº¢è‰²çš„çƒä½äº&lt;box&gt;[[125, 235, 200, 310]]&lt;/box&gt;å›¾åƒçš„å·¦ä¸‹è§’ã€‚&quot;</span>

<span class="c1"># Referring æ ‡æ³¨æ ¼å¼  </span>
<span class="n">instruction</span> <span class="o">=</span> <span class="s2">&quot;æè¿°ä½äº&lt;region&gt;[[x1,y1,x2,y2]]&lt;/region&gt;çš„ç‰©ä½“&quot;</span>
<span class="n">response</span> <span class="o">=</span> <span class="s2">&quot;è¿™æ˜¯ä¸€ä¸ªçº¢è‰²çš„ç¯®çƒï¼Œè¡¨é¢æœ‰é»‘è‰²çš„çº¿æ¡çº¹ç†ã€‚&quot;</span>
</code></pre></div>

<h2 id="32">3.2 æŸå¤±å‡½æ•°è®¾è®¡ä¸æƒé‡ç­–ç•¥</h2>
<p>æŸå¤±å‡½æ•°è®¾è®¡ç›´æ¥å½±å“æ¨¡å‹çš„å­¦ä¹ ç›®æ ‡å’Œæ”¶æ•›è¡Œä¸ºã€‚VLM çš„ SFT éœ€è¦ç²¾å¿ƒè®¾è®¡æŸå¤±å‡½æ•°æ¥å¹³è¡¡ä¸åŒç±»å‹çš„é¢„æµ‹ä»»åŠ¡ã€‚</p>
<h3 id="321">3.2.1 è‡ªå›å½’è¯­è¨€æ¨¡å‹æŸå¤±</h3>
<p>VLM çš„æ ¸å¿ƒæŸå¤±æ˜¯è‡ªå›å½’è¯­è¨€å»ºæ¨¡æŸå¤±ï¼Œå³é¢„æµ‹ä¸‹ä¸€ä¸ª token çš„äº¤å‰ç†µæŸå¤±ï¼š</p>
<p>$$\mathcal{L}_{LM} = -\sum_{t=1}^{T} \log P(x_t | x_{&lt;t}, I)$$
å…¶ä¸­ $x_t$ æ˜¯ç¬¬ $t$ ä¸ª tokenï¼Œ$I$ æ˜¯è¾“å…¥å›¾åƒï¼Œ$x_{&lt;t}$ æ˜¯ä¹‹å‰çš„æ‰€æœ‰ tokenã€‚</p>
<p><strong>å®ç°ç»†èŠ‚ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_lm_loss</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">vocab_size</span><span class="o">=</span><span class="mi">32000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    logits: [batch_size, seq_len, vocab_size]</span>
<span class="sd">    labels: [batch_size, seq_len]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Shiftï¼šé¢„æµ‹ä½ç½®å’Œæ ‡ç­¾é”™ä½</span>
    <span class="n">shift_logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
    <span class="n">shift_labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

    <span class="c1"># Flatten ä¾¿äºè®¡ç®—</span>
    <span class="n">shift_logits</span> <span class="o">=</span> <span class="n">shift_logits</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">)</span>
    <span class="n">shift_labels</span> <span class="o">=</span> <span class="n">shift_labels</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># äº¤å‰ç†µæŸå¤±</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
        <span class="n">shift_logits</span><span class="p">,</span> 
        <span class="n">shift_labels</span><span class="p">,</span> 
        <span class="n">ignore_index</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>  <span class="c1"># å¿½ç•¥ padding</span>
        <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span>
</code></pre></div>

<p><strong>æ³¨æ„åŠ›æ©ç çš„å½±å“ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nl">åºåˆ—</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">IMG</span><span class="o">]</span><span class="w"> </span><span class="k">User</span><span class="err">:</span><span class="w"> </span><span class="n">æè¿°å›¾ç‰‡</span><span class="w"> </span><span class="nl">Assistant</span><span class="p">:</span><span class="w"> </span><span class="n">è¿™æ˜¯ä¸€åªçŒ«</span><span class="w"> </span><span class="o">[</span><span class="n">EOS</span><span class="o">]</span>
<span class="nl">æ©ç </span><span class="p">:</span><span class="w">  </span><span class="mi">0</span><span class="w">    </span><span class="mi">0</span><span class="w">     </span><span class="mi">0</span><span class="w">        </span><span class="mi">1</span><span class="w">          </span><span class="mi">1</span><span class="w">          </span><span class="mi">1</span>

<span class="n">åªåœ¨</span><span class="w"> </span><span class="n">Assistant</span><span class="w"> </span><span class="n">å“åº”éƒ¨åˆ†è®¡ç®—æŸå¤±</span>
</code></pre></div>

<h3 id="322">3.2.2 æ©ç ç­–ç•¥ä¸æƒé‡åˆ†é…</h3>
<p>ä¸åŒéƒ¨åˆ†çš„ token å¯¹å­¦ä¹ çš„é‡è¦æ€§ä¸åŒï¼Œé€šè¿‡æ©ç å’Œæƒé‡è°ƒæ•´å¯ä»¥ä¼˜åŒ–è®­ç»ƒæ•ˆæœï¼š</p>
<ol>
<li><strong>å“åº”æ©ç ï¼ˆResponse Maskingï¼‰ï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">create_response_mask</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">response_start_token_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;åªåœ¨æ¨¡å‹å“åº”éƒ¨åˆ†è®¡ç®—æŸå¤±&quot;&quot;&quot;</span>
    <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="c1"># æ‰¾åˆ°å“åº”å¼€å§‹ä½ç½®</span>
        <span class="n">response_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">response_start_token_id</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response_start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">response_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">mask</span>
</code></pre></div>

<ol start="2">
<li><strong>Token çº§åˆ«æƒé‡ï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä¸åŒç±»å‹ token çš„æƒé‡</span>
<span class="n">token_weights</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;special_tokens&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>    <span class="c1"># &lt;image&gt;, &lt;pad&gt; ç­‰</span>
    <span class="s2">&quot;instruction&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>        <span class="c1"># ç”¨æˆ·æŒ‡ä»¤éƒ¨åˆ†</span>
    <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>          <span class="c1"># åŠ©æ‰‹å“åº”</span>
    <span class="s2">&quot;grounding_box&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>     <span class="c1"># åæ ‡é¢„æµ‹</span>
    <span class="s2">&quot;key_entities&quot;</span><span class="p">:</span> <span class="mf">1.5</span>       <span class="c1"># å…³é”®å®ä½“åè¯</span>
<span class="p">}</span>
</code></pre></div>

<ol start="3">
<li><strong>åŠ¨æ€æƒé‡è°ƒæ•´ï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>æ—©æœŸè®­ç»ƒï¼ˆepoch 1-3ï¼‰ï¼š

- æ‰€æœ‰ token æƒé‡ = 1.0
- è®©æ¨¡å‹å­¦ä¹ åŸºç¡€çš„è¯­è¨€æ¨¡å¼

ä¸­æœŸè®­ç»ƒï¼ˆepoch 4-8ï¼‰ï¼š

- æŒ‡ä»¤éƒ¨åˆ†æƒé‡ = 0.5
- å“åº”éƒ¨åˆ†æƒé‡ = 1.0
- å¼ºåŒ–æŒ‡ä»¤éµå¾ªèƒ½åŠ›

åæœŸè®­ç»ƒï¼ˆepoch 9-10ï¼‰ï¼š

- åªè®¡ç®—å“åº”æŸå¤±
- ç²¾ç»†è°ƒæ•´ç”Ÿæˆè´¨é‡
</code></pre></div>

<h3 id="323">3.2.3 å¤šä»»åŠ¡å­¦ä¹ çš„æŸå¤±å¹³è¡¡</h3>
<p>VLM é€šå¸¸éœ€è¦åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œå¦‚å›¾åƒæè¿°ã€VQAã€OCR ç­‰ã€‚å¤šä»»åŠ¡æŸå¤±å¹³è¡¡æ˜¯å…³é”®ï¼š</p>
<p><strong>æŸå¤±ç»„åˆç­–ç•¥ï¼š</strong>
$$\mathcal{L}_{total} = \sum_{i=1}^{N} w_i \mathcal{L}_i$$
<strong>è‡ªé€‚åº”æƒé‡æ–¹æ³•ï¼š</strong></p>
<ol>
<li>
<p><strong>ä¸ç¡®å®šæ€§åŠ æƒï¼ˆUncertainty Weightingï¼‰ï¼š</strong>
$$\mathcal{L}_{total} = \sum_{i=1}^{N} \frac{1}{2\sigma_i^2} \mathcal{L}_i + \log \sigma_i$$
å…¶ä¸­ $\sigma_i$ æ˜¯å¯å­¦ä¹ çš„ä»»åŠ¡ä¸ç¡®å®šæ€§å‚æ•°ã€‚</p>
</li>
<li>
<p><strong>æ¢¯åº¦å½’ä¸€åŒ–ï¼ˆGradNormï¼‰ï¼š</strong></p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">gradnorm_weights</span><span class="p">(</span><span class="n">losses</span><span class="p">,</span> <span class="n">shared_params</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ ¹æ®æ¢¯åº¦å¤§å°åŠ¨æ€è°ƒæ•´ä»»åŠ¡æƒé‡&quot;&quot;&quot;</span>
    <span class="c1"># è®¡ç®—æ¯ä¸ªä»»åŠ¡çš„æ¢¯åº¦èŒƒæ•°</span>
    <span class="n">grad_norms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">loss</span> <span class="ow">in</span> <span class="n">losses</span><span class="p">:</span>
        <span class="n">grads</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">shared_params</span><span class="p">,</span> <span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">g</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grads</span><span class="p">]))</span>
        <span class="n">grad_norms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad_norm</span><span class="p">)</span>

    <span class="c1"># è®¡ç®—å¹³å‡æ¢¯åº¦èŒƒæ•°</span>
    <span class="n">mean_norm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">grad_norms</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># è°ƒæ•´æƒé‡</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">norm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grad_norms</span><span class="p">):</span>
        <span class="n">relative_norm</span> <span class="o">=</span> <span class="n">norm</span> <span class="o">/</span> <span class="n">mean_norm</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">relative_norm</span> <span class="o">**</span> <span class="n">alpha</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>

<p><strong>ä»»åŠ¡é‡‡æ ·ç­–ç•¥ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>æ‰¹æ¬¡æ„å»ºç­–ç•¥:
â”œâ”€â”€ å‡åŒ€é‡‡æ ·: æ¯ä¸ª batch åŒ…å«æ‰€æœ‰ä»»åŠ¡
â”œâ”€â”€ ä»»åŠ¡åˆ†ç»„: ç›¸ä¼¼ä»»åŠ¡æ”¾åœ¨åŒä¸€ batch
â””â”€â”€ æ¸©åº¦é‡‡æ ·: P(task_i) âˆ (1/loss_i)^T

æ¸©åº¦ T æ§åˆ¶é‡‡æ ·åˆ†å¸ƒ:

<span class="k">-</span> T â†’ 0: åªé‡‡æ ·æŸå¤±æœ€å¤§çš„ä»»åŠ¡
<span class="k">-</span> T = 1: æ ¹æ®æŸå¤±åæ¯”é‡‡æ ·  
<span class="k">-</span> T â†’ âˆ: å‡åŒ€é‡‡æ ·æ‰€æœ‰ä»»åŠ¡
</code></pre></div>

<h3 id="324-grounding">3.2.4 è§†è§‰ Grounding æŸå¤±è®¾è®¡</h3>
<p>å¯¹äºéœ€è¦å®šä½çš„ä»»åŠ¡ï¼ˆå¦‚ç›®æ ‡æ£€æµ‹ã€referring segmentationï¼‰ï¼Œéœ€è¦ä¸“é—¨çš„æŸå¤±è®¾è®¡ï¼š</p>
<ol>
<li><strong>è¾¹ç•Œæ¡†å›å½’æŸå¤±ï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">box_loss</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">,</span> <span class="n">gt_boxes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    pred_boxes: [batch, num_queries, 4]  # (x1, y1, x2, y2) å½’ä¸€åŒ–åæ ‡</span>
<span class="sd">    gt_boxes: [batch, num_targets, 4]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># L1 æŸå¤±</span>
    <span class="n">l1_loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">l1_loss</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">,</span> <span class="n">gt_boxes</span><span class="p">)</span>

    <span class="c1"># GIoU æŸå¤±</span>
    <span class="n">giou_loss</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">compute_giou</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">,</span> <span class="n">gt_boxes</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">l1_loss</span> <span class="o">+</span> <span class="n">giou_loss</span>
</code></pre></div>

<ol start="2">
<li><strong>åæ ‡ Token åŒ–ç­–ç•¥ï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>æ–¹æ³•1ï¼šè¿ç»­åæ ‡ç¦»æ•£åŒ–
[0,<span class="w"> </span>1]<span class="w"> </span>â†’<span class="w"> </span>[0,<span class="w"> </span>999]<span class="w"> </span>â†’<span class="w"> </span>token_id<span class="w"> </span>âˆˆ<span class="w"> </span>[32000,<span class="w"> </span>32999]

æ–¹æ³•2ï¼šåŒºåŸŸç¼–ç 
å›¾åƒåˆ†æˆ<span class="w"> </span>32Ã—32<span class="w"> </span>ç½‘æ ¼<span class="w"> </span>â†’<span class="w"> </span>æ¯ä¸ªç½‘æ ¼ä¸€ä¸ª<span class="w"> </span>token

æ–¹æ³•3ï¼šç‰¹æ®Šæ•°å­—<span class="w"> </span>token
<span class="nt">&lt;x&gt;</span>0.123<span class="nt">&lt;/x&gt;</span><span class="w"> </span><span class="nt">&lt;y&gt;</span>0.456<span class="nt">&lt;/y&gt;</span><span class="w"> </span>â†’<span class="w"> </span>è§£ææ—¶æå–
</code></pre></div>

<ol start="3">
<li><strong>Referring æŸå¤±è®¾è®¡ï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">referring_loss</span><span class="p">(</span><span class="n">pred_mask</span><span class="p">,</span> <span class="n">gt_mask</span><span class="p">,</span> <span class="n">pred_box</span><span class="p">,</span> <span class="n">gt_box</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ç»„åˆåˆ†å‰²å’Œæ£€æµ‹æŸå¤±&quot;&quot;&quot;</span>
    <span class="c1"># åƒç´ çº§åˆ†å‰²æŸå¤±</span>
    <span class="n">seg_loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy_with_logits</span><span class="p">(</span><span class="n">pred_mask</span><span class="p">,</span> <span class="n">gt_mask</span><span class="p">)</span>

    <span class="c1"># è¾¹ç•Œæ¡†æŸå¤±</span>
    <span class="n">box_loss</span> <span class="o">=</span> <span class="n">compute_box_loss</span><span class="p">(</span><span class="n">pred_box</span><span class="p">,</span> <span class="n">gt_box</span><span class="p">)</span>

    <span class="c1"># ä¸€è‡´æ€§æŸå¤±ï¼šç¡®ä¿ mask å’Œ box å¯¹åº”</span>
    <span class="n">mask_from_box</span> <span class="o">=</span> <span class="n">box_to_mask</span><span class="p">(</span><span class="n">pred_box</span><span class="p">)</span>
    <span class="n">consistency_loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">pred_mask</span><span class="p">,</span> <span class="n">mask_from_box</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">seg_loss</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">box_loss</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">consistency_loss</span>
</code></pre></div>

<ol start="4">
<li><strong>è´Ÿæ ·æœ¬å¤„ç†ï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="nv">Grounding</span><span class="w"> </span>ä»»åŠ¡çš„è´Ÿæ ·æœ¬ç­–ç•¥:
â”œâ”€â”€<span class="w"> </span><span class="nv">Hard</span><span class="w"> </span><span class="nv">Negative</span>:<span class="w"> </span>é€‰æ‹©æœ€å®¹æ˜“æ··æ·†çš„ç‰©ä½“
â”œâ”€â”€<span class="w"> </span><span class="k">Random</span><span class="w"> </span><span class="nv">Negative</span>:<span class="w"> </span>éšæœºé€‰æ‹©å…¶ä»–ç‰©ä½“
â””â”€â”€<span class="w"> </span><span class="nv">Background</span>:<span class="w"> </span>é€‰æ‹©èƒŒæ™¯åŒºåŸŸ

è´Ÿæ ·æœ¬æ¯”ä¾‹å»ºè®®:

<span class="o">-</span><span class="w"> </span>æ­£è´Ÿæ¯”<span class="w"> </span><span class="mi">1</span>:<span class="mi">3</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>ç›®æ ‡æ£€æµ‹
<span class="o">-</span><span class="w"> </span>æ­£è´Ÿæ¯”<span class="w"> </span><span class="mi">1</span>:<span class="mi">1</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">referring</span><span class="w"> </span><span class="nv">expression</span>
<span class="o">-</span><span class="w"> </span>åŠ¨æ€è°ƒæ•´<span class="nv">based</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span>éš¾åº¦
</code></pre></div>

<h2 id="33-loraqloraadapter">3.3 å‚æ•°é«˜æ•ˆå¾®è°ƒæ–¹æ³•ï¼ˆLoRAã€QLoRAã€Adapterï¼‰</h2>
<p>å‚æ•°é«˜æ•ˆå¾®è°ƒï¼ˆPEFTï¼‰æ–¹æ³•å…è®¸åœ¨æœ‰é™çš„è®¡ç®—èµ„æºä¸‹å¾®è°ƒå¤§è§„æ¨¡ VLMã€‚è¿™äº›æ–¹æ³•é€šè¿‡åªæ›´æ–°å°‘é‡å‚æ•°æ¥å®ç°ä¸å…¨é‡å¾®è°ƒç›¸è¿‘çš„æ•ˆæœã€‚</p>
<h3 id="331-lora">3.3.1 LoRA åŸç†ä¸å®ç°</h3>
<p>LoRAï¼ˆLow-Rank Adaptationï¼‰é€šè¿‡ä½ç§©åˆ†è§£æ¥è¿‘ä¼¼æƒé‡æ›´æ–°ï¼š</p>
<p><strong>æ ¸å¿ƒåŸç†ï¼š</strong>
$$W' = W + \Delta W = W + BA$$</p>
<p>å…¶ä¸­ $B \in \mathbb{R}^{d \times r}$ï¼Œ$A \in \mathbb{R}^{r \times k}$ï¼Œ$r \ll \min(d, k)$ã€‚</p>
<p><strong>VLM ä¸­çš„ LoRA é…ç½®ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">LoRAConfig</span><span class="p">:</span>
    <span class="c1"># è¯­è¨€æ¨¡å‹éƒ¨åˆ†</span>
    <span class="n">lm_target_modules</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;q_proj&quot;</span><span class="p">,</span> <span class="s2">&quot;v_proj&quot;</span><span class="p">,</span>  <span class="c1"># æ³¨æ„åŠ›å±‚</span>
        <span class="s2">&quot;k_proj&quot;</span><span class="p">,</span> <span class="s2">&quot;o_proj&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gate_proj&quot;</span><span class="p">,</span> <span class="s2">&quot;up_proj&quot;</span><span class="p">,</span> <span class="s2">&quot;down_proj&quot;</span>  <span class="c1"># FFN å±‚</span>
    <span class="p">]</span>

    <span class="c1"># è§†è§‰ç¼–ç å™¨éƒ¨åˆ†ï¼ˆå¯é€‰ï¼‰</span>
    <span class="n">vision_target_modules</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;qkv&quot;</span><span class="p">,</span>  <span class="c1"># ViT çš„ QKV æŠ•å½±</span>
        <span class="s2">&quot;proj&quot;</span><span class="p">,</span> <span class="c1"># è¾“å‡ºæŠ•å½±</span>
        <span class="s2">&quot;mlp.fc1&quot;</span><span class="p">,</span> <span class="s2">&quot;mlp.fc2&quot;</span>  <span class="c1"># MLP å±‚</span>
    <span class="p">]</span>

    <span class="c1"># å…³é”®è¶…å‚æ•°</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">16</span>  <span class="c1"># rankï¼Œå¸¸ç”¨ 8/16/32/64</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mi">16</span>  <span class="c1"># ç¼©æ”¾å› å­ï¼Œé€šå¸¸ = r</span>
    <span class="n">dropout</span> <span class="o">=</span> <span class="mf">0.1</span>
</code></pre></div>

<p><strong>åŠ¨æ€ Rank é€‰æ‹©ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="err">ä¸åŒæ¨¡å—çš„é‡è¦æ€§åˆ†æ</span><span class="o">:</span>
<span class="err">æ¨¡å—ç±»å‹</span><span class="w">        </span><span class="err">å»ºè®®</span><span class="w"> </span><span class="n">rank</span><span class="w">   </span><span class="err">å‚æ•°å æ¯”</span>
<span class="o">-----------------------------------------</span>
<span class="n">Q</span><span class="o">,</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="err">æŠ•å½±</span><span class="w">       </span><span class="mi">8</span><span class="o">-</span><span class="mi">16</span><span class="w">       </span><span class="o">~</span><span class="mi">15</span><span class="o">%</span>
<span class="n">V</span><span class="o">,</span><span class="w"> </span><span class="n">O</span><span class="w"> </span><span class="err">æŠ•å½±</span><span class="w">       </span><span class="mi">16</span><span class="o">-</span><span class="mi">32</span><span class="w">      </span><span class="o">~</span><span class="mi">20</span><span class="o">%</span><span class="w">  </span>
<span class="n">FFN</span><span class="w"> </span><span class="err">ä¸ŠæŠ•å½±</span><span class="w">      </span><span class="mi">32</span><span class="o">-</span><span class="mi">64</span><span class="w">      </span><span class="o">~</span><span class="mi">35</span><span class="o">%</span>
<span class="n">FFN</span><span class="w"> </span><span class="err">ä¸‹æŠ•å½±</span><span class="w">      </span><span class="mi">16</span><span class="o">-</span><span class="mi">32</span><span class="w">      </span><span class="o">~</span><span class="mi">25</span><span class="o">%</span>
<span class="n">Cross</span><span class="o">-</span><span class="n">Attn</span><span class="w">     </span><span class="mi">32</span><span class="o">-</span><span class="mi">64</span><span class="w">      </span><span class="o">~</span><span class="mi">5</span><span class="o">%</span><span class="w"> </span><span class="o">(</span><span class="err">å¦‚æœæœ‰</span><span class="o">)</span>
</code></pre></div>

<p><strong>å®ç°ç»†èŠ‚ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">LoRALayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_features</span><span class="p">,</span> <span class="n">out_features</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">/</span> <span class="n">rank</span>

        <span class="c1"># ä½ç§©çŸ©é˜µ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lora_A</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">in_features</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lora_B</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">out_features</span><span class="p">,</span> <span class="n">rank</span><span class="p">))</span>

        <span class="c1"># åˆå§‹åŒ–</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">kaiming_uniform_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_A</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">base_output</span><span class="p">):</span>
        <span class="c1"># base_output æ˜¯åŸå§‹å±‚çš„è¾“å‡º</span>
        <span class="n">lora_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_A</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_B</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span>
        <span class="k">return</span> <span class="n">base_output</span> <span class="o">+</span> <span class="n">lora_output</span>
</code></pre></div>

<h3 id="332-qlora">3.3.2 QLoRA çš„é‡åŒ–ç­–ç•¥</h3>
<p>QLoRA ç»“åˆ 4-bit é‡åŒ–å’Œ LoRAï¼Œå¤§å¹…é™ä½æ˜¾å­˜å ç”¨ï¼š</p>
<p><strong>é‡åŒ–æµç¨‹ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>åŸå§‹æ¨¡å‹ (16-bit) â†’ NF4 é‡åŒ– (4-bit) + LoRA é€‚é…å™¨ (16-bit)
æ˜¾å­˜èŠ‚çœ: ~75% (ç›¸æ¯”å…¨ç²¾åº¦)
</code></pre></div>

<p><strong>NF4ï¼ˆNormalFloat4ï¼‰é‡åŒ–ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">quantize_nf4</span><span class="p">(</span><span class="n">tensor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;4-bit NormalFloat é‡åŒ–&quot;&quot;&quot;</span>
    <span class="c1"># 1. å½’ä¸€åŒ–åˆ° [-1, 1]</span>
    <span class="n">absmax</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">tensor_normalized</span> <span class="o">=</span> <span class="n">tensor</span> <span class="o">/</span> <span class="n">absmax</span>

    <span class="c1"># 2. é‡åŒ–åˆ° 16 ä¸ªçº§åˆ«</span>
    <span class="n">quantization_levels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6961</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5250</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3949</span><span class="p">,</span> 
        <span class="o">-</span><span class="mf">0.2844</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1848</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0911</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="mf">0.0796</span><span class="p">,</span> <span class="mf">0.1609</span><span class="p">,</span> <span class="mf">0.2461</span><span class="p">,</span> <span class="mf">0.3379</span><span class="p">,</span>
        <span class="mf">0.4407</span><span class="p">,</span> <span class="mf">0.5626</span><span class="p">,</span> <span class="mf">0.7230</span><span class="p">,</span> <span class="mf">1.0</span>
    <span class="p">]</span>

    <span class="c1"># 3. æ‰¾æœ€è¿‘çš„é‡åŒ–çº§åˆ«</span>
    <span class="n">quantized</span> <span class="o">=</span> <span class="n">quantize_to_nearest</span><span class="p">(</span><span class="n">tensor_normalized</span><span class="p">,</span> <span class="n">quantization_levels</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">quantized</span><span class="p">,</span> <span class="n">absmax</span>  <span class="c1"># ä¿å­˜ scale ç”¨äºåé‡åŒ–</span>
</code></pre></div>

<p><strong>åŒé‡é‡åŒ–ï¼ˆDouble Quantizationï¼‰ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="err">ç¬¬ä¸€æ¬¡é‡åŒ–</span><span class="o">:</span><span class="w"> </span><span class="err">æ¨¡å‹æƒé‡</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="mi">4</span><span class="o">-</span><span class="n">bit</span>
<span class="err">ç¬¬äºŒæ¬¡é‡åŒ–</span><span class="o">:</span><span class="w"> </span><span class="err">é‡åŒ–å¸¸æ•°</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="mi">8</span><span class="o">-</span><span class="n">bit</span>
<span class="err">é¢å¤–èŠ‚çœ</span><span class="o">:</span><span class="w"> </span><span class="o">~</span><span class="mf">0.37</span><span class="w"> </span><span class="n">bit</span><span class="o">/</span><span class="err">å‚æ•°</span>
</code></pre></div>

<p><strong>QLoRA è®­ç»ƒé…ç½®ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">bnb_config</span> <span class="o">=</span> <span class="n">BitsAndBytesConfig</span><span class="p">(</span>
    <span class="n">load_in_4bit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">bnb_4bit_quant_type</span><span class="o">=</span><span class="s2">&quot;nf4&quot;</span><span class="p">,</span>
    <span class="n">bnb_4bit_compute_dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">,</span>
    <span class="n">bnb_4bit_use_double_quant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Paged Optimizer èŠ‚çœä¼˜åŒ–å™¨å†…å­˜</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">PagedAdamW32bit</span><span class="p">(</span>
    <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
    <span class="n">lr</span><span class="o">=</span><span class="mf">2e-4</span><span class="p">,</span>
    <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">optim_bits</span><span class="o">=</span><span class="mi">32</span>  <span class="c1"># ä¼˜åŒ–å™¨çŠ¶æ€ä¿æŒ 32-bit</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="333-adapter">3.3.3 Adapter å±‚çš„è®¾è®¡é€‰æ‹©</h3>
<p>Adapter é€šè¿‡æ’å…¥å°å‹ç½‘ç»œæ¨¡å—æ¥å®ç°å‚æ•°é«˜æ•ˆå¾®è°ƒï¼š</p>
<p><strong>æ ‡å‡† Adapter æ¶æ„ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>è¾“å…¥ â†’ LayerNorm â†’ Down-projection â†’ æ¿€æ´» â†’ Up-projection â†’ æ®‹å·®è¿æ¥
  â†“                                                               â†‘
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>VLM ä¸­çš„ Adapter å˜ä½“ï¼š</strong></p>
<ol>
<li><strong>Sequential Adapterï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">SequentialAdapter</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">reduction_factor</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">//</span> <span class="n">reduction_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">down_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">GELU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">up_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down_proj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up_proj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">residual</span>
</code></pre></div>

<ol start="2">
<li><strong>Parallel Adapterï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ParallelAdapter</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å¹¶è¡Œå¤„ç†ï¼Œå‡å°‘å»¶è¿Ÿ&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">original_output</span><span class="p">):</span>
        <span class="n">adapter_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapter</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">original_output</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">adapter_output</span>
</code></pre></div>

<ol start="3">
<li><strong>Cross-Modal Adapterï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CrossModalAdapter</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä¸“é—¨å¤„ç†è§†è§‰-è¯­è¨€äº¤äº’&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vision_dim</span><span class="p">,</span> <span class="n">text_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vision_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">vision_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">text_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fusion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">num_heads</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vision_features</span><span class="p">,</span> <span class="n">text_features</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vision_proj</span><span class="p">(</span><span class="n">vision_features</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_proj</span><span class="p">(</span><span class="n">text_features</span><span class="p">)</span>
        <span class="n">fused</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>  <span class="c1"># text ä½œ query</span>
        <span class="k">return</span> <span class="n">fused</span>
</code></pre></div>

<h3 id="334-peft">3.3.4 PEFT æ–¹æ³•å¯¹æ¯”ä¸é€‰æ‹©</h3>
<p><strong>æ€§èƒ½å¯¹æ¯”è¡¨ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>æ–¹æ³•        å‚æ•°é‡   æ˜¾å­˜å ç”¨  è®­ç»ƒé€Ÿåº¦  æ•ˆæœ(ç›¸å¯¹å…¨é‡)
---------------------------------------------------------
å…¨é‡å¾®è°ƒ     100%     100%      1.0x      100%
LoRA        0.1-1%   ~60%      1.5x      95-98%
QLoRA       0.1-1%   ~25%      1.2x      92-96%
Adapter     1-5%     ~70%      1.3x      93-97%
Prefix      &lt;0.1%    ~50%      1.8x      85-92%
IA3         &lt;0.01%   ~55%      1.6x      88-94%
</code></pre></div>

<p><strong>é€‰æ‹©å†³ç­–æ ‘ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>æ˜¾å­˜é™åˆ¶ä¸¥æ ¼ï¼Ÿ
â”œâ”€ æ˜¯ â†’ QLoRAï¼ˆ4-bité‡åŒ– + LoRAï¼‰
â””â”€ å¦ â†’ éœ€è¦æœ€ä½³æ€§èƒ½ï¼Ÿ
        â”œâ”€ æ˜¯ â†’ å…¨é‡å¾®è°ƒ or LoRA (r=64)
        â””â”€ å¦ â†’ æ¨ç†é€Ÿåº¦ä¼˜å…ˆï¼Ÿ
                â”œâ”€ æ˜¯ â†’ LoRA (å¯åˆå¹¶æƒé‡)
                â””â”€ å¦ â†’ Adapter (çµæ´»æ€§é«˜)
</code></pre></div>

<p><strong>ç»„åˆç­–ç•¥ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ··åˆ PEFTï¼šä¸åŒå±‚ä½¿ç”¨ä¸åŒæ–¹æ³•</span>
<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;vision_encoder&quot;</span><span class="p">:</span> <span class="s2">&quot;frozen&quot;</span><span class="p">,</span>  <span class="c1"># å†»ç»“</span>
    <span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span>        <span class="c1"># å…¨é‡å¾®è°ƒ</span>
    <span class="s2">&quot;llm_layers_0_16&quot;</span><span class="p">:</span> <span class="s2">&quot;lora&quot;</span><span class="p">,</span>  <span class="c1"># åº•å±‚ç”¨ LoRA</span>
    <span class="s2">&quot;llm_layers_16_32&quot;</span><span class="p">:</span> <span class="s2">&quot;adapter&quot;</span><span class="p">,</span>  <span class="c1"># é«˜å±‚ç”¨ Adapter</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>å®è·µå»ºè®®ï¼š</strong></p>
<ol>
<li><strong>åˆå§‹å®éªŒ</strong>ï¼šä» LoRA r=8 å¼€å§‹ï¼Œé€æ­¥å¢åŠ </li>
<li><strong>è§†è§‰ç¼–ç å™¨</strong>ï¼šé€šå¸¸å†»ç»“æˆ–ç”¨å¾ˆå°çš„ rankï¼ˆr=4ï¼‰</li>
<li><strong>æŠ•å½±å±‚</strong>ï¼šå»ºè®®å…¨é‡å¾®è°ƒï¼Œå‚æ•°é‡å°ä½†é‡è¦</li>
<li><strong>ä»»åŠ¡é€‚é…</strong>ï¼šç®€å•ä»»åŠ¡ç”¨ LoRAï¼Œå¤æ‚ä»»åŠ¡è€ƒè™‘ Adapter</li>
</ol>
<h2 id="34">3.4 è®­ç»ƒç¨³å®šæ€§ä¸æ”¶æ•›æŠ€å·§</h2>
<p>è®­ç»ƒå¤§è§„æ¨¡ VLM æ—¶ç»å¸¸é‡åˆ°ä¸ç¨³å®šé—®é¢˜ï¼šæŸå¤±çªç„¶çˆ†ç‚¸ã€æ¢¯åº¦æ¶ˆå¤±ã€æ”¶æ•›ç¼“æ…¢ç­‰ã€‚æœ¬èŠ‚ä»‹ç»å®ç”¨çš„ç¨³å®šæ€§æŠ€å·§ã€‚</p>
<h3 id="341">3.4.1 å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥</h3>
<p><strong>VLM å¸¸ç”¨è°ƒåº¦å™¨ï¼š</strong></p>
<ol>
<li><strong>Cosine with Warmupï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">cosine_schedule_with_warmup</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">num_warmup_steps</span><span class="p">,</span> <span class="n">num_training_steps</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">lr_lambda</span><span class="p">(</span><span class="n">current_step</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">current_step</span> <span class="o">&lt;</span> <span class="n">num_warmup_steps</span><span class="p">:</span>
            <span class="c1"># çº¿æ€§ warmup</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">current_step</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_warmup_steps</span><span class="p">))</span>
        <span class="c1"># Cosine è¡°å‡</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">current_step</span> <span class="o">-</span> <span class="n">num_warmup_steps</span><span class="p">)</span> <span class="o">/</span> \
                  <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_training_steps</span> <span class="o">-</span> <span class="n">num_warmup_steps</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">progress</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">LambdaLR</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">lr_lambda</span><span class="p">)</span>
</code></pre></div>

<ol start="2">
<li><strong>åˆ†é˜¶æ®µå­¦ä¹ ç‡ï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>é˜¶æ®µ1ï¼ˆé¢„çƒ­ï¼‰: lr = 1e-6 â†’ 2e-4 (çº¿æ€§å¢é•¿)
é˜¶æ®µ2ï¼ˆä¸»è®­ç»ƒï¼‰: lr = 2e-4 (æ’å®šæˆ–ç¼“æ…¢è¡°å‡)
é˜¶æ®µ3ï¼ˆç²¾è°ƒï¼‰: lr = 2e-4 â†’ 1e-5 (cosineè¡°å‡)
</code></pre></div>

<p><strong>è§†è§‰ç¼–ç å™¨ç‰¹æ®Šå¤„ç†ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä¸åŒç»„ä»¶ä¸åŒå­¦ä¹ ç‡</span>
<span class="n">param_groups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">vision_encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">},</span>  <span class="c1"># æ›´å°</span>
    <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">projection</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">5e-4</span><span class="p">},</span>      <span class="c1"># æ›´å¤§</span>
    <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">language_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">2e-4</span><span class="p">},</span>  <span class="c1"># æ ‡å‡†</span>
<span class="p">]</span>
</code></pre></div>

<h3 id="342">3.4.2 æ¢¯åº¦è£å‰ªä¸å½’ä¸€åŒ–</h3>
<p><strong>æ¢¯åº¦è£å‰ªç­–ç•¥ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. å…¨å±€æ¢¯åº¦è£å‰ªï¼ˆæ¨èï¼‰</span>
<span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">max_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># 2. åˆ†å±‚æ¢¯åº¦è£å‰ª</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
    <span class="k">if</span> <span class="s2">&quot;vision&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">([</span><span class="n">param</span><span class="p">],</span> <span class="n">max_norm</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">([</span><span class="n">param</span><span class="p">],</span> <span class="n">max_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</code></pre></div>

<p><strong>æ¢¯åº¦ç›‘æ§ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">monitor_gradients</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ç›‘æ§æ¢¯åº¦ç»Ÿè®¡ä¿¡æ¯&quot;&quot;&quot;</span>
    <span class="n">grad_stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grad_stats</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
            <span class="p">}</span>
    <span class="k">return</span> <span class="n">grad_stats</span>

<span class="c1"># å¼‚å¸¸æ£€æµ‹</span>
<span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">grad_stats</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;æ¢¯åº¦çˆ†ç‚¸é£é™©ï¼&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="343">3.4.3 æƒé‡åˆå§‹åŒ–æŠ€å·§</h3>
<p><strong>å…³é”®ç»„ä»¶åˆå§‹åŒ–ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">init_vlm_weights</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="c1"># 1. æŠ•å½±å±‚ï¼šXavier åˆå§‹åŒ–</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;visual_projection&#39;</span><span class="p">):</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">visual_projection</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">visual_projection</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>

    <span class="c1"># 2. LoRA å±‚ï¼šæ¥è¿‘é›¶åˆå§‹åŒ–</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
        <span class="k">if</span> <span class="s2">&quot;lora_B&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>  <span class="c1"># B çŸ©é˜µåˆå§‹åŒ–ä¸º0</span>
        <span class="k">elif</span> <span class="s2">&quot;lora_A&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">kaiming_uniform_</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

    <span class="c1"># 3. Layer Scaleï¼šå°å€¼åˆå§‹åŒ–</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;layer_scale&#39;</span><span class="p">):</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">layer_scale</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">)</span>
</code></pre></div>

<p><strong>ç¨³å®šæ€§æŠ€å·§ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>åˆå§‹åŒ–æ£€æŸ¥æ¸…å•ï¼š
â–¡ æŠ•å½±å±‚ä¸èƒ½å¤ªå¤§ï¼ˆstd &lt; 0.02ï¼‰
â–¡ LoRA B çŸ©é˜µåˆå§‹ä¸º 0
â–¡ Layer Norm æƒé‡ = 1, åç½® = 0
â–¡ æ–°å¢ token embedding ç”¨å·²æœ‰ token å¹³å‡å€¼
</code></pre></div>

<h3 id="344-checkpoint">3.4.4 æ—©åœä¸ Checkpoint ç­–ç•¥</h3>
<p><strong>æ™ºèƒ½ Checkpointï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">SmartCheckpointer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">=</span> <span class="n">patience</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">should_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val_loss</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="n">val_loss</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">val_loss</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="n">val_loss</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">should_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience</span>
</code></pre></div>

<p><strong>Checkpoint ç®¡ç†ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">checkpoint</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
    <span class="s1">&#39;model_state_dict&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
    <span class="s1">&#39;optimizer_state_dict&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
    <span class="s1">&#39;scheduler_state_dict&#39;</span><span class="p">:</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
    <span class="s1">&#39;best_val_loss&#39;</span><span class="p">:</span> <span class="n">best_val_loss</span><span class="p">,</span>
    <span class="s1">&#39;training_history&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;train_losses&#39;</span><span class="p">:</span> <span class="n">train_losses</span><span class="p">,</span>
        <span class="s1">&#39;val_losses&#39;</span><span class="p">:</span> <span class="n">val_losses</span><span class="p">,</span>
        <span class="s1">&#39;learning_rates&#39;</span><span class="p">:</span> <span class="n">lrs</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># ä¿å­˜ç­–ç•¥</span>
<span class="n">save_strategies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;best&quot;</span><span class="p">:</span> <span class="s2">&quot;checkpoint_best.pt&quot;</span><span class="p">,</span>        <span class="c1"># æœ€ä½³éªŒè¯æ€§èƒ½</span>
    <span class="s2">&quot;latest&quot;</span><span class="p">:</span> <span class="s2">&quot;checkpoint_latest.pt&quot;</span><span class="p">,</span>    <span class="c1"># æœ€æ–°çŠ¶æ€</span>
    <span class="s2">&quot;periodic&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;checkpoint_epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.pt&quot;</span><span class="p">,</span>  <span class="c1"># å®šæœŸä¿å­˜</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="case-study-qwen-vl">Case Study: Qwen-VL çš„ä¸‰é˜¶æ®µè®­ç»ƒç­–ç•¥å®æˆ˜</h2>
<p>Qwen-VL é‡‡ç”¨æ¸è¿›å¼ä¸‰é˜¶æ®µè®­ç»ƒç­–ç•¥ï¼Œä»å¤§è§„æ¨¡é¢„è®­ç»ƒåˆ°ç²¾ç»†æŒ‡ä»¤å¾®è°ƒï¼Œå®ç°äº†ä¼˜ç§€çš„å¤šæ¨¡æ€æ€§èƒ½ã€‚</p>
<h3 id="-">é˜¶æ®µä¸€ï¼šè§†è§‰-è¯­è¨€é¢„è®­ç»ƒ</h3>
<p><strong>ç›®æ ‡</strong>ï¼šå»ºç«‹åŸºç¡€çš„è§†è§‰-è¯­è¨€å¯¹é½èƒ½åŠ›</p>
<p><strong>æ•°æ®é…ç½®ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>æ€»é‡ï¼š1.4B å›¾æ–‡å¯¹
â”œâ”€â”€ LAION-400M: 40%ï¼ˆç½‘ç»œçˆ¬å–ï¼‰
â”œâ”€â”€ COYO-700M: 30%ï¼ˆéŸ©è¯­+è‹±è¯­ï¼‰
â”œâ”€â”€ CC12M: 15%ï¼ˆæ¦‚å¿µæè¿°ï¼‰
â””â”€â”€ å†…éƒ¨æ•°æ®: 15%ï¼ˆé«˜è´¨é‡ç­›é€‰ï¼‰
</code></pre></div>

<p><strong>è®­ç»ƒé…ç½®ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">stage1_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;vision_encoder&quot;</span><span class="p">:</span> <span class="s2">&quot;frozen&quot;</span><span class="p">,</span>  <span class="c1"># OpenCLIP ViT-G/14</span>
    <span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="s2">&quot;trainable&quot;</span><span class="p">,</span>   <span class="c1"># æ–°å¢çš„ Resampler</span>
    <span class="s2">&quot;language_model&quot;</span><span class="p">:</span> <span class="s2">&quot;trainable&quot;</span><span class="p">,</span>  <span class="c1"># Qwen-7B</span>
    <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">2048</span><span class="p">,</span>
    <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="mf">1e-4</span><span class="p">,</span>
    <span class="s2">&quot;warmup_steps&quot;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span>
    <span class="s2">&quot;total_steps&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="_1">é˜¶æ®µäºŒï¼šå¤šä»»åŠ¡é¢„è®­ç»ƒ</h3>
<p><strong>ç›®æ ‡</strong>ï¼šå­¦ä¹ å¤šæ ·åŒ–çš„è§†è§‰ä»»åŠ¡èƒ½åŠ›</p>
<p><strong>ä»»åŠ¡åˆ†å¸ƒï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>ä»»åŠ¡ç±»å‹         æ•°æ®é‡    æŸå¤±æƒé‡
--------------------------------------
å›¾åƒæè¿°         50M      0.3
VQA             30M      0.2
OCR             20M      0.2
Grounding       15M      0.15
Referring       10M      0.15
</code></pre></div>

<p><strong>å…³é”®æŠ€æœ¯ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># åŠ¨æ€åˆ†è¾¨ç‡å¤„ç†</span>
<span class="k">def</span> <span class="nf">dynamic_resolution</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">min_pixels</span><span class="o">=</span><span class="mi">224</span><span class="o">*</span><span class="mi">224</span><span class="p">,</span> <span class="n">max_pixels</span><span class="o">=</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä¿æŒå®½é«˜æ¯”çš„åŠ¨æ€åˆ†è¾¨ç‡&quot;&quot;&quot;</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">current_pixels</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">w</span>

    <span class="k">if</span> <span class="n">current_pixels</span> <span class="o">&lt;</span> <span class="n">min_pixels</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">min_pixels</span> <span class="o">/</span> <span class="n">current_pixels</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">current_pixels</span> <span class="o">&gt;</span> <span class="n">max_pixels</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">max_pixels</span> <span class="o">/</span> <span class="n">current_pixels</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">new_h</span><span class="p">,</span> <span class="n">new_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">scale</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
    <span class="c1"># ç¡®ä¿æ˜¯ 14 çš„å€æ•°ï¼ˆViT patch sizeï¼‰</span>
    <span class="n">new_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_h</span> <span class="o">//</span> <span class="mi">14</span><span class="p">)</span> <span class="o">*</span> <span class="mi">14</span>
    <span class="n">new_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_w</span> <span class="o">//</span> <span class="mi">14</span><span class="p">)</span> <span class="o">*</span> <span class="mi">14</span>

    <span class="k">return</span> <span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">new_h</span><span class="p">,</span> <span class="n">new_w</span><span class="p">))</span>
</code></pre></div>

<h3 id="_2">é˜¶æ®µä¸‰ï¼šæŒ‡ä»¤å¾®è°ƒ</h3>
<p><strong>ç›®æ ‡</strong>ï¼šä¼˜åŒ–æŒ‡ä»¤éµå¾ªå’Œå¯¹è¯èƒ½åŠ›</p>
<p><strong>æ•°æ®æ„æˆï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">sft_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;high_quality_vqa&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="n">k</span><span class="p">,</span>  <span class="c1"># äººå·¥æ ‡æ³¨</span>
    <span class="s2">&quot;complex_reasoning&quot;</span><span class="p">:</span> <span class="mi">150</span><span class="n">k</span><span class="p">,</span>  <span class="c1"># GPT-4V ç”Ÿæˆ</span>
    <span class="s2">&quot;multi_turn_dialog&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="n">k</span><span class="p">,</span>  <span class="c1"># å¤šè½®å¯¹è¯</span>
    <span class="s2">&quot;rejection_sampling&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="n">k</span><span class="p">,</span>  <span class="c1"># è´Ÿæ ·æœ¬</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>LoRA å¾®è°ƒé…ç½®ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">lora_config</span> <span class="o">=</span> <span class="n">LoRAConfig</span><span class="p">(</span>
    <span class="n">r</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>  <span class="c1"># è¾ƒå¤§çš„ rank</span>
    <span class="n">lora_alpha</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">target_modules</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;c_attn&quot;</span><span class="p">,</span>  <span class="c1"># Qwen çš„æ³¨æ„åŠ›æ¨¡å—</span>
        <span class="s2">&quot;c_proj&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;w1&quot;</span><span class="p">,</span> <span class="s2">&quot;w2&quot;</span><span class="p">,</span>  <span class="c1"># MLP</span>
    <span class="p">],</span>
    <span class="n">lora_dropout</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">task_type</span><span class="o">=</span><span class="s2">&quot;CAUSAL_LM&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># åªå¾®è°ƒè¯­è¨€æ¨¡å‹éƒ¨åˆ†</span>
<span class="n">trainable_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
<span class="n">total_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;å¯è®­ç»ƒå‚æ•°: </span><span class="si">{</span><span class="n">trainable_params</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">M (</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">trainable_params</span><span class="o">/</span><span class="n">total_params</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="c1"># è¾“å‡º: å¯è®­ç»ƒå‚æ•°: 384.00M (4.92%)</span>
</code></pre></div>

<p><strong>è®­ç»ƒæ›²çº¿ç›‘æ§ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>       Loss
   3.5 |
   3.0 |  Stage 1
   2.5 |    â•²___
   2.0 |         â•²__ Stage 2
   1.5 |             â•²____
   1.0 |                  â•²___ Stage 3
   0.5 |                      â•²________
       |__|__|__|__|__|__|__|__|__|__|__
         10k  20k  30k  40k  50k  60k  Steps
</code></pre></div>

<h2 id="_3">é«˜çº§è¯é¢˜</h2>
<h3 id="_4">è§†è§‰ç¼–ç å™¨è§£å†»æ—¶æœº</h3>
<p><strong>è§£å†»ç­–ç•¥å¯¹æ¯”ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c">ç­–ç•¥            ä¼˜ç‚¹                ç¼ºç‚¹              é€‚ç”¨åœºæ™¯</span>
<span class="nb">-----------------------------------------------------------------</span>
<span class="c">å§‹ç»ˆå†»ç»“        çœæ˜¾å­˜ã€è®­ç»ƒå¿«      å¯èƒ½æ¬ æ‹Ÿåˆ        æ•°æ®ä¸é¢„è®­ç»ƒç›¸ä¼¼</span>
<span class="c">ä»å¤´è§£å†»        å……åˆ†é€‚åº”æ–°ä»»åŠ¡      æ˜“è¿‡æ‹Ÿåˆã€æ…¢      å¤§è§„æ¨¡æ–°é¢†åŸŸæ•°æ®</span>
<span class="c">é˜¶æ®µæ€§è§£å†»      å¹³è¡¡æ€§èƒ½ä¸æ•ˆç‡      éœ€è¦ç»éªŒè°ƒå‚      é€šç”¨åœºæ™¯ï¼ˆæ¨èï¼‰</span>
</code></pre></div>

<p><strong>é˜¶æ®µæ€§è§£å†»å®è·µï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">staged_unfreeze</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">current_step</span><span class="p">,</span> <span class="n">total_steps</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ¸è¿›è§£å†»è§†è§‰ç¼–ç å™¨&quot;&quot;&quot;</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="n">current_step</span> <span class="o">/</span> <span class="n">total_steps</span>

    <span class="k">if</span> <span class="n">progress</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="c1"># å‰ 50%: å…¨éƒ¨å†»ç»“</span>
        <span class="n">freeze_vision_encoder</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">progress</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
        <span class="c1"># 50-80%: è§£å†»æœ€å 4 å±‚</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">vision_encoder</span><span class="o">.</span><span class="n">layers</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">vision_encoder</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">freeze_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unfreeze_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># æœ€å 20%: å…¨éƒ¨è§£å†»ï¼Œä½†ç”¨æ›´å°å­¦ä¹ ç‡</span>
        <span class="n">unfreeze_vision_encoder</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="c1"># è§†è§‰ç¼–ç å™¨å­¦ä¹ ç‡ = 0.1 * åŸºç¡€å­¦ä¹ ç‡</span>
</code></pre></div>

<h3 id="lora-rank">LoRA Rank è‡ªé€‚åº”é€‰æ‹©</h3>
<p><strong>åŸºäºé‡è¦æ€§çš„ Rank åˆ†é…ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_layer_importance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;è®¡ç®—å„å±‚çš„ Fisher ä¿¡æ¯çŸ©é˜µè¿¹&quot;&quot;&quot;</span>
    <span class="n">importance_scores</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">[:</span><span class="n">num_samples</span><span class="p">]:</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">compute_loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
                <span class="n">grad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">importance_scores</span><span class="p">:</span>
                    <span class="n">importance_scores</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">importance_scores</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

    <span class="c1"># å½’ä¸€åŒ–</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">importance_scores</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">importance_scores</span><span class="p">:</span>
        <span class="n">importance_scores</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">/=</span> <span class="n">total</span>

    <span class="k">return</span> <span class="n">importance_scores</span>

<span class="c1"># æ ¹æ®é‡è¦æ€§åˆ†é… rank</span>
<span class="k">def</span> <span class="nf">adaptive_rank_allocation</span><span class="p">(</span><span class="n">importance_scores</span><span class="p">,</span> <span class="n">total_rank_budget</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>
    <span class="n">rank_allocation</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">importance_scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># rank âˆˆ [4, 64]</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">score</span> <span class="o">*</span> <span class="n">total_rank_budget</span><span class="p">)))</span>
        <span class="c1"># ç¡®ä¿æ˜¯ 4 çš„å€æ•°ï¼ˆç¡¬ä»¶å‹å¥½ï¼‰</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="p">(</span><span class="n">rank</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="n">rank_allocation</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rank</span>
    <span class="k">return</span> <span class="n">rank_allocation</span>
</code></pre></div>

<h3 id="_5">æ··åˆç²¾åº¦è®­ç»ƒçš„ç¨³å®šæ€§</h3>
<p><strong>BF16 vs FP16 é€‰æ‹©ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>ç‰¹æ€§          FP16            BF16
-----------------------------------------
åŠ¨æ€èŒƒå›´      Â±65504          Â±3.4e38
ç²¾åº¦          é«˜              ä¸­
ç¡¬ä»¶æ”¯æŒ      å¹¿æ³›            A100+
æº¢å‡ºé£é™©      é«˜              æä½
æ¨èåœºæ™¯      æ¨ç†ä¸ºä¸»        è®­ç»ƒä¸ºä¸»
</code></pre></div>

<p><strong>æ··åˆç²¾åº¦æœ€ä½³å®è·µï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># è‡ªåŠ¨æ··åˆç²¾åº¦é…ç½®</span>
<span class="kn">from</span> <span class="nn">torch.cuda.amp</span> <span class="kn">import</span> <span class="n">autocast</span><span class="p">,</span> <span class="n">GradScaler</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">GradScaler</span><span class="p">(</span>
    <span class="n">init_scale</span><span class="o">=</span><span class="mf">2.</span><span class="o">**</span><span class="mi">16</span><span class="p">,</span>  <span class="c1"># åˆå§‹ç¼©æ”¾å› å­</span>
    <span class="n">growth_factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>   <span class="c1"># å¢é•¿å› å­</span>
    <span class="n">backoff_factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># å›é€€å› å­</span>
    <span class="n">growth_interval</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>  <span class="c1"># å¢é•¿é—´éš”</span>
<span class="p">)</span>

<span class="c1"># è®­ç»ƒå¾ªç¯</span>
<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">autocast</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">):</span>  <span class="c1"># æˆ– torch.float16</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">compute_loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">])</span>

    <span class="c1"># æ¢¯åº¦ç¼©æ”¾</span>
    <span class="n">scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

    <span class="c1"># æ¢¯åº¦è£å‰ªï¼ˆåœ¨ç¼©æ”¾ç©ºé—´ï¼‰</span>
    <span class="n">scaler</span><span class="o">.</span><span class="n">unscale_</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">max_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># ä¼˜åŒ–å™¨æ­¥éª¤</span>
    <span class="n">scaler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
    <span class="n">scaler</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="c1"># ç›‘æ§æº¢å‡º</span>
    <span class="k">if</span> <span class="n">scaler</span><span class="o">.</span><span class="n">get_scale</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;æ¢¯åº¦æº¢å‡ºï¼Œå½“å‰ scale: </span><span class="si">{</span><span class="n">scaler</span><span class="o">.</span><span class="n">get_scale</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_6">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« ç³»ç»Ÿä»‹ç»äº† VLM çš„ç›‘ç£å¾®è°ƒç­–ç•¥ï¼Œæ¶µç›–äº†ä»æŒ‡ä»¤è®¾è®¡åˆ°è®­ç»ƒä¼˜åŒ–çš„å®Œæ•´æµç¨‹ï¼š</p>
<p><strong>æ ¸å¿ƒè¦ç‚¹å›é¡¾ï¼š</strong></p>
<ol>
<li><strong>æŒ‡ä»¤è®¾è®¡</strong>ï¼šæ¸…æ™°çš„æ¨¡æ¿ã€åˆç†çš„ç³»ç»Ÿæç¤ºã€å¤šè½®å¯¹è¯å¤„ç†ã€è§†è§‰-è¯­è¨€å¯¹é½</li>
<li><strong>æŸå¤±å‡½æ•°</strong>ï¼šè‡ªå›å½’æŸå¤±ã€æ©ç ç­–ç•¥ã€å¤šä»»åŠ¡å¹³è¡¡ã€grounding æŸå¤±</li>
<li><strong>PEFT æ–¹æ³•</strong>ï¼šLoRAã€QLoRAã€Adapter çš„åŸç†ä¸é€‰æ‹©</li>
<li><strong>è®­ç»ƒç¨³å®šæ€§</strong>ï¼šå­¦ä¹ ç‡è°ƒåº¦ã€æ¢¯åº¦è£å‰ªã€æƒé‡åˆå§‹åŒ–ã€checkpoint ç­–ç•¥</li>
</ol>
<p><strong>å…³é”®å…¬å¼æ±‡æ€»ï¼š</strong></p>
<ul>
<li>è¯­è¨€æ¨¡å‹æŸå¤±ï¼š$\mathcal{L}_{LM} = -\sum_{t=1}^{T} \log P(x_t | x_{&lt;t}, I)$</li>
<li>LoRA åˆ†è§£ï¼š$W' = W + BA$ï¼Œå…¶ä¸­ $r \ll \min(d, k)$</li>
<li>å¤šä»»åŠ¡æŸå¤±ï¼š$\mathcal{L}_{total} = \sum_{i=1}^{N} w_i \mathcal{L}_i$</li>
<li>ä¸ç¡®å®šæ€§åŠ æƒï¼š$\mathcal{L}_{total} = \sum_{i=1}^{N} \frac{1}{2\sigma_i^2} \mathcal{L}_i + \log \sigma_i$</li>
</ul>
<h2 id="_7">ç»ƒä¹ é¢˜</h2>
<h3 id="_8">åŸºç¡€é¢˜ï¼ˆç†è§£æ¦‚å¿µï¼‰</h3>
<p><strong>é¢˜ 1ï¼šæŒ‡ä»¤æ¨¡æ¿è®¾è®¡</strong>
è®¾è®¡ä¸€ä¸ªæ”¯æŒå¤šå›¾åƒè¾“å…¥å’Œ CoTï¼ˆChain of Thoughtï¼‰æ¨ç†çš„æŒ‡ä»¤æ¨¡æ¿ã€‚è¦æ±‚èƒ½å¤Ÿå¤„ç†å›¾åƒé—´çš„æ¯”è¾ƒä»»åŠ¡ã€‚</p>
<details markdown="1">
<summary>ğŸ’¡ æç¤º</summary>
<p>è€ƒè™‘ï¼š1) å¦‚ä½•æ ‡è®°ä¸åŒå›¾åƒ 2) CoT çš„æ­¥éª¤åˆ†éš” 3) å›¾åƒå¼•ç”¨æ–¹å¼
</details></p>
<details>
<summary>ğŸ“ å‚è€ƒç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="n">System</span><span class="o">:</span><span class="w"> </span><span class="err">ä½ æ˜¯ä¸€ä¸ªè§†è§‰æ¨ç†åŠ©æ‰‹ï¼Œè¯·ä¸€æ­¥æ­¥åˆ†æé—®é¢˜ã€‚</span>

<span class="n">User</span><span class="o">:</span><span class="w"> </span><span class="err">æ¯”è¾ƒ</span><span class="w"> </span><span class="o">&lt;</span><span class="n">image_1</span><span class="o">&gt;</span><span class="w"> </span><span class="err">å’Œ</span><span class="w"> </span><span class="o">&lt;</span><span class="n">image_2</span><span class="o">&gt;</span><span class="err">ï¼Œæ‰¾å‡ºä¸»è¦å·®å¼‚ã€‚</span><span class="n">Assistant</span><span class="o">:</span><span class="w"> </span><span class="err">è®©æˆ‘é€æ­¥åˆ†æï¼š</span>
<span class="err">æ­¥éª¤</span><span class="mi">1</span><span class="err">ï¼šè§‚å¯Ÿå›¾åƒ</span><span class="mi">1</span><span class="err">çš„ä¸»è¦å…ƒç´ </span><span class="o">...</span>
<span class="err">æ­¥éª¤</span><span class="mi">2</span><span class="err">ï¼šè§‚å¯Ÿå›¾åƒ</span><span class="mi">2</span><span class="err">çš„ä¸»è¦å…ƒç´ </span><span class="o">...</span>
<span class="err">æ­¥éª¤</span><span class="mi">3</span><span class="err">ï¼šå¯¹æ¯”å·®å¼‚</span><span class="o">...</span>
<span class="err">ç»“è®ºï¼šä¸»è¦å·®å¼‚åŒ…æ‹¬</span><span class="o">...</span>
</code></pre></div>

</details>
<p><strong>é¢˜ 2ï¼šLoRA Rank é€‰æ‹©</strong>
ç»™å®šä¸€ä¸ª 7B å‚æ•°çš„ VLMï¼Œæ˜¾å­˜é™åˆ¶ä¸º 24GBï¼Œå¦‚ä½•é€‰æ‹©åˆé€‚çš„ LoRA rankï¼Ÿè€ƒè™‘è®­ç»ƒæ•ˆç‡å’Œæ¨¡å‹æ€§èƒ½çš„æƒè¡¡ã€‚</p>
<details>
<summary>ğŸ’¡ æç¤º</summary>
<p>è®¡ç®—ä¸åŒ rank ä¸‹çš„å‚æ•°é‡å’Œæ˜¾å­˜å ç”¨ï¼Œè€ƒè™‘æ¢¯åº¦å’Œä¼˜åŒ–å™¨çŠ¶æ€</p>
</details>
<details>
<summary>ğŸ“ å‚è€ƒç­”æ¡ˆ</summary>
<p>å¯¹äº 7B æ¨¡å‹ï¼Œ24GB æ˜¾å­˜ä¸‹çš„ rank é€‰æ‹©ï¼š</p>
<ul>
<li>QLoRA 4-bit: r=64 å¯è¡Œï¼ˆ~20GBï¼‰</li>
<li>LoRA 16-bit: r=16-32 åˆé€‚ï¼ˆ~18-22GBï¼‰</li>
<li>å»ºè®®ä» r=16 å¼€å§‹ï¼Œç›‘æ§éªŒè¯é›†æ€§èƒ½ï¼Œé€æ­¥å¢åŠ åˆ° r=32</li>
</ul>
</details>
<p><strong>é¢˜ 3ï¼šå¤šä»»åŠ¡æŸå¤±å¹³è¡¡</strong>
ä¸‰ä¸ªä»»åŠ¡çš„åˆå§‹æŸå¤±åˆ†åˆ«ä¸ºï¼šå›¾åƒæè¿° 2.5ã€VQA 3.2ã€OCR 1.8ã€‚å¦‚ä½•è®¾ç½®åˆå§‹æƒé‡ï¼Ÿ</p>
<details>
<summary>ğŸ’¡ æç¤º</summary>
<p>è€ƒè™‘æŸå¤±é‡çº§å·®å¼‚å’Œä»»åŠ¡é‡è¦æ€§</p>
</details>
<details>
<summary>ğŸ“ å‚è€ƒç­”æ¡ˆ</summary>
<p>åˆå§‹æƒé‡è®¾ç½®ï¼š</p>
<ul>
<li>å›¾åƒæè¿°: 1.0 / 2.5 = 0.4</li>
<li>VQA: 1.0 / 3.2 = 0.31</li>
<li>OCR: 1.0 / 1.8 = 0.56
å½’ä¸€åŒ–åï¼š[0.32, 0.25, 0.43]</li>
</ul>
</details>
<h3 id="_9">æŒ‘æˆ˜é¢˜ï¼ˆæ·±å…¥æ€è€ƒï¼‰</h3>
<p><strong>é¢˜ 4ï¼šæ¢¯åº¦ç´¯ç§¯ç­–ç•¥</strong>
æ˜¾å­˜åªå¤Ÿ batch_size=2ï¼Œä½†æœ€ä¼˜ batch_size=32ã€‚è®¾è®¡ä¸€ä¸ªè€ƒè™‘ VLM ç‰¹æ€§çš„æ¢¯åº¦ç´¯ç§¯æ–¹æ¡ˆã€‚</p>
<details>
<summary>ğŸ’¡ æç¤º</summary>
<p>è€ƒè™‘ï¼š1) ç´¯ç§¯æ­¥æ•° 2) å­¦ä¹ ç‡ç¼©æ”¾ 3) æ¢¯åº¦è£å‰ªæ—¶æœº</p>
</details>
<details>
<summary>ğŸ“ å‚è€ƒç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="n">accumulation_steps</span> <span class="o">=</span> <span class="mi">16</span>  <span class="c1"># 2 * 16 = 32</span>
<span class="n">effective_batch_size</span> <span class="o">=</span> <span class="mi">32</span>

<span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">compute_loss</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">/</span> <span class="n">accumulation_steps</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">accumulation_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># åœ¨ç´¯ç§¯å®Œæˆåè£å‰ª</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

<span class="c1"># å­¦ä¹ ç‡çº¿æ€§ç¼©æ”¾</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">base_lr</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">effective_batch_size</span> <span class="o">/</span> <span class="n">base_batch_size</span><span class="p">)</span>
</code></pre></div>

</details>
<p><strong>é¢˜ 5ï¼šè§†è§‰ç¼–ç å™¨å¾®è°ƒå†³ç­–</strong>
æ–°ä»»åŠ¡æ˜¯åŒ»å­¦å›¾åƒåˆ†æï¼Œä¸é¢„è®­ç»ƒæ•°æ®ï¼ˆè‡ªç„¶å›¾åƒï¼‰å·®å¼‚å¾ˆå¤§ã€‚è®¾è®¡ä¸€ä¸ªæ¸è¿›å¼è§£å†»æ–¹æ¡ˆã€‚</p>
<details>
<summary>ğŸ’¡ æç¤º</summary>
<p>åŒ»å­¦å›¾åƒçš„ä½å±‚ç‰¹å¾ï¼ˆè¾¹ç¼˜ã€çº¹ç†ï¼‰å¯èƒ½ç›¸ä¼¼ï¼Œä½†é«˜å±‚è¯­ä¹‰å·®å¼‚å¤§</p>
</details>
<details>
<summary>ğŸ“ å‚è€ƒç­”æ¡ˆ</summary>
<p>ä¸‰é˜¶æ®µè§£å†»æ–¹æ¡ˆï¼š</p>
<ol>
<li>é˜¶æ®µ1ï¼ˆ0-30%ï¼‰ï¼šå†»ç»“æ‰€æœ‰å±‚ï¼Œåªè®­ç»ƒæŠ•å½±å±‚</li>
<li>é˜¶æ®µ2ï¼ˆ30-70%ï¼‰ï¼šè§£å†»å 50% å±‚ï¼Œå­¦ä¹ ç‡ 0.1x</li>
<li>é˜¶æ®µ3ï¼ˆ70-100%ï¼‰ï¼šå…¨éƒ¨è§£å†»ï¼Œå‰ 50% å±‚ç”¨ 0.01x å­¦ä¹ ç‡ï¼Œå 50% ç”¨ 0.1x
ç†ç”±ï¼šä¿ç•™ä½å±‚é€šç”¨ç‰¹å¾ï¼Œé‡ç‚¹è°ƒæ•´é«˜å±‚è¯­ä¹‰ç†è§£</li>
</ol>
</details>
<p><strong>é¢˜ 6ï¼šè®­ç»ƒå´©æºƒè¯Šæ–­</strong>
è®­ç»ƒåˆ° 40% æ—¶æŸå¤±çªç„¶å˜æˆ NaNã€‚ç»™å‡ºç³»ç»Ÿçš„æ’æŸ¥æµç¨‹å’Œå¯èƒ½åŸå› ã€‚</p>
<details>
<summary>ğŸ’¡ æç¤º</summary>
<p>ä»æ•°æ®ã€æ¨¡å‹ã€ä¼˜åŒ–å™¨ä¸‰ä¸ªè§’åº¦æ’æŸ¥</p>
</details>
<details>
<summary>ğŸ“ å‚è€ƒç­”æ¡ˆ</summary>
<p>æ’æŸ¥æµç¨‹ï¼š</p>
<ol>
<li>
<p><strong>æ•°æ®æ£€æŸ¥</strong>ï¼š
   - æ˜¯å¦æœ‰æŸåå›¾åƒï¼ˆå…¨é»‘ã€å…¨ç™½ï¼‰
   - æ ‡ç­¾æ˜¯å¦æœ‰å¼‚å¸¸å€¼
   - Token ID æ˜¯å¦è¶…å‡ºè¯è¡¨èŒƒå›´</p>
</li>
<li>
<p><strong>æ¢¯åº¦ç›‘æ§</strong>ï¼š
   - æ£€æŸ¥æ¢¯åº¦èŒƒæ•°å†å²
   - å®šä½ç¬¬ä¸€ä¸ª NaN å‡ºç°çš„å±‚
   - æŸ¥çœ‹è¯¥ batch çš„å…·ä½“æ•°æ®</p>
</li>
<li>
<p><strong>å¯èƒ½åŸå› åŠè§£å†³</strong>ï¼š
   - å­¦ä¹ ç‡è¿‡å¤§ â†’ é™ä½å­¦ä¹ ç‡
   - é™¤é›¶é”™è¯¯ â†’ æ·»åŠ  epsilon
   - FP16 æº¢å‡º â†’ åˆ‡æ¢åˆ° BF16 æˆ–å¢å¤§ loss scale
   - æŸå±‚æœªåˆå§‹åŒ– â†’ æ£€æŸ¥æ–°å¢æ¨¡å—</p>
</li>
</ol>
</details>
<p><strong>é¢˜ 7ï¼šPEFT ç»„åˆä¼˜åŒ–</strong>
è®¾è®¡ä¸€ä¸ªé’ˆå¯¹ VLM ä¸åŒç»„ä»¶çš„æ··åˆ PEFT ç­–ç•¥ï¼Œç›®æ ‡æ˜¯åœ¨ 16GB æ˜¾å­˜é™åˆ¶ä¸‹æœ€å¤§åŒ–æ€§èƒ½ã€‚</p>
<details>
<summary>ğŸ’¡ æç¤º</summary>
<p>ä¸åŒç»„ä»¶çš„é‡è¦æ€§å’Œå‚æ•°é‡ä¸åŒ</p>
</details>
<details>
<summary>ğŸ“ å‚è€ƒç­”æ¡ˆ</summary>
<p>æ··åˆç­–ç•¥ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;vision_encoder&quot;</span><span class="p">:</span> <span class="s2">&quot;frozen&quot;</span><span class="p">,</span>         <span class="c1"># çœæ˜¾å­˜</span>
    <span class="s2">&quot;vision_projection&quot;</span><span class="p">:</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span>        <span class="c1"># å…³é”®ç»„ä»¶ï¼Œå‚æ•°å°‘</span>
    <span class="s2">&quot;llm_embed&quot;</span><span class="p">:</span> <span class="s2">&quot;frozen&quot;</span><span class="p">,</span>              <span class="c1"># è¯åµŒå…¥ä¸åŠ¨</span>
    <span class="s2">&quot;llm_layers[0:8]&quot;</span><span class="p">:</span> <span class="s2">&quot;lora_r8&quot;</span><span class="p">,</span>      <span class="c1"># åº•å±‚å° rank</span>
    <span class="s2">&quot;llm_layers[8:24]&quot;</span><span class="p">:</span> <span class="s2">&quot;lora_r16&quot;</span><span class="p">,</span>    <span class="c1"># ä¸­å±‚ä¸­ rank</span>
    <span class="s2">&quot;llm_layers[24:32]&quot;</span><span class="p">:</span> <span class="s2">&quot;lora_r32&quot;</span><span class="p">,</span>   <span class="c1"># é«˜å±‚å¤§ rank</span>
    <span class="s2">&quot;llm_head&quot;</span><span class="p">:</span> <span class="s2">&quot;lora_r8&quot;</span><span class="p">,</span>             <span class="c1"># è¾“å‡ºå¤´å° rank</span>
<span class="p">}</span>
</code></pre></div>

<p>é¢„è®¡æ˜¾å­˜ï¼š~14GBï¼Œå¯è®­ç»ƒå‚æ•°ï¼š~200M</p>
</details>
<p><strong>é¢˜ 8ï¼šå¼€æ”¾æ€§æ€è€ƒ</strong>
å¦‚æœè¦è®¾è®¡ä¸‹ä¸€ä»£ VLM çš„ SFT ç­–ç•¥ï¼Œä½ è®¤ä¸ºæœ€éœ€è¦æ”¹è¿›çš„ä¸‰ä¸ªæ–¹å‘æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<details>
<summary>ğŸ’¡ æç¤º</summary>
<p>æ€è€ƒå½“å‰æ–¹æ³•çš„å±€é™æ€§å’Œå®é™…åº”ç”¨éœ€æ±‚</p>
</details>
<details>
<summary>ğŸ“ å‚è€ƒç­”æ¡ˆ</summary>
<p>ä¸‰ä¸ªæ”¹è¿›æ–¹å‘ï¼š</p>
<ol>
<li><strong>åŠ¨æ€è®¡ç®—åˆ†é…</strong>ï¼šæ ¹æ®å›¾åƒå¤æ‚åº¦åŠ¨æ€è°ƒæ•´è®¡ç®—èµ„æºï¼Œç®€å•å›¾åƒç”¨å°‘é‡ tokenï¼Œå¤æ‚å›¾åƒç”¨æ›´å¤š</li>
<li><strong>ä¸»åŠ¨å­¦ä¹ </strong>ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­è‡ªåŠ¨è¯†åˆ«æ¨¡å‹è–„å¼±ç¯èŠ‚ï¼ŒåŠ¨æ€è°ƒæ•´æ•°æ®é‡‡æ ·ç­–ç•¥</li>
<li><strong>è·¨æ¨¡æ€ä¸€è‡´æ€§</strong>ï¼šè®¾è®¡æ›´å¥½çš„å¯¹é½æœºåˆ¶ï¼Œç¡®ä¿è§†è§‰ç†è§£å’Œè¯­è¨€ç”Ÿæˆçš„ä¸€è‡´æ€§ï¼Œå‡å°‘å¹»è§‰</li>
</ol>
<p>ç†ç”±ï¼šå½“å‰ SFT ç­–ç•¥è¾ƒä¸ºé™æ€ï¼Œæ²¡æœ‰å……åˆ†åˆ©ç”¨æ¨¡å‹çš„è‡ªé€‚åº”èƒ½åŠ›</p>
</details>
<h2 id="gotchas">å¸¸è§é™·é˜±ä¸é”™è¯¯ (Gotchas)</h2>
<h3 id="_10">æ•°æ®ç›¸å…³é™·é˜±</h3>
<ol>
<li><strong>å›¾åƒ Token è®¡ç®—é”™è¯¯</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># é”™è¯¯ï¼šå¿˜è®°å›¾åƒ token å ç”¨</span>
<span class="n">max_length</span> <span class="o">=</span> <span class="mi">2048</span>  <span class="c1"># ä»¥ä¸ºæœ‰ 2048 ä¸ªæ–‡æœ¬ token</span>

<span class="c1"># æ­£ç¡®ï¼šæ‰£é™¤å›¾åƒå ç”¨</span>
<span class="n">image_tokens</span> <span class="o">=</span> <span class="mi">576</span>  <span class="c1"># ViT-L/14 </span>
<span class="n">text_budget</span> <span class="o">=</span> <span class="mi">2048</span> <span class="o">-</span> <span class="n">image_tokens</span>  <span class="c1"># å®é™…åªæœ‰ 1472</span>
</code></pre></div>

<ol start="2">
<li><strong>å“åº”æˆªæ–­é—®é¢˜</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># é™·é˜±ï¼šå“åº”è¢«æˆªæ–­ä½†ä»è®¡ç®—æŸå¤±</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_length</span><span class="p">:</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="n">max_length</span><span class="p">]</span>  <span class="c1"># å¯èƒ½æˆªæ–­åˆ°å“åº”ä¸­é—´</span>

<span class="c1"># è§£å†³ï¼šç¡®ä¿å®Œæ•´å“åº”æˆ–ä¸è®¡ç®—æŸå¤±</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_length</span><span class="p">:</span>
    <span class="c1"># æ‰¾åˆ°æœ€åä¸€ä¸ªå®Œæ•´å¥å­</span>
    <span class="n">last_period</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="n">max_length</span><span class="p">]</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">period_token_id</span><span class="p">)</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="n">last_period</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>

<h3 id="_11">è®­ç»ƒç›¸å…³é™·é˜±</h3>
<ol start="3">
<li><strong>LoRA ä¸æ­£åˆ™åŒ–å†²çª</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># é™·é˜±ï¼šå¯¹ LoRA å‚æ•°ä½¿ç”¨ weight decay</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">AdamW</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

<span class="c1"># æ­£ç¡®ï¼šLoRA å‚æ•°ä¸ç”¨ weight decay</span>
<span class="n">lora_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;lora&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">]</span>
<span class="n">other_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;lora&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">n</span><span class="p">]</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">AdamW</span><span class="p">([</span>
    <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">lora_params</span><span class="p">,</span> <span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">other_params</span><span class="p">,</span> <span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">}</span>
<span class="p">])</span>
</code></pre></div>

<ol start="4">
<li><strong>æ··åˆç²¾åº¦çš„ NaN é™·é˜±</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># é™·é˜±ï¼šæŸäº›æ“ä½œåœ¨ FP16 ä¸‹ä¸ç¨³å®š</span>
<span class="n">attention_scores</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">@</span> <span class="n">K</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">d_k</span><span class="p">)</span>  <span class="c1"># å¯èƒ½æº¢å‡º</span>

<span class="c1"># è§£å†³ï¼šå…³é”®æ“ä½œç”¨ FP32</span>
<span class="k">with</span> <span class="n">autocast</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">attention_scores</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">@</span> <span class="n">K</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">d_k</span><span class="p">)</span>
</code></pre></div>

<ol start="5">
<li><strong>æ¢¯åº¦ç´¯ç§¯ä¸ Batch Norm</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># é™·é˜±ï¼šæ¢¯åº¦ç´¯ç§¯æ—¶ BN ç»Ÿè®¡ä¸å‡†</span>
<span class="c1"># BN åªçœ‹å½“å‰ micro-batchï¼Œä¸æ˜¯å®Œæ•´ batch</span>

<span class="c1"># è§£å†³ï¼šä½¿ç”¨ Layer Norm æˆ– RMSNorm</span>
<span class="c1"># æˆ–è€…åŒæ­¥ BNï¼ˆä½†ä¼šå¢åŠ é€šä¿¡å¼€é”€ï¼‰</span>
</code></pre></div>

<h3 id="_12">è¯„ä¼°ç›¸å…³é™·é˜±</h3>
<ol start="6">
<li><strong>ç”Ÿæˆé•¿åº¦åå·®</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># é™·é˜±ï¼šä¸åŒé•¿åº¦çš„ç”Ÿæˆå½±å“è¯„ä¼°</span>
<span class="c1"># çŸ­å›ç­”å¯èƒ½ perplexity æ›´ä½ä½†ä¿¡æ¯ä¸è¶³</span>

<span class="c1"># è§£å†³ï¼šæ§åˆ¶ç”Ÿæˆé•¿åº¦æˆ–ä½¿ç”¨é•¿åº¦å½’ä¸€åŒ–</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">log_prob</span> <span class="o">/</span> <span class="p">(</span><span class="n">length</span> <span class="o">**</span> <span class="n">alpha</span><span class="p">)</span>  <span class="c1"># alpha ~ 0.6-0.8</span>
</code></pre></div>

<ol start="7">
<li><strong>Teacher Forcing ä¸æ¨ç†ä¸ä¸€è‡´</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># è®­ç»ƒæ—¶ï¼šæ¯æ­¥éƒ½ç”¨çœŸå®æ ‡ç­¾</span>
<span class="c1"># æ¨ç†æ—¶ï¼šç”¨è‡ªå·±çš„é¢„æµ‹ï¼Œè¯¯å·®ç´¯ç§¯</span>

<span class="c1"># ç¼“è§£ï¼šScheduled Sampling</span>
<span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">teacher_forcing_ratio</span><span class="p">:</span>
    <span class="n">input_token</span> <span class="o">=</span> <span class="n">ground_truth</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">input_token</span> <span class="o">=</span> <span class="n">predicted</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>

<h3 id="_13">è°ƒè¯•æŠ€å·§</h3>
<p><strong>å¿«é€Ÿè¯Šæ–­æ£€æŸ¥ç‚¹ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. æ£€æŸ¥æ¢¯åº¦</span>
python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import torch; ckpt=torch.load(&#39;model.pt&#39;); print([(k,v.abs().max().item()) for k,v in ckpt[&#39;grad_dict&#39;].items() if v.abs().max() &gt; 100])&quot;</span>

<span class="c1"># 2. æ£€æŸ¥æƒé‡åˆ†å¸ƒ</span>
python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import torch; ckpt=torch.load(&#39;model.pt&#39;); print([(k, v.std().item()) for k,v in ckpt[&#39;model_state_dict&#39;].items() if &#39;weight&#39; in k])&quot;</span>

<span class="c1"># 3. æ£€æŸ¥æŸå¤±å†å²</span>
python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import torch; import matplotlib.pyplot as plt; ckpt=torch.load(&#39;model.pt&#39;); plt.plot(ckpt[&#39;loss_history&#39;]); plt.show()&quot;</span>
</code></pre></div>

<h2 id="_14">æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_15">è®­ç»ƒå‰å‡†å¤‡</h3>
<ul>
<li>[ ] <strong>æ•°æ®éªŒè¯</strong></li>
<li>[ ] æ‰€æœ‰å›¾åƒå¯æ­£å¸¸åŠ è½½</li>
<li>[ ] å›¾åƒå°ºå¯¸åˆ†å¸ƒåˆç†ï¼ˆæ²¡æœ‰æç«¯å¤§/å°ï¼‰</li>
<li>[ ] æ–‡æœ¬é•¿åº¦åˆ†å¸ƒæ£€æŸ¥</li>
<li>
<p>[ ] ç‰¹æ®Šå­—ç¬¦æ­£ç¡®è½¬ä¹‰</p>
</li>
<li>
<p>[ ] <strong>æ¨¡å‹é…ç½®</strong></p>
</li>
<li>[ ] å›¾åƒ token æ•°è®¡ç®—æ­£ç¡®</li>
<li>[ ] ä¸Šä¸‹æ–‡é•¿åº¦è®¾ç½®åˆç†</li>
<li>[ ] LoRA rank æ ¹æ®æ˜¾å­˜é€‰æ‹©</li>
<li>
<p>[ ] æ£€æŸ¥ç‚¹ä¿å­˜è·¯å¾„å¯å†™</p>
</li>
<li>
<p>[ ] <strong>è®­ç»ƒé…ç½®</strong></p>
</li>
<li>[ ] å­¦ä¹ ç‡è®¾ç½®ï¼ˆé€šå¸¸ 1e-4 åˆ° 5e-4ï¼‰</li>
<li>[ ] Warmup æ­¥æ•°ï¼ˆå»ºè®® 3-10% æ€»æ­¥æ•°ï¼‰</li>
<li>[ ] æ¢¯åº¦è£å‰ªé˜ˆå€¼ï¼ˆé€šå¸¸ 1.0ï¼‰</li>
<li>[ ] æ··åˆç²¾åº¦è®¾ç½®ï¼ˆBF16 ä¼˜äº FP16ï¼‰</li>
</ul>
<h3 id="_16">è®­ç»ƒä¸­ç›‘æ§</h3>
<ul>
<li>[ ] <strong>æ€§èƒ½æŒ‡æ ‡</strong></li>
<li>[ ] GPU åˆ©ç”¨ç‡ &gt; 90%</li>
<li>[ ] æ˜¾å­˜ä½¿ç”¨ç¨³å®šï¼ˆæ— æ³„æ¼ï¼‰</li>
<li>[ ] è®­ç»ƒé€Ÿåº¦ï¼ˆsamples/secï¼‰ç¨³å®š</li>
<li>
<p>[ ] æ•°æ®åŠ è½½ä¸æ˜¯ç“¶é¢ˆ</p>
</li>
<li>
<p>[ ] <strong>æ¨¡å‹æŒ‡æ ‡</strong></p>
</li>
<li>[ ] æŸå¤±å¹³ç¨³ä¸‹é™</li>
<li>[ ] æ¢¯åº¦èŒƒæ•°ç¨³å®š</li>
<li>[ ] å­¦ä¹ ç‡æŒ‰è®¡åˆ’è¡°å‡</li>
<li>
<p>[ ] éªŒè¯é›†æŒ‡æ ‡æå‡</p>
</li>
<li>
<p>[ ] <strong>å¼‚å¸¸æ£€æµ‹</strong></p>
</li>
<li>[ ] æ—  NaN/Inf å‡ºç°</li>
<li>[ ] æ— æ¢¯åº¦çˆ†ç‚¸/æ¶ˆå¤±</li>
<li>[ ] æƒé‡æ›´æ–°å¹…åº¦åˆç†</li>
<li>[ ] ç”Ÿæˆæ ·æœ¬è´¨é‡æ£€æŸ¥</li>
</ul>
<h3 id="_17">è®­ç»ƒåéªŒè¯</h3>
<ul>
<li>[ ] <strong>æ¨¡å‹è´¨é‡</strong></li>
<li>[ ] åŸºç¡€èƒ½åŠ›ä¿æŒï¼ˆæ²¡æœ‰ç¾éš¾æ€§é—å¿˜ï¼‰</li>
<li>[ ] æ–°ä»»åŠ¡æ€§èƒ½è¾¾æ ‡</li>
<li>[ ] ç”Ÿæˆå¤šæ ·æ€§é€‚ä¸­</li>
<li>
<p>[ ] æ— æ˜æ˜¾åè§æˆ–æœ‰å®³è¾“å‡º</p>
</li>
<li>
<p>[ ] <strong>éƒ¨ç½²å‡†å¤‡</strong></p>
</li>
<li>[ ] æ¨¡å‹å¯æ­£ç¡®åŠ è½½</li>
<li>[ ] æ¨ç†é€Ÿåº¦æ»¡è¶³è¦æ±‚</li>
<li>[ ] é‡åŒ–åç²¾åº¦æŸå¤±å¯æ¥å—</li>
<li>
<p>[ ] è¾¹ç•Œcaseæµ‹è¯•é€šè¿‡</p>
</li>
<li>
<p>[ ] <strong>æ–‡æ¡£å®Œå–„</strong></p>
</li>
<li>[ ] è®­ç»ƒé…ç½®è®°å½•</li>
<li>[ ] æ•°æ®é›†ç‰ˆæœ¬è®°å½•</li>
<li>[ ] æ€§èƒ½åŸºå‡†è®°å½•</li>
<li>[ ] å·²çŸ¥é—®é¢˜è®°å½•</li>
</ul>
<h3 id="_18">é—®é¢˜æ’æŸ¥é¡ºåº</h3>
<p>é‡åˆ°é—®é¢˜æ—¶ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæ’æŸ¥ï¼š</p>
<ol>
<li>
<p><strong>æ•°æ®é—®é¢˜</strong>ï¼ˆ50% çš„é—®é¢˜æ¥æºï¼‰
   - æ£€æŸ¥å½“å‰ batch çš„æ•°æ®
   - éªŒè¯æ•°æ®é¢„å¤„ç†æµç¨‹</p>
</li>
<li>
<p><strong>é…ç½®é—®é¢˜</strong>ï¼ˆ30% çš„é—®é¢˜æ¥æºï¼‰
   - å­¦ä¹ ç‡æ˜¯å¦è¿‡å¤§
   - Batch size æ˜¯å¦åˆé€‚</p>
</li>
<li>
<p><strong>ä»£ç é—®é¢˜</strong>ï¼ˆ20% çš„é—®é¢˜æ¥æºï¼‰
   - æ˜¯å¦æœ‰ç»´åº¦ä¸åŒ¹é…
   - æ˜¯å¦æœ‰æœªåˆå§‹åŒ–çš„å‚æ•°</p>
</li>
</ol>
<hr />
<p><em>é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œæ‚¨åº”è¯¥å·²ç»æŒæ¡äº† VLM ç›‘ç£å¾®è°ƒçš„æ ¸å¿ƒæŠ€æœ¯ã€‚ä¸‹ä¸€ç« æˆ‘ä»¬å°†æ¢è®¨åˆ†å¸ƒå¼è®­ç»ƒä¸ä¼˜åŒ–ï¼Œè¿›ä¸€æ­¥æå‡è®­ç»ƒæ•ˆç‡ã€‚</em></p>
<p><a href="index.html">â† è¿”å›ç›®å½•</a> | <a href="chapter4.html">ä¸‹ä¸€ç« ï¼šåˆ†å¸ƒå¼è®­ç»ƒä¸ä¼˜åŒ– â†’</a></p>
            </article>
            
            <nav class="page-nav"><a href="chapter2.html" class="nav-link prev">â† ç¬¬ 2 ç« ï¼šæ•°æ®å‡†å¤‡ä¸é¢„å¤„ç†</a><a href="chapter4.html" class="nav-link next">ç¬¬ 4 ç« ï¼šåˆ†å¸ƒå¼è®­ç»ƒä¸ä¼˜åŒ– â†’</a></nav>
        </main>
    </div>
</body>
</html>