<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>第 7 章：评估体系设计</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>目录</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="搜索..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">视觉语言模型（VLM）的监督微调与强化学习实战教程</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 1 章：VLM 架构与原理</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 2 章：数据准备与预处理</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 3 章：SFT 训练策略</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 4 章：分布式训练与优化</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 5 章：RLHF 基础与实现</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 6 章：直接偏好优化（DPO）</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 7 章：评估体系设计</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 8 章：模型部署与服务化</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 9 章：CUDA OOM 调试完全指南</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 10 章：训练崩溃与 NaN 问题</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 11 章：训练速度优化实战</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 12 章：多机多卡调试地狱</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="7">第 7 章：评估体系设计</h1>
<p>评估是 VLM 开发周期中最关键却又最容易被忽视的环节。一个精心设计的评估体系不仅能准确衡量模型性能，更能指导训练优化方向、发现潜在问题、支撑产品决策。本章将从基准测试选择、指标设计、人工评估组织到在线 A/B 测试，构建一套完整的 VLM 评估方法论。我们将特别关注多模态特有的评估挑战，如幻觉检测、跨模态一致性验证等实际问题。</p>
<h2 id="71">7.1 多模态基准测试介绍</h2>
<h3 id="711">7.1.1 主流基准测试概览</h3>
<p>VLM 的评估基准可分为三大类：</p>
<p><strong>通用能力评估基准</strong></p>
<div class="codehilite"><pre><span></span><code>┌─────────────────┬──────────────┬─────────────┬──────────────┐
│     基准名称     │   任务类型    │  数据规模   │    特点      │
├─────────────────┼──────────────┼─────────────┼──────────────┤
│ MMBench         │ 多选题       │ 3000题      │ 循环评估     │
│ SEED-Bench      │ 多选题       │ 19K题       │ 多维度覆盖   │
│ MME             │ 是/否判断    │ 14个子任务  │ 感知+认知    │
│ MMMU            │ 多选题       │ 11.5K题     │ 学科知识     │
│ MathVista       │ 数学推理     │ 6K题        │ 数学图表     │
└─────────────────┴──────────────┴─────────────┴──────────────┘
</code></pre></div>

<p><strong>领域特定评估</strong></p>
<ol>
<li>
<p><strong>OCR 相关</strong>
   - TextVQA：场景文字理解
   - OCRBench：综合 OCR 能力
   - DocVQA：文档理解</p>
</li>
<li>
<p><strong>视觉问答（VQA）</strong>
   - VQAv2：通用视觉问答
   - GQA：组合推理
   - OK-VQA：需要外部知识</p>
</li>
<li>
<p><strong>图像描述（Caption）</strong>
   - COCO Caption：通用场景描述
   - NoCaps：新物体描述
   - TextCaps：包含文字的图像描述</p>
</li>
</ol>
<h3 id="712">7.1.2 基准测试的选择策略</h3>
<p>选择合适的评估基准需要考虑多个维度：</p>
<div class="codehilite"><pre><span></span><code>评估维度矩阵：
          ┌────────────────────────────────┐
          │         应用场景需求            │
          ├────────────────────────────────┤
          │  对话 │ OCR │ 推理 │ 创作    │
┌─────────┼───────┼─────┼──────┼──────────┤
│基础能力 │  ✓    │     │      │          │ → MMBench, SEED
│专业知识 │       │     │  ✓   │          │ → MMMU, MathVista  
│文字识别 │       │  ✓  │      │          │ → TextVQA, OCRBench
│内容生成 │       │     │      │    ✓     │ → COCO Caption
└─────────┴───────┴─────┴──────┴──────────┘
</code></pre></div>

<p><strong>选择原则：</strong></p>
<ol>
<li><strong>覆盖性原则</strong>：至少包含 2-3 个通用基准 + 2-3 个领域基准</li>
<li><strong>代表性原则</strong>：选择社区认可度高、更新维护好的基准</li>
<li><strong>可比性原则</strong>：选择有充分 baseline 结果的基准</li>
<li><strong>效率原则</strong>：平衡评估全面性和计算成本</li>
</ol>
<h3 id="713">7.1.3 评估数据泄露问题</h3>
<p>数据泄露是当前 VLM 评估面临的严重问题：</p>
<p><strong>泄露检测方法：</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 示例：检测训练数据与测试集的重叠</span>
<span class="k">def</span> <span class="nf">detect_data_leakage</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
    <span class="c1"># 1. 图像级别检测（感知哈希）</span>
    <span class="n">train_hashes</span> <span class="o">=</span> <span class="n">compute_perceptual_hashes</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>
    <span class="n">test_hashes</span> <span class="o">=</span> <span class="n">compute_perceptual_hashes</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>
    <span class="n">image_overlap</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_hashes</span> <span class="o">&amp;</span> <span class="n">test_hashes</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_hashes</span><span class="p">)</span>

    <span class="c1"># 2. 文本级别检测（n-gram 重叠）</span>
    <span class="n">train_ngrams</span> <span class="o">=</span> <span class="n">extract_ngrams</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">texts</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">test_ngrams</span> <span class="o">=</span> <span class="n">extract_ngrams</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">texts</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">text_overlap</span> <span class="o">=</span> <span class="n">jaccard_similarity</span><span class="p">(</span><span class="n">train_ngrams</span><span class="p">,</span> <span class="n">test_ngrams</span><span class="p">)</span>

    <span class="c1"># 3. 语义级别检测（embedding 相似度）</span>
    <span class="n">semantic_sim</span> <span class="o">=</span> <span class="n">compute_semantic_similarity</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;image_overlap&#39;</span><span class="p">:</span> <span class="n">image_overlap</span><span class="p">,</span>
        <span class="s1">&#39;text_overlap&#39;</span><span class="p">:</span> <span class="n">text_overlap</span><span class="p">,</span>
        <span class="s1">&#39;semantic_similarity&#39;</span><span class="p">:</span> <span class="n">semantic_sim</span>
    <span class="p">}</span>
</code></pre></div>

<p><strong>防泄露策略：</strong></p>
<ol>
<li><strong>时间切分</strong>：使用模型训练后发布的测试集</li>
<li><strong>私有测试集</strong>：维护不公开的评估数据</li>
<li><strong>动态生成</strong>：实时生成评估样本</li>
<li><strong>对抗样本</strong>：加入轻微扰动检测记忆</li>
</ol>
<h2 id="72">7.2 自动评估指标设计</h2>
<h3 id="721">7.2.1 传统指标的局限性</h3>
<p>传统 NLP 指标在 VLM 评估中存在明显不足：</p>
<div class="codehilite"><pre><span></span><code>问题示例：
输入图像：[一只棕色的狗在草地上奔跑]
模型输出：&quot;一只金毛犬在绿色草坪上跑步&quot;
参考答案：&quot;一只棕色的狗在草地上奔跑&quot;

BLEU-4: 0.31 （低分，但语义正确）
人类评分：4.5/5 （高分，认为描述准确）

→ 指标与人类判断严重不一致
</code></pre></div>

<p><strong>局限性分析：</strong></p>
<ol>
<li><strong>语义等价性</strong>：无法识别同义表达</li>
<li><strong>模态对齐</strong>：忽略视觉信息的准确性</li>
<li><strong>部分正确性</strong>：无法评估部分正确的答案</li>
<li><strong>创造性惩罚</strong>：对合理但不同的表达给予低分</li>
</ol>
<h3 id="722">7.2.2 基于模型的评估</h3>
<p>使用强大的语言模型（如 GPT-4V）作为自动评判者：</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># GPT-4V 评估框架示例</span>
<span class="k">class</span> <span class="nc">ModelBasedEvaluator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">judge_model</span><span class="o">=</span><span class="s2">&quot;gpt-4-vision&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">judge</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">judge_model</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">model_answer</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        请评估模型回答的质量（1-5分）：</span>

<span class="s2">        评估维度：</span>

<span class="s2">        1. 事实准确性：回答是否与图像内容一致</span>
<span class="s2">        2. 完整性：是否充分回答了问题</span>
<span class="s2">        3. 相关性：回答是否切题</span>
<span class="s2">        4. 清晰度：表达是否清楚易懂</span>

<span class="s2">        图像：[图像]</span>
<span class="s2">        问题：</span><span class="si">{</span><span class="n">question</span><span class="si">}</span>
<span class="s2">        模型回答：</span><span class="si">{</span><span class="n">model_answer</span><span class="si">}</span>
<span class="s2">        </span><span class="si">{</span><span class="s2">&quot;参考答案：&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span>

<span class="s2">        请给出：</span>

<span class="s2">        - 总分（1-5）</span>
<span class="s2">        - 各维度得分</span>
<span class="s2">        - 评价理由</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">judge</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</code></pre></div>

<p><strong>优势与挑战：</strong></p>
<p>优势：</p>
<ul>
<li>更接近人类判断</li>
<li>可解释性强</li>
<li>灵活适应不同任务</li>
</ul>
<p>挑战：</p>
<ul>
<li>评估成本高</li>
<li>可能存在偏见</li>
<li>一致性问题</li>
</ul>
<h3 id="723">7.2.3 任务特定指标设计</h3>
<p>针对不同任务设计专门的评估指标：</p>
<ol>
<li><strong>幻觉检测指标</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># CHAIR (Caption Hallucination Assessment with Image Relevance)</span>
<span class="k">def</span> <span class="nf">calculate_chair</span><span class="p">(</span><span class="n">generated_caption</span><span class="p">,</span> <span class="n">image_objects</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    计算描述中的幻觉率</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mentioned_objects</span> <span class="o">=</span> <span class="n">extract_objects</span><span class="p">(</span><span class="n">generated_caption</span><span class="p">)</span>

    <span class="c1"># 句子级幻觉率</span>
    <span class="n">hallucinated_sentences</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_sentences</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">generated_caption</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">generated_caption</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="n">sentence_objects</span> <span class="o">=</span> <span class="n">extract_objects</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">image_objects</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">sentence_objects</span><span class="p">):</span>
            <span class="n">hallucinated_sentences</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">chairs</span> <span class="o">=</span> <span class="n">hallucinated_sentences</span> <span class="o">/</span> <span class="n">total_sentences</span>

    <span class="c1"># 物体级幻觉率</span>
    <span class="n">hallucinated_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">mentioned_objects</span> 
                               <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">image_objects</span><span class="p">])</span>
    <span class="n">chairi</span> <span class="o">=</span> <span class="n">hallucinated_objects</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mentioned_objects</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;CHAIRs&#39;</span><span class="p">:</span> <span class="n">chairs</span><span class="p">,</span> <span class="s1">&#39;CHAIRi&#39;</span><span class="p">:</span> <span class="n">chairi</span><span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>空间理解指标</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">evaluate_spatial_understanding</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    评估模型的空间关系理解能力</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spatial_relations</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;左&#39;</span><span class="p">,</span> <span class="s1">&#39;右&#39;</span><span class="p">,</span> <span class="s1">&#39;上&#39;</span><span class="p">,</span> <span class="s1">&#39;下&#39;</span><span class="p">,</span> <span class="s1">&#39;前&#39;</span><span class="p">,</span> <span class="s1">&#39;后&#39;</span><span class="p">,</span> <span class="s1">&#39;内&#39;</span><span class="p">,</span> <span class="s1">&#39;外&#39;</span><span class="p">]</span>

    <span class="n">correct_relations</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_relations</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">spatial_relations</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">ground_truth</span><span class="p">:</span>
            <span class="n">total_relations</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">check_spatial_relation</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span> <span class="n">relation</span><span class="p">):</span>
                <span class="n">correct_relations</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">correct_relations</span> <span class="o">/</span> <span class="n">total_relations</span> <span class="k">if</span> <span class="n">total_relations</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</code></pre></div>

<ol start="3">
<li><strong>指令遵循度指标</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">instruction_following_score</span><span class="p">(</span><span class="n">instruction</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    评估模型对指令的遵循程度</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">requirements</span> <span class="o">=</span> <span class="n">parse_requirements</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>

    <span class="n">scores</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;format_compliance&#39;</span><span class="p">:</span> <span class="n">check_format</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">requirements</span><span class="o">.</span><span class="n">format</span><span class="p">),</span>
        <span class="s1">&#39;length_compliance&#39;</span><span class="p">:</span> <span class="n">check_length</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">requirements</span><span class="o">.</span><span class="n">length</span><span class="p">),</span>
        <span class="s1">&#39;content_coverage&#39;</span><span class="p">:</span> <span class="n">check_content</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">requirements</span><span class="o">.</span><span class="n">topics</span><span class="p">),</span>
        <span class="s1">&#39;constraint_satisfaction&#39;</span><span class="p">:</span> <span class="n">check_constraints</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">requirements</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
</code></pre></div>

<h3 id="724">7.2.4 多维度评估框架</h3>
<p>构建综合评估体系，从多个角度全面评估模型：</p>
<div class="codehilite"><pre><span></span><code>评估维度体系：
                    ┌─────────────┐
                    │  VLM 评估   │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐      ┌─────▼─────┐     ┌─────▼─────┐
   │基础能力 │      │ 高级能力  │     │ 安全对齐  │
   └────┬────┘      └─────┬─────┘     └─────┬─────┘
        │                  │                  │

   - 物体识别         - 推理能力         - 有害内容过滤
   - 属性理解         - 创造性           - 偏见检测
   - 关系理解         - 知识运用         - 隐私保护
   - 计数能力         - 多轮对话         - 事实性
</code></pre></div>

<h2 id="73">7.3 人工评估的组织与分析</h2>
<h3 id="731">7.3.1 评估任务设计原则</h3>
<p>设计高质量的人工评估任务需要遵循以下原则：</p>
<ol>
<li><strong>明确性原则</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>❌ 模糊指令：
&quot;评估这个回答的质量&quot;

✅ 明确指令：
&quot;根据以下标准评估回答质量：

1. 事实准确性（0-2分）：描述是否与图像内容一致
2. 完整性（0-2分）：是否包含所有重要信息
3. 流畅性（0-1分）：语言是否通顺自然&quot;
</code></pre></div>

<ol start="2">
<li><strong>可测量性原则</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># 设计可量化的评估标准</span>
<span class="n">evaluation_rubric</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;事实准确性&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;包含明显错误信息&quot;</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;基本正确但有小错误&quot;</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;完全准确&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;相关性&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;答非所问&quot;</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;部分相关&quot;</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;高度相关&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ol start="3">
<li><strong>代表性原则</strong></li>
</ol>
<p>样本选择应覆盖：</p>
<ul>
<li>不同难度级别</li>
<li>各种图像类型（自然场景、图表、文档等）</li>
<li>多样化的问题类型</li>
<li>边界案例和困难样本</li>
</ul>
<h3 id="732">7.3.2 标注指南制定</h3>
<p>完善的标注指南是保证评估质量的关键：</p>
<div class="codehilite"><pre><span></span><code><span class="gh"># VLM 输出评估标注指南</span>

<span class="gu">## 1. 评估维度定义</span>

<span class="gu">### 1.1 事实准确性（Factual Accuracy）</span>
<span class="gs">**定义**</span>：模型输出与图像内容的一致程度

<span class="gs">**评分标准**</span>：

<span class="k">-</span><span class="w"> </span><span class="gs">**优秀(3分)**</span>：所有描述完全准确，无任何事实错误
<span class="k">-</span><span class="w"> </span><span class="gs">**良好(2分)**</span>：主要信息正确，存在minor细节错误
<span class="k">-</span><span class="w"> </span><span class="gs">**一般(1分)**</span>：部分信息正确，但有明显错误
<span class="k">-</span><span class="w"> </span><span class="gs">**差(0分)**</span>：存在严重事实错误或幻觉

<span class="gs">**示例**</span>：
图像：[一只橙色的猫坐在蓝色沙发上]

<span class="k">-</span><span class="w"> </span>优秀：&quot;一只橙色的猫在蓝色沙发上&quot;
<span class="k">-</span><span class="w"> </span>良好：&quot;一只猫在沙发上&quot;（缺少颜色信息）
<span class="k">-</span><span class="w"> </span>一般：&quot;一只狗在沙发上&quot;（物体识别错误）
<span class="k">-</span><span class="w"> </span>差：&quot;多只猫在地板上&quot;（完全错误）

<span class="gu">### 1.2 完整性（Completeness）</span>
[详细定义和示例...]

<span class="gu">## 2. 标注流程</span>

<span class="k">1.</span> <span class="gs">**初步浏览**</span>：快速查看图像，理解场景
<span class="k">2.</span> <span class="gs">**仔细对比**</span>：逐句对比模型输出与图像
<span class="k">3.</span> <span class="gs">**评分记录**</span>：按维度给分并记录理由
<span class="k">4.</span> <span class="gs">**一致性检查**</span>：确保评分标准一致

<span class="gu">## 3. 常见问题处理</span>

Q: 如果模型使用同义词怎么办？
A: 同义词不扣分（如&quot;汽车&quot;vs&quot;轿车&quot;）

Q: 如何处理主观描述？
A: 只要合理即可（如&quot;美丽的&quot;风景）
</code></pre></div>

<h3 id="733">7.3.3 一致性检验</h3>
<p>确保多个标注者之间的一致性：</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 计算标注者间一致性</span>
<span class="k">def</span> <span class="nf">calculate_inter_rater_agreement</span><span class="p">(</span><span class="n">annotations</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    计算 Fleiss&#39; Kappa 系数</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotations</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 评估项目数</span>
    <span class="n">n_raters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>      <span class="c1"># 标注者数量</span>
    <span class="n">n_categories</span> <span class="o">=</span> <span class="mi">5</span>                 <span class="c1"># 评分等级数（如1-5分）</span>

    <span class="c1"># 构建评分矩阵</span>
    <span class="n">rating_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_items</span><span class="p">,</span> <span class="n">n_categories</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">item_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_items</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rater_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_raters</span><span class="p">):</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="n">annotations</span><span class="p">[</span><span class="n">rater_idx</span><span class="p">][</span><span class="n">item_idx</span><span class="p">]</span>
            <span class="n">rating_matrix</span><span class="p">[</span><span class="n">item_idx</span><span class="p">,</span> <span class="n">rating</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># 计算 Kappa</span>
    <span class="n">kappa</span> <span class="o">=</span> <span class="n">fleiss_kappa</span><span class="p">(</span><span class="n">rating_matrix</span><span class="p">)</span>

    <span class="c1"># 解释 Kappa 值</span>
    <span class="k">if</span> <span class="n">kappa</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>
        <span class="n">agreement</span> <span class="o">=</span> <span class="s2">&quot;微弱&quot;</span>
    <span class="k">elif</span> <span class="n">kappa</span> <span class="o">&lt;</span> <span class="mf">0.4</span><span class="p">:</span>
        <span class="n">agreement</span> <span class="o">=</span> <span class="s2">&quot;一般&quot;</span>
    <span class="k">elif</span> <span class="n">kappa</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">:</span>
        <span class="n">agreement</span> <span class="o">=</span> <span class="s2">&quot;中等&quot;</span>
    <span class="k">elif</span> <span class="n">kappa</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
        <span class="n">agreement</span> <span class="o">=</span> <span class="s2">&quot;较强&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">agreement</span> <span class="o">=</span> <span class="s2">&quot;极强&quot;</span>

    <span class="k">return</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">agreement</span>
</code></pre></div>

<p><strong>提高一致性的方法：</strong></p>
<ol>
<li><strong>培训阶段</strong>：所有标注者标注相同样本，讨论分歧</li>
<li><strong>黄金标准</strong>：定期插入已知答案的样本检验</li>
<li><strong>迭代优化</strong>：根据分歧案例更新标注指南</li>
<li><strong>双重标注</strong>：关键样本由多人独立标注</li>
</ol>
<h3 id="734">7.3.4 评估结果的统计分析</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 综合分析框架</span>
<span class="k">class</span> <span class="nc">EvaluationAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">annotations</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">annotations</span>

    <span class="k">def</span> <span class="nf">basic_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;基础统计量&quot;&quot;&quot;</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;median&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;quantiles&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">dimension_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;维度间相关性分析&quot;&quot;&quot;</span>
        <span class="c1"># 分析不同评估维度之间的相关性</span>
        <span class="n">dimensions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;completeness&#39;</span><span class="p">,</span> <span class="s1">&#39;fluency&#39;</span><span class="p">]</span>
        <span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="n">dimensions</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">corr_matrix</span>

    <span class="k">def</span> <span class="nf">error_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;错误模式分析&quot;&quot;&quot;</span>
        <span class="n">error_patterns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;hallucination&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;missing_info&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;wrong_attribute&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;spatial_error&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
        <span class="c1"># 分析常见错误类型</span>
        <span class="k">return</span> <span class="n">error_patterns</span>

    <span class="k">def</span> <span class="nf">significance_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_a_scores</span><span class="p">,</span> <span class="n">model_b_scores</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;显著性检验&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

        <span class="c1"># 配对t检验</span>
        <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_rel</span><span class="p">(</span><span class="n">model_a_scores</span><span class="p">,</span> <span class="n">model_b_scores</span><span class="p">)</span>

        <span class="c1"># Bootstrap 置信区间</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">model_a_scores</span> <span class="o">-</span> <span class="n">model_b_scores</span>
        <span class="n">bootstrap_means</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">bootstrap_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sample</span><span class="p">))</span>

        <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bootstrap_means</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
        <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bootstrap_means</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;t_statistic&#39;</span><span class="p">:</span> <span class="n">t_stat</span><span class="p">,</span>
            <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
            <span class="s1">&#39;confidence_interval&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">),</span>
            <span class="s1">&#39;significant&#39;</span><span class="p">:</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span>
        <span class="p">}</span>
</code></pre></div>

<h2 id="74-ab">7.4 A/B 测试与在线评估</h2>
<h3 id="741-ab">7.4.1 A/B 测试框架搭建</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># VLM A/B 测试框架</span>
<span class="k">class</span> <span class="nc">VLMABTestFramework</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_a</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_a_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_b</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_b_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span> <span class="o">=</span> <span class="n">MetricsCollector</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">assign_user_to_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;用户分组策略&quot;&quot;&quot;</span>
        <span class="c1"># 使用哈希确保同一用户始终分到同一组</span>
        <span class="n">hash_value</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">user_id</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">hash_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hash_value</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hash_int</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">traffic_split</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;model_b&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;model_a&#39;</span>

    <span class="k">def</span> <span class="nf">serve_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;处理用户请求&quot;&quot;&quot;</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assign_user_to_group</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># 记录请求信息</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_request</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="c1"># 生成响应</span>
        <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;model_a&#39;</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_a</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_b</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

        <span class="c1"># 收集指标</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collect_metrics</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">collect_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;收集评估指标&quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;latency&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">latency</span><span class="p">,</span>
            <span class="s1">&#39;token_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">tokens</span><span class="p">),</span>
            <span class="s1">&#39;user_feedback&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># 异步收集</span>
            <span class="s1">&#39;downstream_success&#39;</span><span class="p">:</span> <span class="kc">None</span>  <span class="c1"># 追踪下游任务成功率</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
</code></pre></div>

<h3 id="742">7.4.2 流量分配策略</h3>
<div class="codehilite"><pre><span></span><code>流量分配方案：

1. 渐进式发布（Progressive Rollout）
   第1天：5% 流量
   第3天：10% 流量（如果指标正常）
   第7天：25% 流量
   第14天：50% 流量
   第21天：100% 流量（全量发布）

2. 分层实验（Stratified Testing）
   ┌──────────────┬───────────┬────────────┐
   │    用户群体   │  流量占比  │   优先级    │
   ├──────────────┼───────────┼────────────┤
   │  内部用户     │    100%   │     1      │
   │  Beta 用户    │     50%   │     2      │
   │  VIP 用户     │     10%   │     3      │
   │  普通用户     │      5%   │     4      │
   └──────────────┴───────────┴────────────┘

3. 地域分配（Geographic Split）
   - 先在延迟容忍度高的地区测试
   - 逐步扩展到核心地区
</code></pre></div>

<h3 id="743">7.4.3 指标监控与早停机制</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">ABTestMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_thresholds</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">alert_thresholds</span>

    <span class="k">def</span> <span class="nf">check_guardrail_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;检查护栏指标&quot;&quot;&quot;</span>
        <span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 1. 性能护栏</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="o">.</span><span class="n">p95_latency</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">alert_thresholds</span><span class="o">.</span><span class="n">max_latency</span><span class="p">:</span>
            <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRITICAL&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;P95延迟超标: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">p95_latency</span><span class="si">}</span><span class="s1">ms&#39;</span><span class="p">))</span>

        <span class="c1"># 2. 质量护栏</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="o">.</span><span class="n">error_rate</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">alert_thresholds</span><span class="o">.</span><span class="n">max_error_rate</span><span class="p">:</span>
            <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CRITICAL&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;错误率过高: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">error_rate</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>

        <span class="c1"># 3. 用户体验护栏</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="o">.</span><span class="n">user_complaints</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">alert_thresholds</span><span class="o">.</span><span class="n">max_complaints</span><span class="p">:</span>
            <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;WARNING&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;用户投诉增加: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">user_complaints</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">alerts</span>

    <span class="k">def</span> <span class="nf">statistical_significance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_metrics</span><span class="p">,</span> <span class="n">treatment_metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;统计显著性检验&quot;&quot;&quot;</span>
        <span class="c1"># 计算提升和置信区间</span>
        <span class="n">lift</span> <span class="o">=</span> <span class="p">(</span><span class="n">treatment_metrics</span><span class="o">.</span><span class="n">mean</span> <span class="o">-</span> <span class="n">control_metrics</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">control_metrics</span><span class="o">.</span><span class="n">mean</span>

        <span class="c1"># 计算统计功效</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">treatment_metrics</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_statistical_power</span><span class="p">(</span>
            <span class="n">sample_size</span><span class="p">,</span> 
            <span class="n">lift</span><span class="p">,</span> 
            <span class="n">control_metrics</span><span class="o">.</span><span class="n">std</span>
        <span class="p">)</span>

        <span class="c1"># 判断是否达到显著性</span>
        <span class="n">p_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_p_value</span><span class="p">(</span><span class="n">control_metrics</span><span class="p">,</span> <span class="n">treatment_metrics</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;lift&#39;</span><span class="p">:</span> <span class="n">lift</span><span class="p">,</span>
            <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
            <span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="n">power</span><span class="p">,</span>
            <span class="s1">&#39;significant&#39;</span><span class="p">:</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="ow">and</span> <span class="n">power</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">,</span>
            <span class="s1">&#39;confidence_interval&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_ci</span><span class="p">(</span><span class="n">control_metrics</span><span class="p">,</span> <span class="n">treatment_metrics</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">early_stopping_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_results</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;早停决策&quot;&quot;&quot;</span>
        <span class="c1"># 1. 如果严重负向，立即停止</span>
        <span class="k">if</span> <span class="n">current_results</span><span class="o">.</span><span class="n">lift</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.1</span> <span class="ow">and</span> <span class="n">current_results</span><span class="o">.</span><span class="n">significant</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;STOP&#39;</span><span class="p">,</span> <span class="s1">&#39;显著负向影响&#39;</span>

        <span class="c1"># 2. 如果已经显著正向，可以提前结束</span>
        <span class="k">if</span> <span class="n">current_results</span><span class="o">.</span><span class="n">lift</span> <span class="o">&gt;</span> <span class="mf">0.05</span> <span class="ow">and</span> <span class="n">current_results</span><span class="o">.</span><span class="n">significant</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current_results</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">min_sample_size</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;SUCCESS&#39;</span><span class="p">,</span> <span class="s1">&#39;显著正向提升&#39;</span>

        <span class="c1"># 3. 如果样本量足够但无显著差异</span>
        <span class="k">if</span> <span class="n">current_results</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_sample_size</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;STOP&#39;</span><span class="p">,</span> <span class="s1">&#39;无显著差异&#39;</span>

        <span class="k">return</span> <span class="s1">&#39;CONTINUE&#39;</span><span class="p">,</span> <span class="kc">None</span>
</code></pre></div>

<h3 id="744">7.4.4 长期效果追踪</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 长期效果追踪系统</span>
<span class="k">class</span> <span class="nc">LongTermTracking</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">track_metric_degradation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">current_value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;追踪指标退化&quot;&quot;&quot;</span>
        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span>
        <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">current_value</span>
        <span class="p">})</span>

        <span class="c1"># 检测趋势</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>  <span class="c1"># 至少一周数据</span>
            <span class="n">recent</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">7</span><span class="p">:]]</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">14</span><span class="p">:</span><span class="o">-</span><span class="mi">7</span><span class="p">]]</span>

            <span class="c1"># Mann-Kendall 趋势检验</span>
            <span class="n">trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mann_kendall_test</span><span class="p">(</span><span class="n">recent</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">trend</span> <span class="o">==</span> <span class="s1">&#39;decreasing&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alert</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s1"> 出现下降趋势&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">track_user_behavior_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_queries</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;追踪用户行为变化&quot;&quot;&quot;</span>
        <span class="c1"># 分析查询分布变化</span>
        <span class="n">query_distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_query_distribution</span><span class="p">(</span><span class="n">user_queries</span><span class="p">)</span>

        <span class="c1"># 检测分布漂移</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_distribution_shift</span><span class="p">(</span><span class="n">query_distribution</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_retraining_alert</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">generate_weekly_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;生成周报&quot;&quot;&quot;</span>
        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;performance_trends&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_performance_trends</span><span class="p">(),</span>
            <span class="s1">&#39;user_satisfaction&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_user_feedback</span><span class="p">(),</span>
            <span class="s1">&#39;error_patterns&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_error_patterns</span><span class="p">(),</span>
            <span class="s1">&#39;recommendations&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_recommendations</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">report</span>
</code></pre></div>

<h2 id="75-case-study-mmbench">7.5 Case Study: MMBench 评测体系深度解读</h2>
<h3 id="751-circulareval">7.5.1 CircularEval 策略</h3>
<p>MMBench 的循环评估策略解决了选项顺序偏见问题：</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># CircularEval 实现</span>
<span class="k">def</span> <span class="nf">circular_eval</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    通过打乱选项顺序多次评估，消除位置偏见</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_options</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="n">votes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># 生成所有循环排列</span>
    <span class="k">for</span> <span class="n">shift</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_options</span><span class="p">):</span>
        <span class="c1"># 循环移动选项</span>
        <span class="n">shifted_options</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">shift</span><span class="p">:]</span> <span class="o">+</span> <span class="n">options</span><span class="p">[:</span><span class="n">shift</span><span class="p">]</span>
        <span class="n">option_map</span> <span class="o">=</span> <span class="p">{</span><span class="nb">chr</span><span class="p">(</span><span class="mi">65</span><span class="o">+</span><span class="n">i</span><span class="p">):</span> <span class="n">shifted_options</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_options</span><span class="p">)}</span>

        <span class="c1"># 构造prompt</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">format_question</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">shifted_options</span><span class="p">)</span>

        <span class="c1"># 获取模型预测</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>

        <span class="c1"># 映射回原始选项</span>
        <span class="k">if</span> <span class="n">answer</span> <span class="ow">in</span> <span class="n">option_map</span><span class="p">:</span>
            <span class="n">original_option</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">option_map</span><span class="p">[</span><span class="n">answer</span><span class="p">])</span>
            <span class="n">votes</span><span class="p">[</span><span class="n">original_option</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># 投票确定最终答案</span>
    <span class="n">final_answer</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">votes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">votes</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
    <span class="n">confidence</span> <span class="o">=</span> <span class="n">votes</span><span class="p">[</span><span class="n">final_answer</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_options</span>

    <span class="k">return</span> <span class="n">final_answer</span><span class="p">,</span> <span class="n">confidence</span>
</code></pre></div>

<h3 id="752">7.5.2 能力维度分解</h3>
<p>MMBench 将 VLM 能力分解为细粒度维度：</p>
<div class="codehilite"><pre><span></span><code>能力分类体系：
├── 感知能力（Perception）
│   ├── 物体定位（Object Localization）
│   ├── 属性识别（Attribute Recognition）
│   ├── 场景理解（Scene Understanding）
│   └── 空间关系（Spatial Relationship）
│
├── 推理能力（Reasoning）
│   ├── 逻辑推理（Logical Reasoning）
│   ├── 数值计算（Numerical Calculation）
│   ├── 常识推理（Commonsense Reasoning）
│   └── 因果推断（Causal Inference）
│
└── 知识能力（Knowledge）
    ├── 学科知识（Subject Knowledge）
    ├── 社会常识（Social Convention）
    ├── 历史文化（Historical Culture）
    └── 名人地标（Celebrity &amp; Landmark）
</code></pre></div>

<h3 id="753">7.5.3 评测结果分析</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># MMBench 结果分析工具</span>
<span class="k">class</span> <span class="nc">MMBenchAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">capability_radar_chart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;生成能力雷达图&quot;&quot;&quot;</span>
        <span class="n">capabilities</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Object Localization&#39;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
            <span class="s1">&#39;Attribute Recognition&#39;</span><span class="p">:</span> <span class="mf">0.92</span><span class="p">,</span>
            <span class="s1">&#39;Spatial Relationship&#39;</span><span class="p">:</span> <span class="mf">0.76</span><span class="p">,</span>
            <span class="s1">&#39;Logical Reasoning&#39;</span><span class="p">:</span> <span class="mf">0.68</span><span class="p">,</span>
            <span class="s1">&#39;Commonsense&#39;</span><span class="p">:</span> <span class="mf">0.81</span><span class="p">,</span>
            <span class="s1">&#39;Subject Knowledge&#39;</span><span class="p">:</span> <span class="mf">0.73</span>
        <span class="p">}</span>

        <span class="c1"># 生成雷达图数据</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">capabilities</span><span class="p">),</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">capabilities</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">angles</span><span class="p">,</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">error_case_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;错误案例分析&quot;&quot;&quot;</span>
        <span class="n">error_patterns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;position_bias&#39;</span><span class="p">:</span> <span class="p">[],</span>      <span class="c1"># 位置偏好错误</span>
            <span class="s1">&#39;language_bias&#39;</span><span class="p">:</span> <span class="p">[],</span>      <span class="c1"># 语言偏见错误</span>
            <span class="s1">&#39;hallucination&#39;</span><span class="p">:</span> <span class="p">[],</span>      <span class="c1"># 幻觉错误</span>
            <span class="s1">&#39;reasoning_fail&#39;</span><span class="p">:</span> <span class="p">[],</span>     <span class="c1"># 推理失败</span>
            <span class="s1">&#39;knowledge_gap&#39;</span><span class="p">:</span> <span class="p">[]</span>       <span class="c1"># 知识缺失</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;correct&#39;</span><span class="p">]:</span>
                <span class="n">error_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify_error</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">error_patterns</span><span class="p">[</span><span class="n">error_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">error_patterns</span>

    <span class="k">def</span> <span class="nf">compare_with_baselines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;与基准模型对比&quot;&quot;&quot;</span>
        <span class="n">baselines</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;GPT-4V&#39;</span><span class="p">:</span> <span class="mf">0.776</span><span class="p">,</span>
            <span class="s1">&#39;Gemini-Pro&#39;</span><span class="p">:</span> <span class="mf">0.739</span><span class="p">,</span>
            <span class="s1">&#39;Claude-3&#39;</span><span class="p">:</span> <span class="mf">0.768</span><span class="p">,</span>
            <span class="s1">&#39;Qwen-VL-Plus&#39;</span><span class="p">:</span> <span class="mf">0.726</span>
        <span class="p">}</span>

        <span class="n">our_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">])</span>

        <span class="n">comparison</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span>
                <span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="n">our_score</span> <span class="o">-</span> <span class="n">score</span><span class="p">,</span>
                <span class="s1">&#39;relative&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">our_score</span> <span class="o">-</span> <span class="n">score</span><span class="p">)</span> <span class="o">/</span> <span class="n">score</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">baselines</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">comparison</span>
</code></pre></div>

<h2 id="76">7.6 高级话题</h2>
<h3 id="761">7.6.1 幻觉评估方法</h3>
<p><strong>POPE (Polling-based Object Probing Evaluation)</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">POPEEvaluator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_detector</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="n">object_detector</span>

    <span class="k">def</span> <span class="nf">generate_pope_questions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;生成 POPE 评估问题&quot;&quot;&quot;</span>
        <span class="c1"># 检测图像中的真实物体</span>
        <span class="n">real_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># 构造三种类型的问题</span>
        <span class="n">questions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;random&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_sampling</span><span class="p">(</span><span class="n">real_objects</span><span class="p">),</span>
            <span class="s1">&#39;popular&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">popular_sampling</span><span class="p">(</span><span class="n">real_objects</span><span class="p">),</span>
            <span class="s1">&#39;adversarial&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adversarial_sampling</span><span class="p">(</span><span class="n">real_objects</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">questions</span>

    <span class="k">def</span> <span class="nf">random_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">real_objects</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;随机采样策略&quot;&quot;&quot;</span>
        <span class="n">questions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 50% 真实物体</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">real_objects</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">real_objects</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">questions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;Is there a </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2"> in the image?&quot;</span><span class="p">,</span> <span class="s2">&quot;Yes&quot;</span><span class="p">))</span>

        <span class="c1"># 50% 不存在的物体</span>
        <span class="n">fake_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_random_objects</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="n">real_objects</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">fake_objects</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">real_objects</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">questions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;Is there a </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2"> in the image?&quot;</span><span class="p">,</span> <span class="s2">&quot;No&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">questions</span>

    <span class="k">def</span> <span class="nf">popular_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">real_objects</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;频繁共现物体采样&quot;&quot;&quot;</span>
        <span class="c1"># 选择经常一起出现但实际不在图中的物体</span>
        <span class="n">co_occurring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_co_occurring_objects</span><span class="p">(</span><span class="n">real_objects</span><span class="p">)</span>
        <span class="n">fake_objects</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">co_occurring</span> <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">real_objects</span><span class="p">]</span>

        <span class="n">questions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">real_objects</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">real_objects</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">questions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;Is there a </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2"> in the image?&quot;</span><span class="p">,</span> <span class="s2">&quot;Yes&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">fake_objects</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">real_objects</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">questions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;Is there a </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2"> in the image?&quot;</span><span class="p">,</span> <span class="s2">&quot;No&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">questions</span>

    <span class="k">def</span> <span class="nf">evaluate_hallucination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">questions</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;评估幻觉率&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;yes_bias&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 倾向于回答&quot;是&quot;</span>
            <span class="s1">&#39;hallucination_rate&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>

        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">yes_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">false_positive</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">question</span><span class="p">,</span> <span class="n">ground_truth</span> <span class="ow">in</span> <span class="n">questions</span><span class="p">:</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">prediction</span> <span class="o">==</span> <span class="n">ground_truth</span><span class="p">:</span>
                <span class="n">correct</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">prediction</span> <span class="o">==</span> <span class="s2">&quot;Yes&quot;</span><span class="p">:</span>
                <span class="n">yes_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">ground_truth</span> <span class="o">==</span> <span class="s2">&quot;No&quot;</span><span class="p">:</span>
                    <span class="n">false_positive</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">questions</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;yes_bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yes_count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">questions</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;hallucination_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">false_positive</span> <span class="o">/</span> <span class="nb">len</span><span class="p">([</span><span class="n">q</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">questions</span> <span class="k">if</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;No&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<h3 id="762-chain-of-thought">7.6.2 Chain-of-Thought 评测设计</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CoTEvaluator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reasoning_patterns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;visual_grounding&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;首先.*图像.*看到&#39;</span><span class="p">,</span>
            <span class="s1">&#39;step_by_step&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;第[一二三四五]步&#39;</span><span class="p">,</span>
            <span class="s1">&#39;logical_connector&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;因此|所以|由于|因为&#39;</span><span class="p">,</span>
            <span class="s1">&#39;evidence_based&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;根据.*可以.*判断&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">evaluate_reasoning_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cot_response</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;评估推理链质量&quot;&quot;&quot;</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># 1. 推理步骤完整性</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_reasoning_steps</span><span class="p">(</span><span class="n">cot_response</span><span class="p">)</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;completeness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># 期望至少3步</span>

        <span class="c1"># 2. 逻辑连贯性</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;coherence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_logical_flow</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>

        <span class="c1"># 3. 视觉grounding</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;grounding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_visual_grounding</span><span class="p">(</span><span class="n">cot_response</span><span class="p">)</span>

        <span class="c1"># 4. 最终答案一致性</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;consistency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_answer_consistency</span><span class="p">(</span><span class="n">cot_response</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scores</span>

    <span class="k">def</span> <span class="nf">check_visual_grounding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;检查推理是否基于视觉信息&quot;&quot;&quot;</span>
        <span class="n">visual_references</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;图像&#39;</span><span class="p">,</span> <span class="s1">&#39;图中&#39;</span><span class="p">,</span> <span class="s1">&#39;看到&#39;</span><span class="p">,</span> <span class="s1">&#39;显示&#39;</span><span class="p">,</span> <span class="s1">&#39;出现&#39;</span><span class="p">,</span>
            <span class="s1">&#39;左边&#39;</span><span class="p">,</span> <span class="s1">&#39;右边&#39;</span><span class="p">,</span> <span class="s1">&#39;上方&#39;</span><span class="p">,</span> <span class="s1">&#39;下方&#39;</span><span class="p">,</span> <span class="s1">&#39;中间&#39;</span><span class="p">,</span>
            <span class="s1">&#39;颜色&#39;</span><span class="p">,</span> <span class="s1">&#39;形状&#39;</span><span class="p">,</span> <span class="s1">&#39;大小&#39;</span>
        <span class="p">]</span>

        <span class="n">reference_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">visual_references</span> <span class="k">if</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">reference_count</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># 期望至少5次视觉引用</span>

    <span class="k">def</span> <span class="nf">compare_cot_vs_direct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">test_set</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;对比 CoT 和直接回答的效果&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;direct&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="p">[]},</span>
            <span class="s1">&#39;cot&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;reasoning_quality&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">test_set</span><span class="p">:</span>
            <span class="c1"># 直接回答</span>
            <span class="n">direct_answer</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">answer_direct</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">question</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;direct&#39;</span><span class="p">][</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">direct_answer</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">ground_truth</span><span class="p">)</span>

            <span class="c1"># CoT 回答</span>
            <span class="n">cot_response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">answer_with_cot</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">question</span><span class="p">)</span>
            <span class="n">cot_answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_final_answer</span><span class="p">(</span><span class="n">cot_response</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cot&#39;</span><span class="p">][</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">cot_answer</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">ground_truth</span><span class="p">)</span>

            <span class="c1"># 评估推理质量</span>
            <span class="n">reasoning_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_reasoning_quality</span><span class="p">(</span><span class="n">cot_response</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cot&#39;</span><span class="p">][</span><span class="s1">&#39;reasoning_quality&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reasoning_scores</span><span class="p">)</span>

        <span class="c1"># 计算平均值</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_set</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;direct&#39;</span><span class="p">][</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">n</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cot&#39;</span><span class="p">][</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">n</span>

        <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<h3 id="763">7.6.3 对抗性评估</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AdversarialEvaluator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attack_types</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;typographic&#39;</span><span class="p">,</span>  <span class="c1"># 文字类攻击</span>
            <span class="s1">&#39;compositional&#39;</span><span class="p">,</span> <span class="c1"># 组合性攻击  </span>
            <span class="s1">&#39;logical&#39;</span><span class="p">,</span>       <span class="c1"># 逻辑陷阱</span>
            <span class="s1">&#39;visual&#39;</span>         <span class="c1"># 视觉对抗</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">generate_adversarial_examples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_sample</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;生成对抗样本&quot;&quot;&quot;</span>
        <span class="n">adversarial_samples</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 1. 打字错误攻击</span>
        <span class="n">typo_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_typos</span><span class="p">(</span><span class="n">original_sample</span><span class="p">)</span>
        <span class="n">adversarial_samples</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;typographic&#39;</span><span class="p">,</span> <span class="n">typo_sample</span><span class="p">))</span>

        <span class="c1"># 2. 否定词攻击</span>
        <span class="n">negation_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_negation</span><span class="p">(</span><span class="n">original_sample</span><span class="p">)</span>
        <span class="n">adversarial_samples</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;negation&#39;</span><span class="p">,</span> <span class="n">negation_sample</span><span class="p">))</span>

        <span class="c1"># 3. 组合关系攻击</span>
        <span class="n">comp_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_relationships</span><span class="p">(</span><span class="n">original_sample</span><span class="p">)</span>
        <span class="n">adversarial_samples</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;compositional&#39;</span><span class="p">,</span> <span class="n">comp_sample</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">adversarial_samples</span>

    <span class="k">def</span> <span class="nf">evaluate_robustness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">test_set</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;评估模型鲁棒性&quot;&quot;&quot;</span>
        <span class="n">robustness_scores</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">original</span> <span class="ow">in</span> <span class="n">test_set</span><span class="p">:</span>
            <span class="c1"># 原始样本得分</span>
            <span class="n">original_score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>

            <span class="c1"># 生成对抗样本</span>
            <span class="n">adversarial_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_adversarial_examples</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">attack_type</span><span class="p">,</span> <span class="n">adv_sample</span> <span class="ow">in</span> <span class="n">adversarial_samples</span><span class="p">:</span>
                <span class="n">adv_score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">adv_sample</span><span class="p">)</span>

                <span class="c1"># 计算性能下降</span>
                <span class="n">degradation</span> <span class="o">=</span> <span class="p">(</span><span class="n">original_score</span> <span class="o">-</span> <span class="n">adv_score</span><span class="p">)</span> <span class="o">/</span> <span class="n">original_score</span>
                <span class="n">robustness_scores</span><span class="p">[</span><span class="n">attack_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">degradation</span><span class="p">)</span>

        <span class="c1"># 汇总结果</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">attack</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;mean_robustness&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span>
                <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">attack</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">robustness_scores</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">summary</span>
</code></pre></div>

<h3 id="764">7.6.4 跨语言评估挑战</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CrossLingualEvaluator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">languages</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="s1">&#39;zh&#39;</span><span class="p">,</span> <span class="s1">&#39;ja&#39;</span><span class="p">,</span> <span class="s1">&#39;fr&#39;</span><span class="p">,</span> <span class="s1">&#39;es&#39;</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">languages</span> <span class="o">=</span> <span class="n">languages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translators</span> <span class="o">=</span> <span class="p">{</span><span class="n">lang</span><span class="p">:</span> <span class="n">load_translator</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span> <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">languages</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">evaluate_language_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">question_en</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;评估跨语言一致性&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># 英文基准答案</span>
        <span class="n">answer_en</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">question_en</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="s1">&#39;en&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">languages</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># 跳过英文</span>
            <span class="c1"># 翻译问题</span>
            <span class="n">question_translated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translators</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">question_en</span><span class="p">)</span>

            <span class="c1"># 获取目标语言答案</span>
            <span class="n">answer_lang</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">question_translated</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">)</span>

            <span class="c1"># 翻译回英文进行比较</span>
            <span class="n">answer_back</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translators</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span><span class="o">.</span><span class="n">translate_back</span><span class="p">(</span><span class="n">answer_lang</span><span class="p">)</span>

            <span class="c1"># 计算语义相似度</span>
            <span class="n">similarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">semantic_similarity</span><span class="p">(</span><span class="n">answer_en</span><span class="p">,</span> <span class="n">answer_back</span><span class="p">)</span>

            <span class="n">results</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;answer&#39;</span><span class="p">:</span> <span class="n">answer_lang</span><span class="p">,</span>
                <span class="s1">&#39;back_translation&#39;</span><span class="p">:</span> <span class="n">answer_back</span><span class="p">,</span>
                <span class="s1">&#39;similarity&#39;</span><span class="p">:</span> <span class="n">similarity</span><span class="p">,</span>
                <span class="s1">&#39;consistent&#39;</span><span class="p">:</span> <span class="n">similarity</span> <span class="o">&gt;</span> <span class="mf">0.85</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">identify_language_specific_challenges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;识别特定语言的挑战&quot;&quot;&quot;</span>
        <span class="n">challenges</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;zh&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;量词使用（一个、一只、一条）&#39;</span><span class="p">,</span>
                <span class="s1">&#39;方位词差异（上下左右 vs 东南西北）&#39;</span><span class="p">,</span>
                <span class="s1">&#39;颜色描述（深浅 vs dark/light）&#39;</span>
            <span class="p">],</span>
            <span class="s1">&#39;ja&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;敬语级别&#39;</span><span class="p">,</span>
                <span class="s1">&#39;汉字/假名选择&#39;</span><span class="p">,</span>
                <span class="s1">&#39;计数词系统&#39;</span>
            <span class="p">],</span>
            <span class="s1">&#39;ar&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;从右到左的空间描述&#39;</span><span class="p">,</span>
                <span class="s1">&#39;双数形式&#39;</span><span class="p">,</span>
                <span class="s1">&#39;性别一致性&#39;</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">challenges</span>
</code></pre></div>

<h2 id="77">7.7 本章小结</h2>
<p>本章系统介绍了 VLM 评估体系的设计与实现。关键要点包括：</p>
<ol>
<li>
<p><strong>基准测试选择</strong>：需要平衡通用能力和领域特定评估，注意数据泄露问题</p>
</li>
<li>
<p><strong>自动评估指标</strong>：
   - 传统 NLP 指标存在局限性
   - 基于模型的评估更接近人类判断
   - 任务特定指标（幻觉检测、空间理解等）至关重要</p>
</li>
<li>
<p><strong>人工评估</strong>：
   - 清晰的标注指南是保证质量的关键
   - 需要进行一致性检验和统计分析
   - 成本高但不可或缺</p>
</li>
<li>
<p><strong>在线评估</strong>：
   - A/B 测试需要完善的框架和监控
   - 注意护栏指标和早停机制
   - 长期效果追踪同样重要</p>
</li>
<li>
<p><strong>高级技术</strong>：
   - 幻觉评估（POPE、CHAIR）
   - Chain-of-Thought 质量评估
   - 对抗性测试和跨语言一致性</p>
</li>
</ol>
<p><strong>核心公式回顾：</strong></p>
<ol>
<li>
<p>Fleiss' Kappa（一致性）：$\kappa = \frac{P_o - P_e}{1 - P_e}$</p>
</li>
<li>
<p>统计显著性：$t = \frac{\bar{X}_1 - \bar{X}_2}{\sqrt{\frac{s_1^2}{n_1} + \frac{s_2^2}{n_2}}}$</p>
</li>
<li>
<p>幻觉率：$\text{CHAIR}_i = \frac{|\text{hallucinated objects}|}{|\text{mentioned objects}|}$</p>
</li>
</ol>
<h2 id="78">7.8 练习题</h2>
<h3 id="_1">基础题</h3>
<p><strong>练习 7.1：基准测试选择</strong></p>
<p>你正在为一个面向教育领域的 VLM 模型设计评估方案。该模型主要用于：</p>
<ol>
<li>解答数学几何题（需要理解图形）</li>
<li>批改学生作业（识别手写文字）</li>
<li>生成教学材料说明</li>
</ol>
<p>请选择合适的评估基准并说明理由。</p>
<p>💡 <strong>提示</strong>：考虑通用基准和领域特定基准的组合。</p>
<details>
<summary>参考答案</summary>
<p>建议选择以下基准测试组合：</p>
<p><strong>通用基准：</strong></p>
<ul>
<li>MathVista：专门评估数学图表理解能力</li>
<li>MMMU：包含学科知识，适合教育场景</li>
</ul>
<p><strong>领域特定基准：</strong></p>
<ul>
<li>OCRBench：评估手写文字识别能力</li>
<li>ChartQA：评估图表理解能力</li>
<li>自建教育场景测试集：包含真实的作业批改案例</li>
</ul>
<p><strong>理由：</strong></p>
<ol>
<li>MathVista 直接对应几何题解答需求</li>
<li>OCRBench 覆盖手写识别场景</li>
<li>需要自建测试集因为现有基准可能不完全覆盖教育特定场景</li>
<li>通用基准确保模型基础能力，领域基准验证实际应用效果</li>
</ol>
</details>
<p><strong>练习 7.2：指标设计</strong></p>
<p>设计一个评估 VLM 模型"指令遵循能力"的指标。模型需要根据用户指令对图像进行特定格式的描述（如"用三句话描述"、"列出5个关键元素"等）。</p>
<p>💡 <strong>提示</strong>：考虑格式遵循、内容完整性等多个维度。</p>
<details>
<summary>参考答案</summary>
<p>指令遵循能力评估指标设计：</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">instruction_following_score</span><span class="p">(</span><span class="n">instruction</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># 1. 格式遵循度（40%权重）</span>
    <span class="k">if</span> <span class="s2">&quot;三句话&quot;</span> <span class="ow">in</span> <span class="n">instruction</span><span class="p">:</span>
        <span class="n">sentence_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;。&#39;</span><span class="p">))</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">sentence_count</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sentence_count</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s2">&quot;列出&quot;</span> <span class="ow">in</span> <span class="n">instruction</span> <span class="ow">and</span> <span class="s2">&quot;个&quot;</span> <span class="ow">in</span> <span class="n">instruction</span><span class="p">:</span>
        <span class="c1"># 提取数量要求</span>
        <span class="n">required_items</span> <span class="o">=</span> <span class="n">extract_number</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>
        <span class="n">actual_items</span> <span class="o">=</span> <span class="n">count_list_items</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">actual_items</span> <span class="o">==</span> <span class="n">required_items</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">actual_items</span> <span class="o">-</span> <span class="n">required_items</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">)</span>

    <span class="c1"># 2. 内容相关性（30%权重）</span>
    <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;relevance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_relevance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>

    <span class="c1"># 3. 指令关键词覆盖（20%权重）</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="n">extract_instruction_keywords</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>
    <span class="n">covered</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">keywords</span> <span class="k">if</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">response</span><span class="p">)</span>
    <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;keyword_coverage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">covered</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span> <span class="k">if</span> <span class="n">keywords</span> <span class="k">else</span> <span class="mf">1.0</span>

    <span class="c1"># 4. 禁止内容检查（10%权重）</span>
    <span class="k">if</span> <span class="s2">&quot;不要提及&quot;</span> <span class="ow">in</span> <span class="n">instruction</span><span class="p">:</span>
        <span class="n">forbidden</span> <span class="o">=</span> <span class="n">extract_forbidden_content</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;constraint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">f</span> <span class="ow">in</span> <span class="n">response</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">forbidden</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1.0</span>

    <span class="c1"># 加权总分</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s1">&#39;relevance&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;keyword_coverage&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;constraint&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
    <span class="n">final_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">final_score</span><span class="p">,</span> <span class="n">scores</span>
</code></pre></div>

</details>
<p><strong>练习 7.3：一致性检验</strong></p>
<p>三位标注者对 100 个 VLM 输出进行了 1-5 分的质量评分。评分数据如下格式：</p>
<div class="codehilite"><pre><span></span><code>Item1: [4, 3, 4]  # 三位标注者的评分
Item2: [5, 5, 4]
...
</code></pre></div>

<p>请计算合适的一致性指标并解释结果。</p>
<p>💡 <strong>提示</strong>：考虑使用 Fleiss' Kappa 或 ICC。</p>
<details>
<summary>参考答案</summary>
<p>使用 Fleiss' Kappa 和 ICC 进行一致性分析：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="k">def</span> <span class="nf">analyze_agreement</span><span class="p">(</span><span class="n">ratings</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ratings: shape (n_items, n_raters)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_items</span><span class="p">,</span> <span class="n">n_raters</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">n_categories</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># 1-5分</span>

    <span class="c1"># 1. 计算 Fleiss&#39; Kappa</span>
    <span class="c1"># 构建频率矩阵</span>
    <span class="n">freq_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_items</span><span class="p">,</span> <span class="n">n_categories</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_items</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rating</span> <span class="ow">in</span> <span class="n">ratings</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">freq_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">rating</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># 计算 P_o（观察一致性）</span>
    <span class="n">P_o</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_items</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">):</span>
            <span class="n">P_o</span> <span class="o">+=</span> <span class="n">freq_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">freq_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">P_o</span> <span class="o">=</span> <span class="n">P_o</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_items</span> <span class="o">*</span> <span class="n">n_raters</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_raters</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># 计算 P_e（期望一致性）</span>
    <span class="n">P_e</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">):</span>
        <span class="n">p_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">freq_matrix</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_items</span> <span class="o">*</span> <span class="n">n_raters</span><span class="p">)</span>
        <span class="n">P_e</span> <span class="o">+=</span> <span class="n">p_j</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="c1"># Fleiss&#39; Kappa</span>
    <span class="n">kappa</span> <span class="o">=</span> <span class="p">(</span><span class="n">P_o</span> <span class="o">-</span> <span class="n">P_e</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">P_e</span><span class="p">)</span>

    <span class="c1"># 2. 计算 ICC (Intraclass Correlation Coefficient)</span>
    <span class="c1"># 使用双向随机效应模型</span>
    <span class="n">icc</span> <span class="o">=</span> <span class="n">calculate_icc</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">icc_type</span><span class="o">=</span><span class="s1">&#39;ICC(2,k)&#39;</span><span class="p">)</span>

    <span class="c1"># 3. 计算标注者间的配对相关性</span>
    <span class="n">correlations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_raters</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_raters</span><span class="p">):</span>
            <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">ratings</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">ratings</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">correlations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>

    <span class="c1"># 解释结果</span>
    <span class="n">interpretation</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;fleiss_kappa&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">kappa</span><span class="p">,</span>
            <span class="s1">&#39;interpretation&#39;</span><span class="p">:</span> <span class="n">interpret_kappa</span><span class="p">(</span><span class="n">kappa</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="s1">&#39;icc&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">icc</span><span class="p">,</span>
            <span class="s1">&#39;interpretation&#39;</span><span class="p">:</span> <span class="n">interpret_icc</span><span class="p">(</span><span class="n">icc</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="s1">&#39;pairwise_correlations&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">correlations</span><span class="p">),</span>
            <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">correlations</span><span class="p">),</span>
            <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">correlations</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">interpretation</span>

<span class="k">def</span> <span class="nf">interpret_kappa</span><span class="p">(</span><span class="n">kappa</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">kappa</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;微弱一致性 - 需要重新培训标注者&quot;</span>
    <span class="k">elif</span> <span class="n">kappa</span> <span class="o">&lt;</span> <span class="mf">0.4</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;一般一致性 - 建议改进标注指南&quot;</span>
    <span class="k">elif</span> <span class="n">kappa</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;中等一致性 - 可接受但有改进空间&quot;</span>
    <span class="k">elif</span> <span class="n">kappa</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;较强一致性 - 标注质量良好&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;极强一致性 - 标注质量优秀&quot;</span>
</code></pre></div>

<p><strong>结果解释：</strong></p>
<ul>
<li>Kappa = 0.65：中等到较强的一致性，标注质量可接受</li>
<li>ICC = 0.72：良好的信度，标注者评分较为一致</li>
<li>建议：检查低一致性的具体案例，可能需要细化某些评分标准</li>
</ul>
</details>
<h3 id="_2">挑战题</h3>
<p><strong>练习 7.4：幻觉检测算法设计</strong></p>
<p>设计一个不依赖于物体检测器的幻觉检测方法。该方法应该能够识别模型生成的描述中不存在于图像中的内容。</p>
<p>💡 <strong>提示</strong>：考虑使用注意力机制或对比学习。</p>
<details>
<summary>参考答案</summary>
<p>基于注意力机制和对比验证的幻觉检测：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AttentionBasedHallucinationDetector</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vlm_model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">vlm_model</span>

    <span class="k">def</span> <span class="nf">detect_hallucination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">generated_text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        通过分析注意力分布检测幻觉</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. 获取生成过程中的注意力权重</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span><span class="n">generated_text</span><span class="p">)</span>
        <span class="n">attention_maps</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="c1"># 获取该 token 对图像区域的注意力</span>
            <span class="n">attn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_cross_attention</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
            <span class="n">attention_maps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attn</span><span class="p">)</span>

        <span class="c1"># 2. 识别可能的幻觉token</span>
        <span class="n">hallucination_scores</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_content_word</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>  <span class="c1"># 只检查实词</span>
                <span class="c1"># 计算注意力熵（分散度）</span>
                <span class="n">entropy</span> <span class="o">=</span> <span class="n">calculate_entropy</span><span class="p">(</span><span class="n">attention_maps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                <span class="c1"># 高熵表示注意力分散，可能是幻觉</span>
                <span class="k">if</span> <span class="n">entropy</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="c1"># 进一步验证：遮蔽测试</span>
                    <span class="n">masked_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masking_test</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">generated_text</span><span class="p">)</span>
                    <span class="n">hallucination_scores</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span>
                        <span class="s1">&#39;entropy&#39;</span><span class="p">:</span> <span class="n">entropy</span><span class="p">,</span>
                        <span class="s1">&#39;masked_score&#39;</span><span class="p">:</span> <span class="n">masked_score</span><span class="p">,</span>
                        <span class="s1">&#39;is_hallucination&#39;</span><span class="p">:</span> <span class="n">masked_score</span> <span class="o">&gt;</span> <span class="mf">0.7</span>
                    <span class="p">})</span>

        <span class="k">return</span> <span class="n">hallucination_scores</span>

    <span class="k">def</span> <span class="nf">masking_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">target_token</span><span class="p">,</span> <span class="n">full_text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        遮蔽图像区域，测试token的稳定性</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 获取token的主要注意力区域</span>
        <span class="n">attn_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_cross_attention</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">target_token</span><span class="p">)</span>
        <span class="n">top_regions</span> <span class="o">=</span> <span class="n">get_top_k_regions</span><span class="p">(</span><span class="n">attn_map</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># 遮蔽这些区域</span>
        <span class="n">masked_images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">top_regions</span><span class="p">:</span>
            <span class="n">masked_img</span> <span class="o">=</span> <span class="n">mask_region</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
            <span class="n">masked_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">masked_img</span><span class="p">)</span>

        <span class="c1"># 测试生成的一致性</span>
        <span class="n">consistency_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">masked_img</span> <span class="ow">in</span> <span class="n">masked_images</span><span class="p">:</span>
            <span class="n">new_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">masked_img</span><span class="p">,</span> <span class="n">same_prompt</span><span class="p">)</span>
            <span class="c1"># 如果遮蔽后仍然生成相同的token，可能是幻觉</span>
            <span class="k">if</span> <span class="n">target_token</span> <span class="ow">in</span> <span class="n">new_text</span><span class="p">:</span>
                <span class="n">consistency_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">consistency_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">consistency_scores</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">contrastive_verification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">claim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        通过生成对比问题验证声明</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 生成验证问题</span>
        <span class="n">verification_questions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;图像中是否有</span><span class="si">{</span><span class="n">extract_object</span><span class="p">(</span><span class="n">claim</span><span class="p">)</span><span class="si">}</span><span class="s2">？&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">extract_object</span><span class="p">(</span><span class="n">claim</span><span class="p">)</span><span class="si">}</span><span class="s2">的颜色是什么？&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">extract_object</span><span class="p">(</span><span class="n">claim</span><span class="p">)</span><span class="si">}</span><span class="s2">在图像的哪个位置？&quot;</span>
        <span class="p">]</span>

        <span class="n">confidence_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">verification_questions</span><span class="p">:</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">question</span><span class="p">)</span>
            <span class="c1"># 分析回答的确定性</span>
            <span class="n">confidence</span> <span class="o">=</span> <span class="n">analyze_answer_confidence</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
            <span class="n">confidence_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">confidence</span><span class="p">)</span>

        <span class="c1"># 低置信度可能表示幻觉</span>
        <span class="n">avg_confidence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">confidence_scores</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">avg_confidence</span> <span class="o">&lt;</span> <span class="mf">0.5</span>
</code></pre></div>

<p><strong>创新点：</strong></p>
<ol>
<li>不依赖外部物体检测器</li>
<li>结合注意力机制分析和遮蔽测试</li>
<li>使用对比验证增强准确性</li>
<li>可解释性强，能定位具体的幻觉内容</li>
</ol>
</details>
<p><strong>练习 7.5：在线 A/B 测试设计</strong></p>
<p>你需要设计一个 A/B 测试来评估新的 VLM 模型是否应该替换现有模型。系统每天处理 100 万个请求，主要指标是用户满意度（通过点击率衡量）。设计完整的测试方案，包括样本量计算、测试时长和决策标准。</p>
<p>💡 <strong>提示</strong>：考虑统计功效、最小可检测效应和业务影响。</p>
<details>
<summary>参考答案</summary>
<p>完整的 A/B 测试方案设计：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">VLMABTestDesign</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_traffic</span> <span class="o">=</span> <span class="mi">1_000_000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_ctr</span> <span class="o">=</span> <span class="mf">0.15</span>  <span class="c1"># 15% 基准点击率</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_detectable_effect</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># 1% 绝对提升</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># 显著性水平</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span> <span class="o">=</span> <span class="mf">0.8</span>   <span class="c1"># 统计功效</span>

    <span class="k">def</span> <span class="nf">calculate_sample_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        计算所需样本量</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">statsmodels.stats.power</span> <span class="kn">import</span> <span class="n">zt_ind_solve_power</span>

        <span class="c1"># 效应量计算</span>
        <span class="n">effect_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_detectable_effect</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">baseline_ctr</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_ctr</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># 每组所需样本量</span>
        <span class="n">n_per_group</span> <span class="o">=</span> <span class="n">zt_ind_solve_power</span><span class="p">(</span>
            <span class="n">effect_size</span><span class="o">=</span><span class="n">effect_size</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">power</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
            <span class="n">ratio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span>
        <span class="p">)</span>

        <span class="n">total_sample</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_per_group</span>
        <span class="n">days_needed</span> <span class="o">=</span> <span class="n">total_sample</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_traffic</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># 10%流量用于测试</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;sample_per_group&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_per_group</span><span class="p">),</span>
            <span class="s1">&#39;total_sample&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_sample</span><span class="p">),</span>
            <span class="s1">&#39;days_needed&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">days_needed</span><span class="p">),</span>
            <span class="s1">&#39;daily_test_traffic&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_traffic</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">design_test_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        设计完整测试计划</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sample_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_sample_size</span><span class="p">()</span>

        <span class="n">test_plan</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;阶段1：小流量验证（第1-3天）&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;traffic_percentage&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;daily_users&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;验证系统稳定性，发现严重问题&#39;</span><span class="p">,</span>
                <span class="s1">&#39;success_criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;无系统崩溃，错误率&lt;1%&#39;</span><span class="p">,</span>
                <span class="s1">&#39;monitors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;错误率&#39;</span><span class="p">,</span> <span class="s1">&#39;延迟P99&#39;</span><span class="p">,</span> <span class="s1">&#39;资源使用&#39;</span><span class="p">]</span>
            <span class="p">},</span>

            <span class="s1">&#39;阶段2：正式实验（第4-14天）&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;traffic_percentage&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="s1">&#39;daily_users&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>
                <span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;收集统计显著的结果&#39;</span><span class="p">,</span>
                <span class="s1">&#39;success_criteria&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;CTR提升&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_detectable_effect</span><span class="si">}</span><span class="s1">，p&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;monitors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;CTR&#39;</span><span class="p">,</span> <span class="s1">&#39;用户满意度&#39;</span><span class="p">,</span> <span class="s1">&#39;停留时长&#39;</span><span class="p">,</span> <span class="s1">&#39;跳出率&#39;</span><span class="p">]</span>
            <span class="p">},</span>

            <span class="s1">&#39;阶段3：扩大验证（第15-21天）&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;traffic_percentage&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
                <span class="s1">&#39;daily_users&#39;</span><span class="p">:</span> <span class="mi">300000</span><span class="p">,</span>
                <span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;验证不同用户群体的效果&#39;</span><span class="p">,</span>
                <span class="s1">&#39;success_criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;各细分群体均无负向影响&#39;</span><span class="p">,</span>
                <span class="s1">&#39;monitors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;分群体CTR&#39;</span><span class="p">,</span> <span class="s1">&#39;地域差异&#39;</span><span class="p">,</span> <span class="s1">&#39;新老用户差异&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">test_plan</span>

    <span class="k">def</span> <span class="nf">define_decision_criteria</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        定义决策标准</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;发布决策&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;强烈推荐发布&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;CTR 提升 &gt; 2%&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;p-value &lt; 0.01&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;所有细分群体均正向&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;用户投诉下降&#39;</span>
                <span class="p">],</span>
                <span class="s1">&#39;推荐发布&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;CTR 提升 &gt; 1%&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;p-value &lt; 0.05&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;主要群体正向&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;无严重负面反馈&#39;</span>
                <span class="p">],</span>
                <span class="s1">&#39;暂缓发布&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;CTR 提升 &lt; 1%&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;p-value &gt; 0.05&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;或存在细分群体负向&#39;</span>
                <span class="p">],</span>
                <span class="s1">&#39;停止发布&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;CTR 下降&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;严重性能问题&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;用户投诉激增&#39;</span>
                <span class="p">]</span>
            <span class="p">},</span>

            <span class="s1">&#39;护栏指标&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;性能护栏&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;P95_latency&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;500ms&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;error_rate&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;0.1%&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;gpu_utilization&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;80%&#39;</span>
                <span class="p">},</span>
                <span class="s1">&#39;业务护栏&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;revenue_impact&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;-1%&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;user_complaints&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;2x baseline&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;retention_rate&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;98%&#39;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">criteria</span>

    <span class="k">def</span> <span class="nf">monitoring_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        监控仪表板设计</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dashboard</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;实时监控&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;分组流量分配比例&#39;</span><span class="p">,</span>
                <span class="s1">&#39;实时 CTR 对比&#39;</span><span class="p">,</span>
                <span class="s1">&#39;延迟分布&#39;</span><span class="p">,</span>
                <span class="s1">&#39;错误率趋势&#39;</span>
            <span class="p">],</span>

            <span class="s1">&#39;每日报告&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;累计样本量和统计功效&#39;</span><span class="p">,</span>
                <span class="s1">&#39;CTR 提升及置信区间&#39;</span><span class="p">,</span>
                <span class="s1">&#39;细分维度分析&#39;</span><span class="p">,</span>
                <span class="s1">&#39;异常案例汇总&#39;</span>
            <span class="p">],</span>

            <span class="s1">&#39;决策支持&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;预计完成时间&#39;</span><span class="p">,</span>
                <span class="s1">&#39;当前统计显著性&#39;</span><span class="p">,</span>
                <span class="s1">&#39;提前停止建议&#39;</span><span class="p">,</span>
                <span class="s1">&#39;发布风险评估&#39;</span>
            <span class="p">]</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">dashboard</span>
</code></pre></div>

<p><strong>关键决策点：</strong></p>
<ol>
<li><strong>样本量</strong>：约 294,000 per group，需要 6 天达到统计显著</li>
<li><strong>测试时长</strong>：建议 21 天完整周期，覆盖不同使用模式</li>
<li><strong>流量分配</strong>：渐进式，1% → 10% → 30%</li>
<li><strong>决策标准</strong>：综合考虑统计显著性和业务影响</li>
<li><strong>风险控制</strong>：设置多层护栏，支持快速回滚</li>
</ol>
</details>
<p><strong>练习 7.6：跨模态一致性评估</strong></p>
<p>设计一个评估框架，用于检测 VLM 在处理同一内容的不同模态表示时的一致性（例如：图表的图像版本 vs 数据表格）。</p>
<p>💡 <strong>提示</strong>：考虑如何生成等价的多模态输入。</p>
<details>
<summary>参考答案</summary>
<p>跨模态一致性评估框架：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">CrossModalConsistencyEvaluator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modality_pairs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;image_chart&#39;</span><span class="p">,</span> <span class="s1">&#39;data_table&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;photo&#39;</span><span class="p">,</span> <span class="s1">&#39;text_description&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;diagram&#39;</span><span class="p">,</span> <span class="s1">&#39;structured_text&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;screenshot&#39;</span><span class="p">,</span> <span class="s1">&#39;html_dom&#39;</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">generate_equivalent_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">source_modality</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        生成等价的多模态输入</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">source_modality</span> <span class="o">==</span> <span class="s1">&#39;data_table&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;bar_chart&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_to_bar_chart</span><span class="p">(</span><span class="n">content</span><span class="p">),</span>
                <span class="s1">&#39;line_chart&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_to_line_chart</span><span class="p">(</span><span class="n">content</span><span class="p">),</span>
                <span class="s1">&#39;pie_chart&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_to_pie_chart</span><span class="p">(</span><span class="n">content</span><span class="p">),</span>
                <span class="s1">&#39;text_summary&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_to_text</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">source_modality</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;text_description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_to_text</span><span class="p">(</span><span class="n">content</span><span class="p">),</span>
                <span class="s1">&#39;structured_data&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_to_structured</span><span class="p">(</span><span class="n">content</span><span class="p">),</span>
                <span class="s1">&#39;sketch&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_to_sketch</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="c1"># ... 其他模态转换</span>

    <span class="k">def</span> <span class="nf">evaluate_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">question</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        评估跨模态一致性</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 生成多模态版本</span>
        <span class="n">modalities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_equivalent_inputs</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;original&#39;</span><span class="p">)</span>

        <span class="n">responses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># 获取各模态的响应</span>
        <span class="k">for</span> <span class="n">modality_name</span><span class="p">,</span> <span class="n">modality_content</span> <span class="ow">in</span> <span class="n">modalities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">modality_content</span><span class="p">,</span> <span class="n">question</span><span class="p">)</span>
            <span class="n">responses</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span>

            <span class="c1"># 获取语义嵌入</span>
            <span class="n">embedding</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_embedding</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="n">embeddings</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">embedding</span>

        <span class="c1"># 计算一致性指标</span>
        <span class="n">consistency_metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;semantic_similarity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_semantic_consistency</span><span class="p">(</span><span class="n">embeddings</span><span class="p">),</span>
            <span class="s1">&#39;answer_agreement&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_answer_agreement</span><span class="p">(</span><span class="n">responses</span><span class="p">),</span>
            <span class="s1">&#39;information_preservation&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_info_preservation</span><span class="p">(</span><span class="n">responses</span><span class="p">),</span>
            <span class="s1">&#39;confidence_stability&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_confidence_stability</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">consistency_metrics</span>

    <span class="k">def</span> <span class="nf">compute_semantic_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        计算语义一致性</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">similarities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">modalities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modalities</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">modalities</span><span class="p">)):</span>
                <span class="n">sim</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span>
                    <span class="n">embeddings</span><span class="p">[</span><span class="n">modalities</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> 
                    <span class="n">embeddings</span><span class="p">[</span><span class="n">modalities</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
                <span class="p">)</span>
                <span class="n">similarities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;mean_similarity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">similarities</span><span class="p">),</span>
            <span class="s1">&#39;min_similarity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">similarities</span><span class="p">),</span>
            <span class="s1">&#39;std_similarity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">similarities</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">identify_inconsistency_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        识别不一致模式</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;modality_bias&#39;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># 特定模态的偏好</span>
            <span class="s1">&#39;information_loss&#39;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># 信息丢失模式</span>
            <span class="s1">&#39;systematic_errors&#39;</span><span class="p">:</span> <span class="p">[]</span>  <span class="c1"># 系统性错误</span>
        <span class="p">}</span>

        <span class="c1"># 分析每种模态转换的一致性</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modality_pairs</span><span class="p">:</span>
            <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span> <span class="o">=</span> <span class="n">pair</span>
            <span class="n">consistency</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1">_to_</span><span class="si">{</span><span class="n">tgt</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">consistency</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">patterns</span><span class="p">[</span><span class="s1">&#39;modality_bias&#39;</span><span class="p">][</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="n">consistency</span>

                <span class="c1"># 深入分析不一致原因</span>
                <span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="s1">&#39;image_chart&#39;</span> <span class="ow">and</span> <span class="n">tgt</span> <span class="o">==</span> <span class="s1">&#39;data_table&#39;</span><span class="p">:</span>
                    <span class="c1"># 图表识别可能的问题</span>
                    <span class="n">issues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_chart_recognition_issues</span><span class="p">()</span>
                    <span class="n">patterns</span><span class="p">[</span><span class="s1">&#39;systematic_errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">patterns</span>

    <span class="k">def</span> <span class="nf">generate_test_suite</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        生成测试套件</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">test_cases</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 1. 数值一致性测试</span>
        <span class="n">test_cases</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;数值提取一致性&#39;</span><span class="p">,</span>
            <span class="s1">&#39;inputs&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;chart_image&#39;</span><span class="p">:</span> <span class="n">create_bar_chart</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">]),</span>
                <span class="s1">&#39;data_table&#39;</span><span class="p">:</span> <span class="n">create_table</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">])</span>
            <span class="p">},</span>
            <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="s1">&#39;最大值是多少？&#39;</span><span class="p">,</span>
            <span class="s1">&#39;expected_consistency&#39;</span><span class="p">:</span> <span class="mf">1.0</span>
        <span class="p">})</span>

        <span class="c1"># 2. 趋势识别一致性</span>
        <span class="n">test_cases</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;趋势分析一致性&#39;</span><span class="p">,</span>
            <span class="s1">&#39;inputs&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;line_chart&#39;</span><span class="p">:</span> <span class="n">create_trend_chart</span><span class="p">(),</span>
                <span class="s1">&#39;text_description&#39;</span><span class="p">:</span> <span class="n">create_trend_description</span><span class="p">()</span>
            <span class="p">},</span>
            <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="s1">&#39;数据呈现什么趋势？&#39;</span><span class="p">,</span>
            <span class="s1">&#39;expected_consistency&#39;</span><span class="p">:</span> <span class="mf">0.9</span>
        <span class="p">})</span>

        <span class="c1"># 3. 关系理解一致性</span>
        <span class="n">test_cases</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;空间关系一致性&#39;</span><span class="p">,</span>
            <span class="s1">&#39;inputs&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;scene_image&#39;</span><span class="p">:</span> <span class="n">create_scene_image</span><span class="p">(),</span>
                <span class="s1">&#39;scene_graph&#39;</span><span class="p">:</span> <span class="n">create_scene_graph</span><span class="p">()</span>
            <span class="p">},</span>
            <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="s1">&#39;物体之间的位置关系是什么？&#39;</span><span class="p">,</span>
            <span class="s1">&#39;expected_consistency&#39;</span><span class="p">:</span> <span class="mf">0.85</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="n">test_cases</span>
</code></pre></div>

<p><strong>评估维度：</strong></p>
<ol>
<li><strong>语义一致性</strong>：不同模态表达的语义是否一致</li>
<li><strong>数值准确性</strong>：从图表和表格提取的数值是否相同</li>
<li><strong>关系保持</strong>：实体关系在不同模态中是否保持</li>
<li><strong>置信度稳定性</strong>：模型对不同模态输入的确定性是否一致</li>
</ol>
</details>
<p><strong>练习 7.7：评估成本优化</strong></p>
<p>你的团队每月需要评估 10 个 VLM 模型版本，每个版本在 5 个基准测试上评估（共 50K 样本），同时需要 1000 个样本的人工评估。当前每月评估成本为 $50,000。设计一个方案将成本降低 50% 而不显著影响评估质量。</p>
<p>💡 <strong>提示</strong>：考虑采样策略、评估复用和自动化。</p>
<details>
<summary>参考答案</summary>
<p>评估成本优化方案：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">EvaluationCostOptimizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_cost</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;compute&#39;</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span>  <span class="c1"># GPU 计算成本</span>
            <span class="s1">&#39;human&#39;</span><span class="p">:</span> <span class="mi">15000</span><span class="p">,</span>    <span class="c1"># 人工标注成本</span>
            <span class="s1">&#39;api&#39;</span><span class="p">:</span> <span class="mi">5000</span>        <span class="c1"># API 调用成本（GPT-4V评估）</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_cost</span> <span class="o">=</span> <span class="mi">25000</span>  <span class="c1"># 目标成本</span>

    <span class="k">def</span> <span class="nf">optimization_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        多维度优化策略</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strategies</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;1. 智能采样策略&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">smart_sampling</span><span class="p">(),</span>
            <span class="s1">&#39;2. 评估复用机制&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_reuse</span><span class="p">(),</span>
            <span class="s1">&#39;3. 分层评估流程&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiered_evaluation</span><span class="p">(),</span>
            <span class="s1">&#39;4. 自动化预筛选&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">automated_prescreening</span><span class="p">(),</span>
            <span class="s1">&#39;5. 资源调度优化&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_optimization</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">strategies</span>

    <span class="k">def</span> <span class="nf">smart_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        智能采样减少评估量</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;方法&#39;</span><span class="p">:</span> <span class="s1">&#39;自适应重要性采样&#39;</span><span class="p">,</span>
            <span class="s1">&#39;实现&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            class AdaptiveSampler:</span>
<span class="s1">                def __init__(self, full_dataset):</span>
<span class="s1">                    self.dataset = full_dataset</span>
<span class="s1">                    self.difficulty_scores = self.estimate_difficulty()</span>

<span class="s1">                def sample(self, n_samples, model_capability):</span>
<span class="s1">                    # 根据模型能力调整采样分布</span>
<span class="s1">                    if model_capability &gt; 0.8:</span>
<span class="s1">                        # 强模型：更多困难样本</span>
<span class="s1">                        weights = self.difficulty_scores ** 2</span>
<span class="s1">                    else:</span>
<span class="s1">                        # 弱模型：均衡采样</span>
<span class="s1">                        weights = np.ones_like(self.difficulty_scores)</span>

<span class="s1">                    # 分层采样确保覆盖</span>
<span class="s1">                    strata = self.create_strata()</span>
<span class="s1">                    samples = []</span>
<span class="s1">                    for stratum in strata:</span>
<span class="s1">                        n_stratum = int(n_samples * stratum.weight)</span>
<span class="s1">                        stratum_samples = self.weighted_sample(</span>
<span class="s1">                            stratum.items, </span>
<span class="s1">                            weights[stratum.indices], </span>
<span class="s1">                            n_stratum</span>
<span class="s1">                        )</span>
<span class="s1">                        samples.extend(stratum_samples)</span>

<span class="s1">                    return samples</span>

<span class="s1">                def estimate_difficulty(self):</span>
<span class="s1">                    # 基于历史模型表现估计难度</span>
<span class="s1">                    return historical_error_rates</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;预期节省&#39;</span><span class="p">:</span> <span class="s1">&#39;40% 样本量，保持 95% 评估准确度&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">evaluation_reuse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        评估结果复用</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;方法&#39;</span><span class="p">:</span> <span class="s1">&#39;增量评估 + 结果缓存&#39;</span><span class="p">,</span>
            <span class="s1">&#39;实现&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            class IncrementalEvaluator:</span>
<span class="s1">                def __init__(self):</span>
<span class="s1">                    self.cache = EvaluationCache()</span>

<span class="s1">                def evaluate_model(self, model_version, benchmarks):</span>
<span class="s1">                    results = </span><span class="si">{}</span>

<span class="s1">                    # 检测模型变化</span>
<span class="s1">                    changes = self.detect_changes(model_version)</span>

<span class="s1">                    for benchmark in benchmarks:</span>
<span class="s1">                        if self.can_reuse(model_version, benchmark, changes):</span>
<span class="s1">                            # 复用之前版本的结果</span>
<span class="s1">                            cached = self.cache.get(model_version.base, benchmark)</span>

<span class="s1">                            # 只评估可能受影响的子集</span>
<span class="s1">                            affected_samples = self.get_affected_samples(changes, benchmark)</span>
<span class="s1">                            new_results = model_version.evaluate(affected_samples)</span>

<span class="s1">                            # 合并结果</span>
<span class="s1">                            results[benchmark] = self.merge_results(cached, new_results)</span>
<span class="s1">                        else:</span>
<span class="s1">                            # 完整评估</span>
<span class="s1">                            results[benchmark] = model_version.evaluate(benchmark)</span>

<span class="s1">                    self.cache.store(model_version, results)</span>
<span class="s1">                    return results</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;预期节省&#39;</span><span class="p">:</span> <span class="s1">&#39;60% 重复评估成本&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">tiered_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        分层评估流程</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;方法&#39;</span><span class="p">:</span> <span class="s1">&#39;快速筛选 → 详细评估&#39;</span><span class="p">,</span>
            <span class="s1">&#39;流程&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            Level 1: 快速筛选（500 样本，5 分钟）</span>
<span class="s1">            ├── 如果性能下降 &gt; 5% → 停止，不需要完整评估</span>
<span class="s1">            ├── 如果性能提升 &lt; 1% → 停止，改进不明显</span>
<span class="s1">            └── 否则 → 进入 Level 2</span>

<span class="s1">            Level 2: 标准评估（5K 样本，1 小时）</span>
<span class="s1">            ├── 如果达到发布标准 → 进入 Level 3</span>
<span class="s1">            └── 否则 → 返回开发</span>

<span class="s1">            Level 3: 完整评估（50K 样本 + 人工）</span>
<span class="s1">            └── 只对候选发布版本执行</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;预期节省&#39;</span><span class="p">:</span> <span class="s1">&#39;70% 的模型在 Level 1/2 被过滤&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">automated_prescreening</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        自动化预筛选</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;方法&#39;</span><span class="p">:</span> <span class="s1">&#39;用小模型预筛选 + GPT-4V 抽检&#39;</span><span class="p">,</span>
            <span class="s1">&#39;实现&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            class HybridEvaluator:</span>
<span class="s1">                def __init__(self):</span>
<span class="s1">                    self.small_model = load_model(&#39;llava-1.5-7b&#39;)  # 便宜</span>
<span class="s1">                    self.large_model = load_model(&#39;gpt-4v&#39;)  # 昂贵但准确</span>

<span class="s1">                def evaluate(self, samples):</span>
<span class="s1">                    # Step 1: 小模型全量评估</span>
<span class="s1">                    small_results = self.small_model.evaluate_all(samples)</span>

<span class="s1">                    # Step 2: 识别分歧样本</span>
<span class="s1">                    uncertain_samples = self.identify_uncertain(small_results)</span>

<span class="s1">                    # Step 3: 大模型抽检</span>
<span class="s1">                    # 只对 20% 不确定样本使用 GPT-4V</span>
<span class="s1">                    large_results = self.large_model.evaluate(uncertain_samples)</span>

<span class="s1">                    # Step 4: 校准小模型结果</span>
<span class="s1">                    calibrated = self.calibrate_results(</span>
<span class="s1">                        small_results, </span>
<span class="s1">                        large_results, </span>
<span class="s1">                        uncertain_samples</span>
<span class="s1">                    )</span>

<span class="s1">                    return calibrated</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;预期节省&#39;</span><span class="p">:</span> <span class="s1">&#39;80% API 调用成本&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">resource_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        资源调度优化</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;方法&#39;</span><span class="p">:</span> <span class="s1">&#39;批处理 + 预约调度 + 点价策略&#39;</span><span class="p">,</span>
            <span class="s1">&#39;具体措施&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;批量处理：积累任务统一执行，提高 GPU 利用率&#39;</span><span class="p">,</span>
                <span class="s1">&#39;错峰调度：使用夜间/周末的便宜算力&#39;</span><span class="p">,</span>
                <span class="s1">&#39;竞价实例：非紧急评估使用 Spot 实例&#39;</span><span class="p">,</span>
                <span class="s1">&#39;模型量化：评估时使用量化模型（验证精度损失 &lt;1%）&#39;</span>
            <span class="p">],</span>
            <span class="s1">&#39;预期节省&#39;</span><span class="p">:</span> <span class="s1">&#39;30% 计算成本&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">cost_breakdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        优化后成本分解</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">optimized_cost</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;计算成本&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;原始&#39;</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span>
                <span class="s1">&#39;优化后&#39;</span><span class="p">:</span> <span class="mi">15000</span><span class="p">,</span>
                <span class="s1">&#39;措施&#39;</span><span class="p">:</span> <span class="s1">&#39;智能采样(40%) + 量化(20%) + Spot实例(20%)&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;人工成本&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;原始&#39;</span><span class="p">:</span> <span class="mi">15000</span><span class="p">,</span>
                <span class="s1">&#39;优化后&#39;</span><span class="p">:</span> <span class="mi">6000</span><span class="p">,</span>
                <span class="s1">&#39;措施&#39;</span><span class="p">:</span> <span class="s1">&#39;分层评估(60%) + 主动学习(40%)&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;API成本&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;原始&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>
                <span class="s1">&#39;优化后&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
                <span class="s1">&#39;措施&#39;</span><span class="p">:</span> <span class="s1">&#39;小模型预筛(80%) + 缓存复用(20%)&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;总计&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;原始&#39;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span>
                <span class="s1">&#39;优化后&#39;</span><span class="p">:</span> <span class="mi">22000</span><span class="p">,</span>
                <span class="s1">&#39;节省&#39;</span><span class="p">:</span> <span class="s1">&#39;56%&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">optimized_cost</span>

    <span class="k">def</span> <span class="nf">implementation_roadmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        实施路线图</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">roadmap</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Week 1-2&#39;</span><span class="p">:</span> <span class="s1">&#39;实现智能采样和缓存机制&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Week 3-4&#39;</span><span class="p">:</span> <span class="s1">&#39;部署分层评估流程&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Week 5-6&#39;</span><span class="p">:</span> <span class="s1">&#39;集成自动化预筛选&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Week 7-8&#39;</span><span class="p">:</span> <span class="s1">&#39;优化资源调度&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Week 9-10&#39;</span><span class="p">:</span> <span class="s1">&#39;A/B 测试验证评估质量&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Week 11-12&#39;</span><span class="p">:</span> <span class="s1">&#39;全面部署和监控&#39;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">roadmap</span>
</code></pre></div>

<p><strong>关键优化点：</strong></p>
<ol>
<li><strong>智能采样</strong>：减少 40% 样本量</li>
<li><strong>评估复用</strong>：节省 60% 重复工作</li>
<li><strong>分层流程</strong>：70% 模型提前终止</li>
<li><strong>混合评估</strong>：80% API 成本降低</li>
<li><strong>资源优化</strong>：30% 计算成本降低</li>
</ol>
<p><strong>总体效果</strong>：成本降低 56%，评估质量保持 95% 以上</p>
</details>
<p><strong>练习 7.8：评估偏见检测</strong></p>
<p>设计一个方法来检测 VLM 评估过程中可能存在的偏见，包括但不限于：文化偏见、语言偏见、视觉风格偏见等。</p>
<p>💡 <strong>提示</strong>：考虑如何构造对照实验。</p>
<details>
<summary>参考答案</summary>
<p>评估偏见检测框架：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">EvaluationBiasDetector</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_dimensions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;cultural&#39;</span><span class="p">,</span>
            <span class="s1">&#39;linguistic&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;visual_style&#39;</span><span class="p">,</span>
            <span class="s1">&#39;demographic&#39;</span><span class="p">,</span>
            <span class="s1">&#39;geographic&#39;</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">detect_cultural_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">evaluation_set</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        检测文化偏见</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 构造文化对照组</span>
        <span class="n">cultural_groups</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;western&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_western_content</span><span class="p">(</span><span class="n">evaluation_set</span><span class="p">),</span>
            <span class="s1">&#39;eastern&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_eastern_content</span><span class="p">(</span><span class="n">evaluation_set</span><span class="p">),</span>
            <span class="s1">&#39;african&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_african_content</span><span class="p">(</span><span class="n">evaluation_set</span><span class="p">),</span>
            <span class="s1">&#39;latin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_latin_content</span><span class="p">(</span><span class="n">evaluation_set</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># 评估各文化组的表现</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">culture</span><span class="p">,</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">cultural_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
            <span class="n">performance</span><span class="p">[</span><span class="n">culture</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;mean_score&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span>
                <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span>
                <span class="s1">&#39;n_samples&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="c1"># 统计分析偏见</span>
        <span class="n">bias_metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;performance_gap&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;mean_score&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">performance</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">-</span> 
                              <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;mean_score&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">performance</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s1">&#39;fairness_score&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;mean_score&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">performance</span><span class="o">.</span><span class="n">values</span><span class="p">()]),</span>
            <span class="s1">&#39;statistical_test&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">anova_test</span><span class="p">(</span><span class="n">performance</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">bias_metrics</span>

    <span class="k">def</span> <span class="nf">detect_linguistic_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        检测语言偏见</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 构造等价的多语言测试集</span>
        <span class="n">test_cases</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 相同内容，不同表达方式</span>
        <span class="n">expressions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;formal&#39;</span><span class="p">:</span> <span class="s2">&quot;The figure illustrates a declining trend&quot;</span><span class="p">,</span>
            <span class="s1">&#39;casual&#39;</span><span class="p">:</span> <span class="s2">&quot;The graph shows it&#39;s going down&quot;</span><span class="p">,</span>
            <span class="s1">&#39;technical&#39;</span><span class="p">:</span> <span class="s2">&quot;The plot exhibits negative correlation&quot;</span><span class="p">,</span>
            <span class="s1">&#39;simple&#39;</span><span class="p">:</span> <span class="s2">&quot;Numbers get smaller&quot;</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">style</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">expressions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">test_cases</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;style&#39;</span><span class="p">:</span> <span class="n">style</span><span class="p">,</span>
                <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
                <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">confidence</span>
            <span class="p">})</span>

        <span class="c1"># 分析风格偏好</span>
        <span class="n">style_bias</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;preferred_style&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">test_cases</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">])[</span><span class="s1">&#39;style&#39;</span><span class="p">],</span>
            <span class="s1">&#39;style_variance&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">test_cases</span><span class="p">]),</span>
            <span class="s1">&#39;consistency&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_consistency</span><span class="p">(</span><span class="n">test_cases</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">style_bias</span>

    <span class="k">def</span> <span class="nf">detect_visual_style_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        检测视觉风格偏见</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 相同内容，不同视觉风格</span>
        <span class="n">style_variants</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;photograph&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_photo_dataset</span><span class="p">(),</span>
            <span class="s1">&#39;illustration&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_illustration_dataset</span><span class="p">(),</span>
            <span class="s1">&#39;sketch&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_sketch_dataset</span><span class="p">(),</span>
            <span class="s1">&#39;diagram&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_diagram_dataset</span><span class="p">(),</span>
            <span class="s1">&#39;screenshot&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_screenshot_dataset</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">performance_by_style</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">style</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">style_variants</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># 确保内容等价</span>
            <span class="n">controlled_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_controlled_set</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">controlled_set</span><span class="p">)</span>

            <span class="n">performance_by_style</span><span class="p">[</span><span class="n">style</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span>
                <span class="s1">&#39;error_types&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_errors</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">controlled_set</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="c1"># 计算风格偏见指标</span>
        <span class="n">style_bias</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;max_gap&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_max_gap</span><span class="p">(</span><span class="n">performance_by_style</span><span class="p">),</span>
            <span class="s1">&#39;style_preference&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_preference</span><span class="p">(</span><span class="n">performance_by_style</span><span class="p">),</span>
            <span class="s1">&#39;robustness_score&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_robustness</span><span class="p">(</span><span class="n">performance_by_style</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">style_bias</span>

    <span class="k">def</span> <span class="nf">construct_counterfactual_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        构造反事实测试</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counterfactuals</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 1. 性别交换测试</span>
        <span class="n">counterfactuals</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="s2">&quot;一位男医生在检查病人&quot;</span><span class="p">,</span>
            <span class="s1">&#39;counterfactual&#39;</span><span class="p">:</span> <span class="s2">&quot;一位女医生在检查病人&quot;</span><span class="p">,</span>
            <span class="s1">&#39;attribute&#39;</span><span class="p">:</span> <span class="s1">&#39;gender&#39;</span><span class="p">,</span>
            <span class="s1">&#39;expected_difference&#39;</span><span class="p">:</span> <span class="mi">0</span>  <span class="c1"># 期望无差异</span>
        <span class="p">})</span>

        <span class="c1"># 2. 种族交换测试</span>
        <span class="n">counterfactuals</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;original_image&#39;</span><span class="p">:</span> <span class="s2">&quot;asian_person_coding.jpg&quot;</span><span class="p">,</span>
            <span class="s1">&#39;counterfactual_image&#39;</span><span class="p">:</span> <span class="s2">&quot;african_person_coding.jpg&quot;</span><span class="p">,</span>
            <span class="s1">&#39;attribute&#39;</span><span class="p">:</span> <span class="s1">&#39;race&#39;</span><span class="p">,</span>
            <span class="s1">&#39;expected_difference&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">})</span>

        <span class="c1"># 3. 年龄交换测试</span>
        <span class="n">counterfactuals</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="s2">&quot;年轻人使用智能手机&quot;</span><span class="p">,</span>
            <span class="s1">&#39;counterfactual&#39;</span><span class="p">:</span> <span class="s2">&quot;老年人使用智能手机&quot;</span><span class="p">,</span>
            <span class="s1">&#39;attribute&#39;</span><span class="p">:</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span>
            <span class="s1">&#39;expected_difference&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="n">counterfactuals</span>

    <span class="k">def</span> <span class="nf">measure_intersectional_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">evaluation_set</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        测量交叉性偏见</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 多维度组合</span>
        <span class="n">intersections</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;gender_x_race&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;age_x_culture&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;style_x_language&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

        <span class="c1"># 分析多维度交叉的影响</span>
        <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">evaluation_set</span><span class="p">:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_attributes</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>

            <span class="c1"># 记录交叉属性组合的表现</span>
            <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;race&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">intersections</span><span class="p">[</span><span class="s1">&#39;gender_x_race&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>

        <span class="c1"># 计算交叉偏见</span>
        <span class="n">intersectional_bias</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dimension</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">intersections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">grouped</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">grouped</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

            <span class="c1"># 计算各组合的平均表现</span>
            <span class="n">means</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">grouped</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">intersectional_bias</span><span class="p">[</span><span class="n">dimension</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;group_means&#39;</span><span class="p">:</span> <span class="n">means</span><span class="p">,</span>
                <span class="s1">&#39;max_gap&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">means</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">means</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                <span class="s1">&#39;most_disadvantaged&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">means</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">intersectional_bias</span>

    <span class="k">def</span> <span class="nf">generate_bias_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_metrics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        生成偏见评估报告</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;overall_fairness_score&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_overall_fairness</span><span class="p">(</span><span class="n">all_metrics</span><span class="p">),</span>
                <span class="s1">&#39;main_bias_sources&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_main_biases</span><span class="p">(</span><span class="n">all_metrics</span><span class="p">),</span>
                <span class="s1">&#39;recommendations&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_recommendations</span><span class="p">(</span><span class="n">all_metrics</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="s1">&#39;detailed_findings&#39;</span><span class="p">:</span> <span class="n">all_metrics</span><span class="p">,</span>
            <span class="s1">&#39;mitigation_strategies&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;data_balancing&#39;</span><span class="p">:</span> <span class="s1">&#39;增加代表性不足群体的训练数据&#39;</span><span class="p">,</span>
                <span class="s1">&#39;debiasing_techniques&#39;</span><span class="p">:</span> <span class="s1">&#39;应用对抗性去偏或公平性约束&#39;</span><span class="p">,</span>
                <span class="s1">&#39;evaluation_improvement&#39;</span><span class="p">:</span> <span class="s1">&#39;使用更平衡的评估集&#39;</span><span class="p">,</span>
                <span class="s1">&#39;human_review&#39;</span><span class="p">:</span> <span class="s1">&#39;对识别出的偏见案例进行人工审核&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">report</span>
</code></pre></div>

<p><strong>偏见检测维度：</strong></p>
<ol>
<li><strong>文化偏见</strong>：不同文化背景内容的性能差异</li>
<li><strong>语言偏见</strong>：对特定语言风格或方言的偏好</li>
<li><strong>视觉风格偏见</strong>：对特定图像类型的偏好</li>
<li><strong>人口统计偏见</strong>：基于性别、年龄、种族的差异</li>
<li><strong>交叉性偏见</strong>：多个属性组合产生的复合偏见</li>
</ol>
<p><strong>关键方法：</strong></p>
<ul>
<li>反事实测试：改变单一属性观察影响</li>
<li>分层分析：按不同维度分组比较</li>
<li>统计检验：确定差异的显著性</li>
<li>交叉分析：识别复合偏见模式</li>
</ul>
</details>
<h2 id="79">7.9 常见陷阱与错误</h2>
<h3 id="1">陷阱 1：过度依赖单一指标</h3>
<p><strong>问题描述</strong>：
只看 accuracy 或 BLEU 分数就决定模型好坏，忽略其他重要维度。</p>
<p><strong>后果</strong>：</p>
<ul>
<li>模型可能在准确率高但用户体验差</li>
<li>忽略了安全性、公平性等关键问题</li>
<li>无法发现特定场景下的失败模式</li>
</ul>
<p><strong>解决方案</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ❌ 错误做法</span>
<span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">accuracy</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
    <span class="n">deploy_model</span><span class="p">()</span>

<span class="c1"># ✅ 正确做法</span>
<span class="n">evaluation_criteria</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">),</span>
    <span class="s1">&#39;latency_p99&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">),</span>  <span class="c1"># ms</span>
    <span class="s1">&#39;hallucination_rate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">),</span>
    <span class="s1">&#39;fairness_gap&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">),</span>
    <span class="s1">&#39;user_satisfaction&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">4.0</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">)</span>  <span class="c1"># 1-5 scale</span>
<span class="p">}</span>

<span class="n">all_pass</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
    <span class="n">check_criterion</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span> <span class="ow">in</span> <span class="n">evaluation_criteria</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">all_pass</span><span class="p">:</span>
    <span class="n">deploy_model</span><span class="p">()</span>
</code></pre></div>

<h3 id="2">陷阱 2：评估数据泄露</h3>
<p><strong>问题描述</strong>：
测试集数据意外出现在训练集中，导致评估结果虚高。</p>
<p><strong>常见来源</strong>：</p>
<ul>
<li>网络爬取的数据包含了公开的测试集</li>
<li>数据增强时不小心使用了测试图像</li>
<li>使用了包含测试集的预训练模型</li>
</ul>
<p><strong>检测方法</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 数据泄露检测</span>
<span class="k">def</span> <span class="nf">detect_leakage</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
    <span class="c1"># 1. 精确匹配检测</span>
    <span class="n">train_hashes</span> <span class="o">=</span> <span class="p">{</span><span class="nb">hash</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">train_data</span><span class="o">.</span><span class="n">images</span><span class="p">}</span>
    <span class="n">test_hashes</span> <span class="o">=</span> <span class="p">{</span><span class="nb">hash</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">test_data</span><span class="o">.</span><span class="n">images</span><span class="p">}</span>
    <span class="n">exact_overlap</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_hashes</span> <span class="o">&amp;</span> <span class="n">test_hashes</span><span class="p">)</span>

    <span class="c1"># 2. 近似匹配检测（使用感知哈希）</span>
    <span class="n">train_phash</span> <span class="o">=</span> <span class="p">{</span><span class="n">imagehash</span><span class="o">.</span><span class="n">phash</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">train_data</span><span class="o">.</span><span class="n">images</span><span class="p">}</span>
    <span class="n">test_phash</span> <span class="o">=</span> <span class="p">{</span><span class="n">imagehash</span><span class="o">.</span><span class="n">phash</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">test_data</span><span class="o">.</span><span class="n">images</span><span class="p">}</span>

    <span class="n">near_duplicates</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">test_h</span> <span class="ow">in</span> <span class="n">test_phash</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">train_h</span> <span class="ow">in</span> <span class="n">train_phash</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">test_h</span> <span class="o">-</span> <span class="n">train_h</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># 汉明距离阈值</span>
                <span class="n">near_duplicates</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">break</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;精确重复: </span><span class="si">{</span><span class="n">exact_overlap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;近似重复: </span><span class="si">{</span><span class="n">near_duplicates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;泄露率: </span><span class="si">{</span><span class="p">(</span><span class="n">exact_overlap</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">near_duplicates</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="3">陷阱 3：忽视置信区间</h3>
<p><strong>问题描述</strong>：
只报告点估计，不计算置信区间，导致无法判断结果的可靠性。</p>
<p><strong>正确做法</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Bootstrap 置信区间</span>
<span class="k">def</span> <span class="nf">calculate_confidence_interval</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">n_bootstrap</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">bootstrap_means</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bootstrap</span><span class="p">):</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">bootstrap_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sample</span><span class="p">))</span>

    <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bootstrap_means</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
    <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bootstrap_means</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">),</span>
        <span class="s1">&#39;ci_95&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">),</span>
        <span class="s1">&#39;std_error&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">bootstrap_means</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># 报告格式</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">calculate_confidence_interval</span><span class="p">(</span><span class="n">model_scores</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;准确率: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (95% CI: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;ci_95&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;ci_95&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="4ab">陷阱 4：A/B 测试过早停止</h3>
<p><strong>问题描述</strong>：
看到初期的正向结果就急于全量发布，忽略了统计功效不足的问题。</p>
<p><strong>后果</strong>：</p>
<ul>
<li>假阳性：实际无效果但判断为有效</li>
<li>错过负面影响：初期未显现的问题</li>
<li>决策不稳定：结果可能反转</li>
</ul>
<p><strong>解决方案</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 设置合理的停止标准</span>
<span class="k">class</span> <span class="nc">ABTestStoppingCriteria</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_sample_size</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_test_days</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required_power</span> <span class="o">=</span> <span class="mf">0.8</span>

    <span class="k">def</span> <span class="nf">should_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_stats</span><span class="p">):</span>
        <span class="c1"># 检查多个条件</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;sample_size&#39;</span><span class="p">:</span> <span class="n">test_stats</span><span class="o">.</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_sample_size</span><span class="p">,</span>
            <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">test_stats</span><span class="o">.</span><span class="n">days</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_test_days</span><span class="p">,</span>
            <span class="s1">&#39;statistical_power&#39;</span><span class="p">:</span> <span class="n">test_stats</span><span class="o">.</span><span class="n">power</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_power</span><span class="p">,</span>
            <span class="s1">&#39;significance&#39;</span><span class="p">:</span> <span class="n">test_stats</span><span class="o">.</span><span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span>
        <span class="p">}</span>

        <span class="c1"># 只有所有条件满足才能停止</span>
        <span class="n">can_stop</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">conditions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">can_stop</span><span class="p">,</span> <span class="n">conditions</span>
</code></pre></div>

<h3 id="5">陷阱 5：人工评估标准不一致</h3>
<p><strong>问题描述</strong>：
不同标注者理解不同，或同一标注者在不同时间标准发生漂移。</p>
<p><strong>表现</strong>：</p>
<ul>
<li>Kappa 系数低于 0.4</li>
<li>相同样本重复标注结果不一致</li>
<li>标注质量随时间下降</li>
</ul>
<p><strong>预防措施</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AnnotationQualityController</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gold_standards</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 黄金标准样本</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotator_history</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">insert_quality_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_batch</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;插入质量检查样本&quot;&quot;&quot;</span>
        <span class="c1"># 每 10 个任务插入 1 个黄金标准</span>
        <span class="n">mixed_batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">task_batch</span><span class="p">):</span>
            <span class="n">mixed_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">gold</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gold_standards</span><span class="p">)</span>
                <span class="n">mixed_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gold</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mixed_batch</span>

    <span class="k">def</span> <span class="nf">monitor_annotator_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">annotator_id</span><span class="p">,</span> <span class="n">annotations</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;监控标注者质量&quot;&quot;&quot;</span>
        <span class="n">gold_performance</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ann</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ann</span><span class="o">.</span><span class="n">is_gold_standard</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_agreement</span><span class="p">(</span><span class="n">ann</span><span class="p">,</span> <span class="n">ann</span><span class="o">.</span><span class="n">gold_answer</span><span class="p">)</span>
                <span class="n">gold_performance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">annotator_history</span><span class="p">[</span><span class="n">annotator_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                    <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span>
                <span class="p">})</span>

        <span class="c1"># 检测质量下降</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gold_performance</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">recent_quality</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gold_performance</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">recent_quality</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alert</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;标注者 </span><span class="si">{</span><span class="n">annotator_id</span><span class="si">}</span><span class="s2"> 质量下降到 </span><span class="si">{</span><span class="n">recent_quality</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trigger_retraining</span><span class="p">(</span><span class="n">annotator_id</span><span class="p">)</span>
</code></pre></div>

<h3 id="6">陷阱 6：忽略边界条件</h3>
<p><strong>问题描述</strong>：
只在常规输入上评估，忽略边界和异常情况。</p>
<p><strong>容易忽略的边界条件</strong>：</p>
<ul>
<li>空输入 / 纯白图像</li>
<li>极长文本输入</li>
<li>特殊字符和表情符号</li>
<li>低质量 / 模糊图像</li>
<li>极端宽高比的图像</li>
</ul>
<p><strong>全面测试</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">create_edge_case_tests</span><span class="p">():</span>
    <span class="n">edge_cases</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;空图像&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span>
            <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="s1">&#39;描述这张图片&#39;</span><span class="p">,</span>
            <span class="s1">&#39;expected_behavior&#39;</span><span class="p">:</span> <span class="s1">&#39;合理处理，不崩溃&#39;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;超长输入&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">normal_image</span><span class="p">,</span>
            <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span>
            <span class="s1">&#39;expected_behavior&#39;</span><span class="p">:</span> <span class="s1">&#39;截断或拒绝，不OOM&#39;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;特殊字符&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">normal_image</span><span class="p">,</span>
            <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="s1">&#39;���这是什么？🤔&#39;</span><span class="p">,</span>
            <span class="s1">&#39;expected_behavior&#39;</span><span class="p">:</span> <span class="s1">&#39;正确解析，不报错&#39;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;极端宽高比&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
            <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="s1">&#39;这是什么形状？&#39;</span><span class="p">,</span>
            <span class="s1">&#39;expected_behavior&#39;</span><span class="p">:</span> <span class="s1">&#39;正确处理或优雅拒绝&#39;</span>
        <span class="p">}</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">edge_cases</span>
</code></pre></div>

<h2 id="710">7.10 最佳实践检查清单</h2>
<h3 id="_3">评估设计阶段</h3>
<ul>
<li>[ ] <strong>明确评估目标</strong></li>
<li>[ ] 定义成功标准</li>
<li>[ ] 确定关键指标</li>
<li>
<p>[ ] 设置决策阈值</p>
</li>
<li>
<p>[ ] <strong>选择评估方法</strong></p>
</li>
<li>[ ] 选择 3-5 个互补的基准测试</li>
<li>[ ] 设计任务特定的评估</li>
<li>
<p>[ ] 规划人工评估比例</p>
</li>
<li>
<p>[ ] <strong>数据质量保证</strong></p>
</li>
<li>[ ] 检查测试集代表性</li>
<li>[ ] 验证无数据泄露</li>
<li>[ ] 准备边界条件测试</li>
</ul>
<h3 id="_4">评估执行阶段</h3>
<ul>
<li>[ ] <strong>自动评估</strong></li>
<li>[ ] 运行基准测试</li>
<li>[ ] 计算多维度指标</li>
<li>
<p>[ ] 生成置信区间</p>
</li>
<li>
<p>[ ] <strong>人工评估</strong></p>
</li>
<li>[ ] 制定清晰的标注指南</li>
<li>[ ] 培训标注者</li>
<li>[ ] 插入质量检查点</li>
<li>
<p>[ ] 计算一致性指标</p>
</li>
<li>
<p>[ ] <strong>在线评估</strong></p>
</li>
<li>[ ] 设置护栏指标</li>
<li>[ ] 实施渐进式发布</li>
<li>[ ] 监控实时指标</li>
<li>[ ] 准备回滚方案</li>
</ul>
<h3 id="_5">分析与决策阶段</h3>
<ul>
<li>[ ] <strong>结果分析</strong></li>
<li>[ ] 进行统计显著性检验</li>
<li>[ ] 分析失败案例</li>
<li>[ ] 识别性能瓶颈</li>
<li>
<p>[ ] 检查偏见和公平性</p>
</li>
<li>
<p>[ ] <strong>报告生成</strong></p>
</li>
<li>[ ] 汇总关键发现</li>
<li>[ ] 可视化结果</li>
<li>[ ] 提供改进建议</li>
<li>
<p>[ ] 记录已知限制</p>
</li>
<li>
<p>[ ] <strong>决策支持</strong></p>
</li>
<li>[ ] 对比基线模型</li>
<li>[ ] 评估风险收益</li>
<li>[ ] 制定发布计划</li>
<li>[ ] 设置监控预警</li>
</ul>
<h3 id="_6">持续改进</h3>
<ul>
<li>[ ] <strong>评估体系优化</strong></li>
<li>[ ] 收集评估反馈</li>
<li>[ ] 更新测试集</li>
<li>[ ] 优化评估效率</li>
<li>
<p>[ ] 降低评估成本</p>
</li>
<li>
<p>[ ] <strong>知识积累</strong></p>
</li>
<li>[ ] 记录经验教训</li>
<li>[ ] 维护评估知识库</li>
<li>[ ] 分享最佳实践</li>
<li>[ ] 培训团队成员</li>
</ul>
<h3 id="_7">🚨 红线标准</h3>
<p><strong>绝对不能妥协的标准：</strong></p>
<ol>
<li><strong>数据泄露零容忍</strong>：发现任何泄露立即停止评估</li>
<li><strong>统计显著性要求</strong>：p &lt; 0.05 且功效 &gt; 0.8</li>
<li><strong>安全性优先</strong>：任何安全指标退化都不能发布</li>
<li><strong>用户体验保护</strong>：核心体验指标不能退化超过 1%</li>
<li><strong>公平性保证</strong>：不同群体性能差距 &lt; 10%</li>
</ol>
            </article>
            
            <nav class="page-nav"><a href="chapter6.html" class="nav-link prev">← 第 6 章：直接偏好优化（DPO）</a><a href="chapter8.html" class="nav-link next">第 8 章：模型部署与服务化 →</a></nav>
        </main>
    </div>
</body>
</html>